<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DailyReport (Online)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .nav-item-active { border-bottom: 3px solid #3b82f6; color: #ffffff; background-color: rgba(255,255,255,0.1); }
        .nav-item { color: #d1d5db; transition: all 0.3s; }
        .nav-item:hover { color: #ffffff; background-color: rgba(255,255,255,0.05); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        
        .attendance-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; accent-color: #2563eb; }
        
        /* Dropdown Multi-Select Custom */
        .dropdown-content { display: none; }
        .dropdown-content.show { display: block; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; bg-white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.98); transition: opacity 0.5s ease; }
        .hidden-fade { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="text-gray-800 flex flex-col h-screen overflow-hidden">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <i id="loading-icon" class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="font-bold text-gray-600 text-lg mb-2">Menghubungkan ke Database...</p>
        <div id="loading-logs" class="text-xs text-gray-400 font-mono text-center max-w-md p-2 bg-gray-50 rounded border border-gray-200">
            Memuat konfigurasi...
        </div>
        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm hidden shadow" id="btn-reload">Muat Ulang Halaman</button>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">DAILY REPORT</h1>
                <p class="text-gray-500 text-sm">Dashboard Monitoring System</p>
            </div>

            <div class="flex mb-6 bg-gray-100 rounded p-1">
                <button onclick="window.switchLoginTab('user')" id="tab-user" class="flex-1 py-2 rounded shadow bg-white text-blue-600 font-semibold text-sm transition">User (LEADER)</button>
                <button onclick="window.switchLoginTab('admin')" id="tab-admin" class="flex-1 py-2 rounded text-gray-500 font-semibold text-sm transition">Admin</button>
            </div>

            <form id="form-login-user">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ID User</label>
                    <input type="text" id="login-id" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan ID User" required>
                </div>
                <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="is-pic-checkbox" class="mr-2" onchange="window.togglePasswordField()">
                        <label for="is-pic-checkbox" class="text-sm text-gray-600 cursor-pointer">Saya adalah LEADER (Input Password)</label>
                    </div>
                    <input type="password" id="login-pass-user" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 hidden" placeholder="Kata Sandi">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition font-bold">Masuk</button>
            </form>

            <form id="form-login-admin" class="hidden">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password Admin</label>
                    <input type="password" id="login-pass-admin" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Masukkan Password Admin" required>
                </div>
                <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-900 transition font-bold">Masuk Admin</button>
            </form>
        </div>
    </div>

    <!-- APP NAVBAR -->
    <nav id="app-navbar" class="bg-gray-900 text-white shadow-md z-30 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-500 text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight">DAILY REPORT</span>
                </div>
                
                <!-- Menu Items -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" onclick="window.navigate('dashboard')" id="nav-dashboard" class="nav-item-active px-3 py-2 rounded-md text-sm font-medium"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a>
                        <a href="#" onclick="window.navigate('laporan')" id="nav-laporan" class="nav-item px-3 py-2 rounded-md text-sm font-medium"><i class="fas fa-file-alt mr-2"></i>Laporan</a>
                        <a href="#" onclick="window.navigate('pengaturan')" id="nav-pengaturan" class="nav-item px-3 py-2 rounded-md text-sm font-medium hidden"><i class="fas fa-cogs mr-2"></i>Pengaturan</a>
                    </div>
                </div>

                <!-- User Profile & Logout -->
                <div class="flex items-center">
                    <div class="text-right mr-4 hidden sm:block">
                        <div class="text-sm font-bold" id="user-name-display">User</div>
                        <div class="text-xs text-gray-400 bg-gray-800 px-2 rounded inline-block" id="user-badge">Role</div>
                    </div>
                    <button onclick="window.logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition shadow">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT AREA -->
    <main id="app-content" class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 hidden relative">
        
        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-content fade-in max-w-7xl mx-auto">
            <!-- Filter Section -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200">
                <div class="flex justify-between items-center border-b pb-2 mb-3">
                    <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-filter mr-2 text-blue-600"></i>Filter Data</h3>
                    <button onclick="window.resetDashboardFilters()" class="text-xs text-red-500 hover:text-red-700 font-semibold border border-red-200 px-2 py-1 rounded hover:bg-red-50 transition"><i class="fas fa-sync-alt mr-1"></i> Reset Filter</button>
                </div>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Mulai Tanggal</label>
                        <input type="date" id="dash-start-date" class="border p-2 rounded text-sm w-40 shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="window.loadDashboardData()">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Sampai Tanggal</label>
                        <input type="date" id="dash-end-date" class="border p-2 rounded text-sm w-40 shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="window.loadDashboardData()">
                    </div>
                    
                    <!-- CUSTOM DROPDOWN MULTI-SELECT -->
                    <div class="relative w-64">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Pilih HUB (Multi-Select)</label>
                        <button id="hub-filter-btn" class="w-full border p-2 rounded text-sm bg-white text-left flex justify-between items-center shadow-sm hover:bg-gray-50" onclick="window.toggleHubDropdown()">
                            <span id="hub-filter-label" class="truncate">Semua HUB</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        <div id="hub-filter-dropdown" class="dropdown-content absolute hidden w-full bg-white border rounded shadow-xl z-50 max-h-60 overflow-y-auto mt-1 p-2">
                            <!-- Checkboxes populated via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Area -->
            <div class="flex flex-col gap-6 mb-8">
                <div class="bg-white p-5 rounded-lg shadow border border-gray-200 w-full">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase border-l-4 border-blue-500 pl-2">Trend Tahunan</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="chart-annual"></canvas>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-lg shadow border border-gray-200 w-full">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase border-l-4 border-green-500 pl-2">Trend Daily</h4>
                    <div class="relative h-72 w-full">
                        <canvas id="chart-daily"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tables Area -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="lg:col-span-2 bg-white rounded-lg shadow overflow-hidden border border-gray-200 flex flex-col">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">Rincian Data per Tanggal</h3>
                        <button onclick="window.exportTableToCSV('table-daily-detail', 'rincian_harian.csv')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition"><i class="fas fa-download mr-1"></i> CSV</button>
                    </div>
                    <div class="overflow-x-auto flex-1 max-h-96">
                        <table id="table-daily-detail" class="w-full text-sm text-center whitespace-nowrap">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 text-left">Tanggal</th>
                                    <th class="px-3 py-3">HUB</th>
                                    <th class="px-3 py-3 text-blue-700">MPP</th>
                                    <th class="px-3 py-3">Staging</th>
                                    <th class="px-3 py-3">Gateway</th>
                                    <th class="px-3 py-3">JNE</th>
                                    <th class="px-3 py-3">SAP</th>
                                    <th class="px-3 py-3 font-bold bg-gray-200">Total</th>
                                    <th class="px-3 py-3 text-green-700">Prod.</th>
                                    <th class="px-3 py-3 text-right text-red-600">Cost</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-daily-detail" class="text-gray-600 divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-white rounded-lg shadow overflow-hidden border border-gray-200 flex flex-col h-fit">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 class="font-bold text-gray-800">Performa HUB</h3>
                        <p class="text-[10px] text-gray-500">Urut: Total Outbound Tertinggi</p>
                    </div>
                    <div class="overflow-x-auto flex-1 max-h-96">
                        <table class="w-full text-sm text-center">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-3 text-left">HUB</th>
                                    <th class="px-3 py-3 font-bold bg-gray-200">Outbound</th>
                                    <th class="px-3 py-3 text-right text-red-600">Cost</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-hub-breakdown" class="text-gray-600 divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <!-- VIEW: LAPORAN -->
        <div id="view-laporan" class="view-content hidden fade-in max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Laporan Harian</h2>
                <button onclick="window.openLaporanModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 hidden transition" id="btn-tambah-laporan"><i class="fas fa-plus mr-2"></i> Buat Laporan</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-x-auto border border-gray-200">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">Tanggal</th>
                            <th class="px-6 py-3">HUB</th>
                            <th class="px-6 py-3">Total Paket</th>
                            <th class="px-6 py-3">MPP</th>
                            <th class="px-6 py-3">Productivity</th>
                            <th class="px-6 py-3 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="laporan-list-body"></tbody>
                </table>
            </div>
            <div id="empty-laporan-msg" class="hidden text-center py-20 text-gray-400 bg-white rounded-lg border border-dashed mt-4">
                <i class="fas fa-folder-open text-4xl mb-2 text-gray-300"></i>
                <p>Belum ada laporan yang dibuat.</p>
            </div>
        </div>

        <!-- VIEW: PENGATURAN -->
        <div id="view-pengaturan" class="view-content hidden fade-in max-w-5xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Pengaturan</h2>
            <div class="mb-6 border-b border-gray-200">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                    <li class="mr-2"><button onclick="window.switchSettingsTab('users')" id="set-tab-users" class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 active hover:bg-gray-50 rounded-t-lg transition">Manajemen User</button></li>
                    <li class="mr-2"><button onclick="window.switchSettingsTab('general')" id="set-tab-general" class="inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg transition">Akses & Admin</button></li>
                    <li class="mr-2"><button onclick="window.switchSettingsTab('cost')" id="set-tab-cost" class="inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg transition">Cost Mitra</button></li>
                </ul>
            </div>
            
            <!-- Panel User -->
            <div id="settings-users" class="settings-panel">
                <div class="flex justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Daftar Pengguna</h3>
                    <button onclick="window.openUserModal()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm shadow transition"><i class="fas fa-user-plus mr-1"></i> Tambah User</button>
                </div>
                <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3">Nama</th>
                                <th class="px-6 py-3">ID</th>
                                <th class="px-6 py-3">HUB</th>
                                <th class="px-6 py-3">Posisi</th>
                                <th class="px-6 py-3 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Panel General -->
            <div id="settings-general" class="settings-panel hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded shadow border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-key mr-2"></i>Password Admin</h3>
                        <div class="mb-4">
                            <label class="block text-sm mb-1 font-semibold text-gray-600">Password Baru</label>
                            <input type="password" id="new-admin-pass" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <button onclick="window.saveAdminPass()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition w-full">Update Password</button>
                    </div>
                    <div class="bg-white p-6 rounded shadow border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-lock mr-2"></i>Kode Akses Leader</h3>
                        <p class="text-xs text-gray-500 mb-3">Digunakan Leader untuk edit/hapus data.</p>
                        <div class="mb-4">
                            <label class="block text-sm mb-1 font-semibold text-gray-600">Kode Baru</label>
                            <input type="text" id="access-code-input" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none transition">
                        </div>
                        <button onclick="window.saveAccessCode()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700 transition w-full">Simpan Kode</button>
                    </div>
                </div>
            </div>
            
            <!-- Panel Cost -->
            <div id="settings-cost" class="settings-panel hidden">
                <div class="bg-white p-6 rounded shadow max-w-2xl border border-gray-200">
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i class="fas fa-coins mr-2 text-yellow-600"></i>Biaya DW (Global)</h3>
                        <input type="text" id="global-cost-dw" placeholder="Rp" class="border p-2 rounded w-full text-right font-mono" onkeyup="window.formatCostInput(this)">
                    </div>
                    
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-100 rounded-lg">
                        <h4 class="font-bold text-sm text-blue-800 mb-3 uppercase flex items-center"><i class="fas fa-plus-circle mr-2"></i>Tambah HUB Baru</h4>
                        <div class="flex gap-2">
                            <input type="text" id="new-hub-name" placeholder="Kode HUB (mis: JKT-01)" class="border p-2 rounded w-full text-sm focus:border-blue-500 outline-none">
                            <input type="text" id="new-hub-cost" placeholder="Biaya (Rp)" class="border p-2 rounded w-full text-sm text-right font-mono focus:border-blue-500 outline-none" onkeyup="window.formatCostInput(this)">
                            <button onclick="window.addHubToTable()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 font-bold whitespace-nowrap shadow">Tambah</button>
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Daftar Biaya HUB (Sorter)</h3>
                    <div id="cost-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                    
                    <div class="mt-6 pt-4 border-t">
                        <button onclick="window.saveCosts()" class="bg-green-600 text-white px-6 py-3 rounded w-full font-bold shadow-lg hover:bg-green-700 transition transform hover:-translate-y-0.5">SIMPAN KONFIGURASI</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <!-- USER MODAL (RESTRUCTURED) -->
    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">User</h3>
                <button onclick="window.closeUserModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="user-form">
                <input type="hidden" id="edit-user-id">
                <div class="space-y-4">
                    
                    <!-- 1. Nama -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Nama Lengkap</label>
                        <input type="text" id="input-nama" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>

                    <!-- 2. HUB -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Kode HUB</label>
                        <select id="input-kode-hub" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></select>
                    </div>

                    <!-- 3. Posisi -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Posisi</label>
                        <select id="input-posisi" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" onchange="window.toggleUserModalPassword()">
                            <option value="Sorter">Sorter</option>
                            <option value="DW">DW</option>
                            <option value="LEADER">LEADER</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>

                    <!-- 4. ID & Password (Dynamic Grid) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2" id="id-container">
                            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">ID User</label>
                            <input type="text" id="input-id" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                        </div>
                        <div class="hidden col-span-1" id="password-container">
                            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Kata Sandi</label>
                            <input type="text" id="input-sandi" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- 5. Akses Toggle -->
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded border">
                        <span class="text-sm font-bold text-gray-700">Akses Edit Laporan</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="input-akses-toggle" class="sr-only peer" onchange="document.getElementById('akses-label').innerText = this.checked ? 'YA' : 'TIDAK'">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 w-10 text-right" id="akses-label">TIDAK</span>
                        </label>
                    </div>

                </div>
                <div class="mt-6 flex justify-end gap-2 border-t pt-4">
                    <button type="button" onclick="window.closeUserModal()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100 transition">Batal</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LAPORAN MODAL -->
    <div id="laporan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg w-full max-w-4xl shadow-2xl my-10 flex flex-col max-h-screen">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-lg">
                <h3 class="text-xl font-bold text-gray-800" id="laporan-modal-title">Laporan</h3>
                <button onclick="window.closeLaporanModal()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto bg-gray-50">
                <form id="laporan-form">
                    <input type="hidden" id="edit-laporan-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-white p-4 rounded shadow-sm border border-gray-200">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Tanggal</label>
                            <input type="date" id="lap-tanggal" class="w-full border p-2 rounded font-semibold" required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">HUB</label>
                            <select id="lap-hub-select" class="w-full border p-2 rounded hidden font-semibold" onchange="window.loadHubUsersForAttendance()"></select>
                            <input type="text" id="lap-hub-text" class="w-full border p-2 rounded bg-gray-100 text-gray-600 hidden font-semibold" readonly>
                        </div>
                    </div>

                    <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">Metrix Paket (Input)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div><label class="text-xs text-gray-500">Gateway</label><input type="text" id="lap-gateway" class="w-full border p-2 rounded font-mono text-right" placeholder="0" onkeyup="window.calcMetrics(this)"></div>
                        <div><label class="text-xs text-gray-500">Staging</label><input type="text" id="lap-staging" class="w-full border p-2 rounded font-mono text-right" placeholder="0" onkeyup="window.calcMetrics(this)"></div>
                        <div><label class="text-xs text-gray-500">JNE</label><input type="text" id="lap-jne" class="w-full border p-2 rounded font-mono text-right" placeholder="0" onkeyup="window.calcMetrics(this)"></div>
                        <div><label class="text-xs text-gray-500">SAP</label><input type="text" id="lap-sap" class="w-full border p-2 rounded font-mono text-right" placeholder="0" onkeyup="window.calcMetrics(this)"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded border border-blue-200 shadow-inner">
                        <div class="text-center border-r border-blue-200">
                            <p class="text-xs text-blue-500 uppercase font-bold">Total Paket</p>
                            <p class="text-3xl font-bold text-blue-700" id="disp-total-paket">0</p>
                            <input type="hidden" id="val-total-paket">
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-green-600 uppercase font-bold">Productivity</p>
                            <p class="text-3xl font-bold text-green-700" id="disp-productivity">0</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-2 border-b pb-1">
                        <h4 class="font-bold text-gray-700">Absensi Tim</h4>
                        <div class="text-right">
                            <span class="text-xs text-gray-500">Total MPP (Sorter/DW):</span>
                            <span class="font-bold text-lg text-gray-800 ml-1 bg-yellow-100 px-2 rounded" id="disp-total-mpp">0</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto border rounded mb-4 bg-white shadow-sm">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-100 text-xs uppercase font-bold text-gray-600">
                                <tr>
                                    <th class="p-2 text-left w-1/3">Nama</th>
                                    <th class="p-2 w-8">1</th><th class="p-2 w-8">2</th><th class="p-2 w-8">3</th>
                                    <th class="p-2 w-8 text-yellow-600">I</th><th class="p-2 w-8 text-blue-600">S</th><th class="p-2 w-8 text-red-600">A</th>
                                    <th class="p-2 text-left">Ket</th><th class="p-2 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="attendance-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                    
                    <button type="button" onclick="window.addManualDWRow()" class="text-sm bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded w-full border-2 border-dashed border-gray-300 hover:border-gray-400 mb-6 transition"><i class="fas fa-plus-circle mr-2 text-green-500"></i> Tambah DW Manual</button>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t sticky bottom-0 bg-gray-50">
                        <button type="button" onclick="window.closeLaporanModal()" class="px-5 py-2 border rounded text-gray-600 hover:bg-gray-200 transition bg-white">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow-lg transform transition active:scale-95">SIMPAN LAPORAN</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODULE SCRIPT (Firebase) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, deleteDoc, updateDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // KONFIGURASI DARI USER
        const firebaseConfig = {
            apiKey: "AIzaSyDXOfZbVDqtfGB0abQkTeILo-XC6a9xxKI",
            authDomain: "hub-dashboard-92428.firebaseapp.com",
            projectId: "hub-dashboard-92428",
            storageBucket: "hub-dashboard-92428.firebasestorage.app",
            messagingSenderId: "827243064075",
            appId: "1:827243064075:web:21b8e40b88f13b2433d00e"
        };

        const storageId = 'hub-data-v1';
        let app, auth, db;
        let unsubscribeUsers, unsubscribeCosts, unsubscribeLaporan, unsubscribeSettings;

        // Global State
        let appData = {
            adminPass: '123456',
            accessCode: 'SUPERHUB',
            costDW: 120000,
            users: [],
            costs: [],
            laporan: []
        };
        let currentUser = null;
        let annualChart = null, dailyChart = null;

        // --- ERROR HANDLING & INIT ---
        function updateLoadingLog(msg, isError = false) {
            const el = document.getElementById('loading-logs');
            if (el) {
                el.innerHTML = msg;
                if (isError) {
                    el.classList.add('text-red-500'); el.classList.remove('text-gray-400');
                    const icon = document.getElementById('loading-icon');
                    icon.classList.remove('fa-circle-notch', 'fa-spin', 'text-blue-600');
                    icon.classList.add('fa-exclamation-triangle', 'text-red-600');
                    document.getElementById('btn-reload').classList.remove('hidden');
                }
            }
        }

        function handleAuthSuccess(user) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay.classList.contains('hidden-fade')) {
                updateLoadingLog("Koneksi Berhasil! Memuat Data...");
                setTimeout(() => {
                    overlay.classList.add('hidden-fade');
                    setTimeout(() => overlay.classList.add('hidden'), 500);
                    document.getElementById('login-section').classList.remove('hidden');
                }, 800);
                initListeners();
            }
        }

        window.onerror = function(message, source, lineno, colno, error) {
            updateLoadingLog(`System Error: ${message}`, true);
        };

        try {
            updateLoadingLog("Menginisialisasi Firebase...");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            updateLoadingLog("Menghubungkan ke Authentication...");
            onAuthStateChanged(auth, (user) => { if (user) handleAuthSuccess(user); });
            signInAnonymously(auth).then((result) => {
                updateLoadingLog("Login Anonim Berhasil...");
                if (result.user) handleAuthSuccess(result.user);
            }).catch((error) => {
                console.error("Auth Error:", error);
                updateLoadingLog("Gagal Login Anonim. Cek koneksi internet.", true);
            });

        } catch (e) {
            console.error(e);
            updateLoadingLog(`Config Error: ${e.message}`, true);
        }

        // --- DATABASE LISTENERS ---
        function initListeners() {
            const publicPath = (col) => collection(db, 'artifacts', storageId, 'public', 'data', col);

            unsubscribeSettings = onSnapshot(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    appData.adminPass = d.adminPass || '123456';
                    appData.accessCode = d.accessCode || 'SUPERHUB';
                    appData.costDW = d.costDW || 120000;
                } else {
                    setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { adminPass: '123456', accessCode: 'SUPERHUB', costDW: 120000 });
                }
            });

            unsubscribeUsers = onSnapshot(publicPath('users'), (s) => { appData.users = []; s.forEach(d => appData.users.push(d.data())); if(!document.getElementById('view-pengaturan').classList.contains('hidden')) window.renderUserTable(); });
            unsubscribeCosts = onSnapshot(publicPath('costs'), (s) => { 
                appData.costs = []; 
                s.forEach(d => appData.costs.push(d.data())); 
                window.renderHubDropdownOptions();
                if(!document.getElementById('view-pengaturan').classList.contains('hidden')) window.renderCostInputs(); 
            });
            unsubscribeLaporan = onSnapshot(publicPath('laporan'), (s) => { appData.laporan = []; s.forEach(d => appData.laporan.push(d.data())); if(!document.getElementById('view-dashboard').classList.contains('hidden')) window.loadDashboardData(); if(!document.getElementById('view-laporan').classList.contains('hidden')) window.renderLaporanList(); });
        }

        window.Chart.register(ChartDataLabels);

        // --- HELPERS ---
        const safeId = (id) => id ? id.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
        window.formatNumber = (num) => (!num && num !== 0) ? '' : num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        window.parseFormattedNumber = (str) => { if (!str) return 0; const cleanStr = str.toString().replace(/[^0-9]/g, ''); return parseInt(cleanStr, 10) || 0; };
        window.formatCostInput = (e) => { let val = e.value.replace(/\./g, '').replace(/[^0-9]/g, ''); e.value = window.formatNumber(val); };
        window.formatRupiah = (n) => { if(n == null) return ''; let s = n.toString().replace(/[^,\d]/g, ''), spl = s.split(','), rem = spl[0].length % 3, r = spl[0].substr(0, rem), th = spl[0].substr(rem).match(/\d{3}/gi); if(th) { let sep = rem ? '.' : ''; r += sep + th.join('.'); } return 'Rp. ' + r; };

        // --- UI LOGIC ---
        window.switchLoginTab = (type) => {
            const u = document.getElementById('form-login-user'), a = document.getElementById('form-login-admin'), tu = document.getElementById('tab-user'), ta = document.getElementById('tab-admin');
            if(type === 'user') { u.classList.remove('hidden'); a.classList.add('hidden'); tu.classList.add('bg-white','text-blue-600','shadow'); tu.classList.remove('text-gray-500'); ta.classList.remove('bg-white','text-blue-600','shadow'); ta.classList.add('text-gray-500'); }
            else { u.classList.add('hidden'); a.classList.remove('hidden'); ta.classList.add('bg-white','text-blue-600','shadow'); ta.classList.remove('text-gray-500'); tu.classList.remove('bg-white','text-blue-600','shadow'); tu.classList.add('text-gray-500'); }
        };
        window.togglePasswordField = () => { const c = document.getElementById('is-pic-checkbox'), p = document.getElementById('login-pass-user'); if(c.checked) { p.classList.remove('hidden'); p.setAttribute('required', 'true'); } else { p.classList.add('hidden'); p.removeAttribute('required'); p.value=''; } };

        document.getElementById('form-login-admin').addEventListener('submit', (e) => { e.preventDefault(); if(document.getElementById('login-pass-admin').value === appData.adminPass) { currentUser = { role: 'admin', name: 'Administrator', id: 'admin', kode_hub: 'ALL' }; window.enterApp(); } else Swal.fire('Error', 'Password Admin Salah!', 'error'); });
        document.getElementById('form-login-user').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('login-id').value, isPic = document.getElementById('is-pic-checkbox').checked, pass = document.getElementById('login-pass-user').value, u = appData.users.find(u => u.id === id); if (!u) return Swal.fire('Error', 'ID User tidak ditemukan.', 'error'); if (isPic) { if (u.sandi === pass) { currentUser = { role: 'pic', name: u.nama, id: u.id, akses_laporan: u.akses, kode_hub: u.kode_hub }; window.enterApp(); } else Swal.fire('Error', 'Password Salah!', 'error'); } else { if (u.posisi === 'LEADER' || u.posisi === 'Admin') return Swal.fire('Warning', 'Gunakan login LEADER.', 'warning'); currentUser = { role: 'sorter', name: u.nama, id: u.id, akses_laporan: 'TIDAK', kode_hub: u.kode_hub }; window.enterApp(); } });

        window.enterApp = () => {
            document.getElementById('login-section').classList.add('hidden'); document.getElementById('app-content').classList.remove('hidden'); document.getElementById('app-navbar').classList.remove('hidden'); document.getElementById('app-navbar').classList.add('block');
            document.getElementById('user-name-display').innerText = currentUser.name; document.getElementById('user-badge').innerText = currentUser.role.toUpperCase();
            const ns = document.getElementById('nav-pengaturan'), bt = document.getElementById('btn-tambah-laporan');
            if (currentUser.role === 'admin') { ns.classList.remove('hidden'); bt.classList.remove('hidden'); } else if (currentUser.role === 'pic' && currentUser.akses_laporan === 'YA') { ns.classList.add('hidden'); bt.classList.remove('hidden'); } else { ns.classList.add('hidden'); bt.classList.add('hidden'); }
            window.initDashboardFilters(); window.navigate('dashboard');
        };
        window.logout = () => location.reload();

        window.navigate = (viewId) => {
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.nav-item, .nav-item-active').forEach(el => { el.classList.remove('nav-item-active'); el.classList.add('nav-item'); });
            document.getElementById(`view-${viewId}`).classList.remove('hidden'); document.getElementById(`nav-${viewId}`).classList.add('nav-item-active'); document.getElementById(`nav-${viewId}`).classList.remove('nav-item');
            if (viewId === 'dashboard') window.loadDashboardData(); if (viewId === 'pengaturan') window.loadSettingsUI(); if (viewId === 'laporan') window.renderLaporanList();
        };
        window.toggleSidebar = () => {}; 

        // -- DASHBOARD --
        window.toggleHubDropdown = () => document.getElementById('hub-filter-dropdown').classList.toggle('hidden');
        window.addEventListener('click', (e) => { if (!document.getElementById('hub-filter-btn').contains(e.target) && !document.getElementById('hub-filter-dropdown').contains(e.target)) document.getElementById('hub-filter-dropdown').classList.add('hidden'); });

        window.renderHubDropdownOptions = () => {
            const c = document.getElementById('hub-filter-dropdown'); if(!c) return; c.innerHTML = '';
            appData.costs.forEach(co => {
                const chk = (currentUser.role !== 'admin' && currentUser.kode_hub === co.hub) ? 'checked disabled' : 'checked';
                c.innerHTML += `<label class="flex items-center space-x-2 p-2 hover:bg-gray-50 cursor-pointer"><input type="checkbox" value="${co.hub}" class="hub-checkbox form-checkbox text-blue-600" ${chk} onchange="window.updateHubFilterLabel(); window.loadDashboardData()"><span class="text-sm text-gray-700">${co.hub}</span></label>`;
            });
            window.updateHubFilterLabel();
        };
        window.updateHubFilterLabel = () => {
            const chks = document.querySelectorAll('.hub-checkbox:checked'), lbl = document.getElementById('hub-filter-label');
            if (chks.length === 0) lbl.innerText = 'Pilih HUB'; else if (chks.length === appData.costs.length) lbl.innerText = 'Semua HUB'; else if (chks.length === 1) lbl.innerText = chks[0].value; else lbl.innerText = `${chks.length} HUB Dipilih`;
        };
        window.initDashboardFilters = () => { window.renderHubDropdownOptions(); window.resetDashboardFilters(); };
        window.resetDashboardFilters = () => {
            const e = new Date(), s = new Date(); s.setDate(e.getDate() - 30);
            document.getElementById('dash-end-date').valueAsDate = e; document.getElementById('dash-start-date').valueAsDate = s;
            if (currentUser.role === 'admin') { document.querySelectorAll('.hub-checkbox').forEach(c => c.checked = true); window.updateHubFilterLabel(); }
            window.loadDashboardData();
        };
        window.loadDashboardData = () => {
            const sStr = document.getElementById('dash-start-date').value, eStr = document.getElementById('dash-end-date').value, sHubs = Array.from(document.querySelectorAll('.hub-checkbox:checked')).map(cb => cb.value);
            if(!sStr || !eStr) return;
            const sDate = new Date(sStr), eDate = new Date(eStr);
            let f = appData.laporan.filter(l => { const d = new Date(l.tanggal); return d >= sDate && d <= eDate && (sHubs.length === 0 || sHubs.includes(l.hub)); });
            f.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            window.updateCharts(f, sHubs); window.updateDashboardTables(f);
        };

        window.getHubCostRate = (h) => { const c = appData.costs.find(x => x.hub === h); return c ? c.cost : 0; };
        window.calculateReportCost = (r) => {
            let t = 0; const hr = window.getHubCostRate(r.hub), dr = appData.costDW || 0;
            if (r.attendance_data) r.attendance_data.forEach(a => { if (a.s1 || a.s2 || a.s3) { let isD = a.userId.startsWith('manual_'); if (!isD) { const u = appData.users.find(x => x.id === a.userId); if (u && u.posisi === 'DW') isD = true; } t += isD ? dr : hr; } });
            else t = r.total_mpp * hr;
            return t;
        };

        window.updateCharts = (data, hubs) => {
            const cy = new Date().getFullYear(), mData = Array(12).fill(0).map(() => ({ pkg: 0, mpp: 0 }));
            let aSrc = appData.laporan.filter(l => new Date(l.tanggal).getFullYear() === cy);
            if (hubs.length > 0) aSrc = aSrc.filter(l => hubs.includes(l.hub));
            aSrc.forEach(l => { const m = new Date(l.tanggal).getMonth(); mData[m].pkg += l.total_paket; mData[m].mpp += l.total_mpp; });
            const dPM = mData.map(d => d.pkg), dPrM = mData.map(d => d.mpp > 0 ? Math.round(d.pkg / d.mpp) : 0);
            window.renderChart('chart-annual', ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'], dPM, dPrM, 'Total Paket', 'Prod.');

            const agg = {}; data.forEach(l => { if (!agg[l.tanggal]) agg[l.tanggal] = { pkg: 0, mpp: 0 }; agg[l.tanggal].pkg += l.total_paket; agg[l.tanggal].mpp += l.total_mpp; });
            const sD = Object.keys(agg).sort(), lbs = sD.map(dStr => { const d = new Date(dStr); return `${d.getDate()}/${d.getMonth()+1}`; }), dP = sD.map(d => agg[d].pkg), dPr = sD.map(d => agg[d].mpp > 0 ? Math.round(agg[d].pkg / agg[d].mpp) : 0);
            window.renderChart('chart-daily', lbs, dP, dPr, 'Total Paket', 'Prod.');
        };

        window.renderChart = (cid, lb, db, dl, lbb, lbl) => {
            const ctx = document.getElementById(cid).getContext('2d');
            if (cid === 'chart-annual') { if(annualChart) annualChart.destroy(); } if (cid === 'chart-daily') { if(dailyChart) dailyChart.destroy(); }
            const cfg = { type: 'bar', data: { labels: lb, datasets: [{ label: lbb, data: db, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, order: 2, datalabels: { align: 'end', anchor: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 11 }, formatter: v => v > 0 ? window.formatNumber(v) : '' } }, { label: lbl, data: dl, type: 'line', borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, tension: 0.2, order: 1, datalabels: { align: 'top', anchor: 'start', color: '#047857', font: { weight: 'bold', size: 11 }, offset: 4, formatter: v => v > 0 ? window.formatNumber(v) : '' } }] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 25 } }, plugins: { legend: { display: false }, tooltip: { enabled: true }, datalabels: { display: true } }, scales: { x: { grid: { display: false } }, y: { display: false }, y1: { display: false } } } };
            const c = new Chart(ctx, cfg); if (cid === 'chart-annual') annualChart = c; if (cid === 'chart-daily') dailyChart = c;
        };

        window.updateDashboardTables = (data) => {
            const tbd = document.getElementById('tbody-daily-detail'); tbd.innerHTML = '';
            data.forEach(l => { tbd.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-3 py-2 text-left whitespace-nowrap">${l.tanggal}</td><td class="px-3 py-2 font-semibold">${l.hub}</td><td class="px-3 py-2 text-blue-700 font-bold">${l.total_mpp}</td><td class="px-3 py-2">${window.formatNumber(l.staging)}</td><td class="px-3 py-2">${window.formatNumber(l.gateway)}</td><td class="px-3 py-2">${window.formatNumber(l.jne)}</td><td class="px-3 py-2">${window.formatNumber(l.sap)}</td><td class="px-3 py-2 font-bold bg-gray-50">${window.formatNumber(l.total_paket)}</td><td class="px-3 py-2 text-green-700 font-bold">${window.formatNumber(Math.round(l.productivity))}</td><td class="px-3 py-2 text-right text-red-600 text-xs">${window.formatRupiah(window.calculateReportCost(l))}</td></tr>`; });
            const tbh = document.getElementById('tbody-hub-breakdown'); tbh.innerHTML = ''; const hAg = {};
            data.forEach(l => { if(!hAg[l.hub]) hAg[l.hub] = { mpp: 0, out: 0, cost: 0 }; hAg[l.hub].mpp += l.total_mpp; hAg[l.hub].out += l.total_paket; hAg[l.hub].cost += window.calculateReportCost(l); });
            Object.keys(hAg).sort((a, b) => hAg[b].out - hAg[a].out).forEach(h => { const d = hAg[h]; tbh.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 text-left font-bold text-gray-800">${h}</td><td class="px-4 py-3 font-bold bg-gray-50 text-blue-800">${window.formatNumber(d.out)}</td><td class="px-4 py-3 text-right text-red-600 font-bold">${window.formatRupiah(d.cost)}</td></tr>`; });
        };
        window.exportTableToCSV = (id, fn) => { const t = document.getElementById(id); let c = []; t.querySelectorAll("tr").forEach(r => { let row = []; r.querySelectorAll("td, th").forEach(z => row.push(z.innerText)); c.push(row.join(",")); }); const b = new Blob([c.join("\n")], {type: "text/csv"}), a = document.createElement("a"); a.download = fn; a.href = window.URL.createObjectURL(b); a.style.display = "none"; document.body.appendChild(a); a.click(); };

        // -- SETTINGS & CRUD --
        window.switchSettingsTab = (tab) => { document.querySelectorAll('.settings-panel').forEach(e => e.classList.add('hidden')); document.getElementById(`settings-${tab}`).classList.remove('hidden'); ['users', 'general', 'cost'].forEach(t => { const b = document.getElementById(`set-tab-${t}`); t===tab ? (b.classList.add('text-blue-600','border-blue-600','active'),b.classList.remove('border-transparent')) : (b.classList.remove('text-blue-600','border-blue-600','active'),b.classList.add('border-transparent')); }); };
        window.loadSettingsUI = () => { window.renderUserTable(); document.getElementById('access-code-input').value = appData.accessCode; document.getElementById('global-cost-dw').value = window.formatNumber(appData.costDW); window.renderCostInputs(); };
        
        window.renderUserTable = () => {
            const tb = document.getElementById('user-table-body'); tb.innerHTML = '';
            appData.users.forEach((u) => { tb.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium">${u.nama}</td><td class="px-6 py-4">${u.id}</td><td class="px-6 py-4">${u.kode_hub}</td><td class="px-6 py-4">${u.posisi}</td><td class="px-6 py-4 text-right"><button onclick="window.editUserConfirm('${safeId(u.id)}')" class="text-blue-600 hover:underline mr-3"><i class="fas fa-edit"></i> Edit</button><button onclick="window.deleteUser('${safeId(u.id)}')" class="text-red-600 hover:underline"><i class="fas fa-trash"></i> Hapus</button></td></tr>`; });
        };
        window.editUserConfirm = (id) => Swal.fire({ title: 'Edit User?', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya' }).then((r) => { if (r.isConfirmed) window.openUserModal(id); });
        
        window.toggleUserModalPassword = () => {
            const pos = document.getElementById('input-posisi').value;
            const passCont = document.getElementById('password-container');
            const idCont = document.getElementById('id-container');
            
            if (pos === 'LEADER' || pos === 'Admin') {
                passCont.classList.remove('hidden');
                idCont.classList.remove('col-span-2'); 
                idCont.classList.add('col-span-1');
            } else {
                passCont.classList.add('hidden');
                idCont.classList.remove('col-span-1');
                idCont.classList.add('col-span-2');
                document.getElementById('input-sandi').value = '';
            }
        }

        window.openUserModal = (id=null) => {
            document.getElementById('user-modal').classList.remove('hidden'); const hS = document.getElementById('input-kode-hub'); hS.innerHTML = '<option value="">-- Pilih HUB --</option>'; appData.costs.forEach(c => { if(c.hub) hS.innerHTML += `<option value="${c.hub}">${c.hub}</option>`; });
            if (id) { 
                const u = appData.users.find(x => x.id === id); 
                document.getElementById('modal-title').innerText = 'Edit User'; 
                document.getElementById('edit-user-id').value = id; 
                document.getElementById('input-nama').value = u.nama; 
                document.getElementById('input-id').value = u.id; 
                document.getElementById('input-sandi').value = u.sandi || ''; 
                document.getElementById('input-kode-hub').value = u.kode_hub; 
                document.getElementById('input-posisi').value = u.posisi; 
                
                // Set toggle logic for access
                const toggle = document.getElementById('input-akses-toggle');
                toggle.checked = (u.akses === 'YA');
                document.getElementById('akses-label').innerText = u.akses;

                // Handle readonly & password display
                document.getElementById('input-id').readOnly = true; 
                document.getElementById('input-id').classList.add('bg-gray-100'); 
            } else { 
                document.getElementById('modal-title').innerText = 'Tambah User'; 
                document.getElementById('edit-user-id').value = ''; 
                document.getElementById('user-form').reset(); 
                document.getElementById('input-id').readOnly = false; 
                document.getElementById('input-id').classList.remove('bg-gray-100'); 
                document.getElementById('akses-label').innerText = 'TIDAK';
            }
            window.toggleUserModalPassword();
        };
        window.closeUserModal = () => document.getElementById('user-modal').classList.add('hidden');
        
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const eid = document.getElementById('edit-user-id').value;
            const aksesVal = document.getElementById('input-akses-toggle').checked ? 'YA' : 'TIDAK';
            const nu = { 
                nama: document.getElementById('input-nama').value, 
                id: document.getElementById('input-id').value, 
                sandi: document.getElementById('input-sandi').value, 
                kode_hub: document.getElementById('input-kode-hub').value, 
                posisi: document.getElementById('input-posisi').value, 
                akses: aksesVal
            };
            try { 
                if (!eid && appData.users.some(u => u.id === nu.id)) return Swal.fire('Error', 'ID User ada!', 'error'); 
                await setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'users', nu.id), nu); 
                window.closeUserModal(); 
                Swal.fire('Sukses', 'Data tersimpan', 'success'); 
            } catch (err) { Swal.fire('Error', 'Gagal simpan', 'error'); }
        });
        window.deleteUser = (id) => Swal.fire({title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'}).then(async (r) => { if(r.isConfirmed) { await deleteDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'users', id)); Swal.fire('Terhapus', '', 'success'); } });
        
        window.saveAdminPass = async () => { const p = document.getElementById('new-admin-pass').value; if(p.length<4) return Swal.fire('Error', 'Min 4 char', 'error'); await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { adminPass: p }); Swal.fire('Sukses', 'Pass Updated', 'success'); };
        window.saveAccessCode = async () => { const c = document.getElementById('access-code-input').value; if(!c) return; await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { accessCode: c }); Swal.fire('Sukses', 'Kode Updated', 'success'); };
        
        window.updateLocalCosts = () => { const r = document.getElementById('cost-container').children; appData.costs = []; for (let i = 0; i < r.length; i++) { const h = document.getElementById(`cost-hub-${i}`), c = document.getElementById(`cost-val-${i}`); if (h && c) appData.costs.push({ hub: h.value, cost: window.parseFormattedNumber(c.value) }); } };
        window.renderCostInputs = () => { const c = document.getElementById('cost-container'); c.innerHTML = ''; appData.costs.forEach((x, i) => { c.innerHTML += `<div class="flex gap-2 mb-2"><input type="text" placeholder="Kode HUB" value="${x.hub}" id="cost-hub-${i}" class="border p-2 rounded w-1/3"><input type="text" placeholder="Biaya" value="${window.formatRupiah(x.cost)}" id="cost-val-${i}" class="border p-2 rounded w-1/3 text-right" onkeyup="window.formatCostInput(this)"><button onclick="window.removeCostRow(${i})" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-trash"></i></button></div>`; }); };
        window.addHubToTable = () => { window.updateLocalCosts(); const n = document.getElementById('new-hub-name').value.toUpperCase(), c = window.parseFormattedNumber(document.getElementById('new-hub-cost').value); if(!n) return Swal.fire('Info', 'Lengkapi Data', 'warning'); appData.costs.push({ hub: n, cost: c }); window.renderCostInputs(); document.getElementById('new-hub-name').value = ''; document.getElementById('new-hub-cost').value = ''; };
        window.removeCostRow = (i) => { window.updateLocalCosts(); appData.costs.splice(i, 1); window.renderCostInputs(); };
        window.saveCosts = async () => { window.updateLocalCosts(); const dw = window.parseFormattedNumber(document.getElementById('global-cost-dw').value); try { await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { costDW: dw }); for (const i of appData.costs) { await setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'costs', i.hub), i); } Swal.fire('Sukses', 'Tersimpan', 'success'); } catch(e) { Swal.fire('Error', 'Gagal', 'error'); } };

    </script>
</body>
</html>