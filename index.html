<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUB Daily Report Dashboard (Online)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .sidebar-item-active { background-color: #374151; border-left: 4px solid #3b82f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .attendance-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; accent-color: #2563eb; }
        /* Loading Overlay */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; bg-white; z-index: 9999; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.9); }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="font-bold text-gray-600">Menghubungkan ke Database...</p>
        </div>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-900 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">HUB REPORT</h1>
                <p class="text-gray-500 text-sm">Daily Dashboard System (Online)</p>
            </div>

            <div class="flex mb-6 bg-gray-100 rounded p-1">
                <button onclick="window.switchLoginTab('user')" id="tab-user" class="flex-1 py-2 rounded shadow bg-white text-blue-600 font-semibold text-sm transition">User (PIC/Sorter)</button>
                <button onclick="window.switchLoginTab('admin')" id="tab-admin" class="flex-1 py-2 rounded text-gray-500 font-semibold text-sm transition">Admin</button>
            </div>

            <form id="form-login-user">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ID User</label>
                    <input type="text" id="login-id" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan ID User" required>
                </div>
                <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="is-pic-checkbox" class="mr-2" onchange="window.togglePasswordField()">
                        <label for="is-pic-checkbox" class="text-sm text-gray-600 cursor-pointer">Saya adalah PIC (Input Password)</label>
                    </div>
                    <input type="password" id="login-pass-user" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 hidden" placeholder="Kata Sandi">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Masuk</button>
            </form>

            <form id="form-login-admin" class="hidden">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password Admin</label>
                    <input type="password" id="login-pass-admin" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Default: 123456" required>
                </div>
                <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-900 transition">Masuk Admin</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="app-section" class="flex h-screen hidden overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col shadow-lg transition-all duration-300" id="sidebar">
            <div class="p-6 text-center border-b border-gray-700">
                <h2 class="text-xl font-bold">HUB DASHBOARD</h2>
                <div class="mt-2 inline-block bg-blue-600 text-xs px-2 py-1 rounded" id="user-badge">Role</div>
                <p class="text-xs text-gray-400 mt-1" id="user-name-display">Nama User</p>
            </div>
            <nav class="flex-1 mt-6">
                <a href="#" onclick="window.navigate('dashboard')" id="nav-dashboard" class="flex items-center px-6 py-3 hover:bg-gray-800 transition sidebar-item-active"><i class="fas fa-tachometer-alt w-6"></i><span>Dashboard</span></a>
                <a href="#" onclick="window.navigate('laporan')" id="nav-laporan" class="flex items-center px-6 py-3 hover:bg-gray-800 transition"><i class="fas fa-file-alt w-6"></i><span>Laporan</span></a>
                <a href="#" onclick="window.navigate('pengaturan')" id="nav-pengaturan" class="flex items-center px-6 py-3 hover:bg-gray-800 transition hidden"><i class="fas fa-cogs w-6"></i><span>Pengaturan</span></a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button onclick="window.logout()" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white py-2 rounded transition"><i class="fas fa-sign-out-alt mr-2"></i> Keluar</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
                <button onclick="window.toggleSidebar()" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
                <h1 class="font-bold text-lg">HUB Report</h1>
            </header>

            <div class="flex-1 overflow-y-auto p-6 relative">
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="view-content fade-in">
                    <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fas fa-filter mr-2"></i>Filter</h3>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Mulai</label><input type="date" id="dash-start-date" class="border p-2 rounded text-sm w-40"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">Sampai</label><input type="date" id="dash-end-date" class="border p-2 rounded text-sm w-40"></div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">HUB</label><select id="dash-hub-select" class="border p-2 rounded text-sm w-40"><option value="ALL">Semua HUB</option></select></div>
                            <button onclick="window.loadDashboardData()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 text-sm font-bold shadow"><i class="fas fa-search mr-2"></i> Tampilkan</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200"><h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Trend Tahunan (Total Paket)</h4><div class="relative h-64"><canvas id="chart-annual"></canvas></div></div>
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200"><h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Trend Periode (Total Paket)</h4><div class="relative h-64"><canvas id="chart-daily"></canvas></div></div>
                    </div>
                    <div class="mb-8 bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                        <div class="p-4 bg-gray-50 border-b flex justify-between items-center"><h3 class="font-bold text-gray-800">Rincian Data per Tanggal</h3><button onclick="window.exportTableToCSV('table-daily-detail', 'rincian_harian.csv')" class="text-xs text-blue-600 hover:underline"><i class="fas fa-download"></i> Export CSV</button></div>
                        <div class="overflow-x-auto"><table id="table-daily-detail" class="w-full text-sm text-center"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-3 py-3 text-left">Tanggal</th><th class="px-3 py-3">HUB</th><th class="px-3 py-3 text-blue-700">MPP</th><th class="px-3 py-3">Staging</th><th class="px-3 py-3">Gateway</th><th class="px-3 py-3">JNE</th><th class="px-3 py-3">SAP</th><th class="px-3 py-3 font-bold">Outbound</th><th class="px-3 py-3 text-green-700">Prod.</th><th class="px-3 py-3 text-right text-red-600">Cost</th></tr></thead><tbody id="tbody-daily-detail" class="text-gray-600"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                        <div class="p-4 bg-gray-50 border-b"><h3 class="font-bold text-gray-800">Breakdown Performa HUB</h3></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-center"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3 text-left">Nama HUB</th><th class="px-4 py-3">Total MPP</th><th class="px-4 py-3 font-bold">Total Outbound</th><th class="px-4 py-3 text-green-700">Rata-rata Prod.</th><th class="px-4 py-3 text-right text-red-600">Total Cost</th></tr></thead><tbody id="tbody-hub-breakdown" class="text-gray-600"></tbody></table></div>
                    </div>
                    <div class="h-10"></div>
                </div>

                <!-- LAPORAN -->
                <div id="view-laporan" class="view-content hidden fade-in">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Laporan Harian</h2><button onclick="window.openLaporanModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 hidden" id="btn-tambah-laporan"><i class="fas fa-plus mr-2"></i> Buat Laporan</button></div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Tanggal</th><th class="px-6 py-3">HUB</th><th class="px-6 py-3">Total Paket</th><th class="px-6 py-3">MPP</th><th class="px-6 py-3">Productivity</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="laporan-list-body"></tbody></table></div>
                    <div id="empty-laporan-msg" class="hidden text-center py-10 text-gray-400"><p>Belum ada laporan.</p></div>
                </div>

                <!-- PENGATURAN -->
                <div id="view-pengaturan" class="view-content hidden fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Pengaturan</h2>
                    <div class="mb-6 border-b border-gray-200"><ul class="flex flex-wrap -mb-px text-sm font-medium text-center"><li class="mr-2"><button onclick="window.switchSettingsTab('users')" id="set-tab-users" class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 active">Manajemen User</button></li><li class="mr-2"><button onclick="window.switchSettingsTab('general')" id="set-tab-general" class="inline-block p-4 border-b-2 border-transparent">Akses & Admin</button></li><li class="mr-2"><button onclick="window.switchSettingsTab('cost')" id="set-tab-cost" class="inline-block p-4 border-b-2 border-transparent">Cost Mitra</button></li></ul></div>
                    <div id="settings-users" class="settings-panel"><div class="flex justify-between mb-4"><h3 class="text-lg font-semibold">User</h3><button onclick="window.openUserModal()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm"><i class="fas fa-user-plus"></i> Tambah</button></div><div class="bg-white rounded shadow overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">ID</th><th class="px-6 py-3">HUB</th><th class="px-6 py-3">Posisi</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div>
                    <div id="settings-general" class="settings-panel hidden"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-6 rounded shadow"><h3 class="font-bold text-gray-700 mb-4">Password Admin</h3><div class="mb-4"><label class="block text-sm mb-1">Baru</label><input type="password" id="new-admin-pass" class="w-full border p-2 rounded"></div><button onclick="window.saveAdminPass()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Simpan</button></div><div class="bg-white p-6 rounded shadow"><h3 class="font-bold text-gray-700 mb-4">Kode Akses Leader</h3><div class="mb-4"><label class="block text-sm mb-1">Kode</label><input type="text" id="access-code-input" class="w-full border p-2 rounded"></div><button onclick="window.saveAccessCode()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm">Simpan</button></div></div></div>
                    <div id="settings-cost" class="settings-panel hidden"><div class="bg-white p-6 rounded shadow max-w-2xl"><div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded"><h3 class="font-bold text-gray-800 mb-2">Biaya DW (Global)</h3><input type="text" id="global-cost-dw" placeholder="Rp" class="border p-2 rounded w-full" onkeyup="window.formatCostInput(this)"></div><h3 class="font-bold text-gray-700 mb-4">Cost HUB (Sorter)</h3><div id="cost-container"></div><button onclick="window.addCostRow()" class="mt-4 text-blue-600 text-sm font-semibold underline">+ Tambah HUB</button><div class="mt-6 pt-4 border-t"><button onclick="window.saveCosts()" class="bg-green-600 text-white px-4 py-2 rounded">Simpan</button></div></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg w-full max-w-lg shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold" id="modal-title">User</h3><button onclick="window.closeUserModal()">&times;</button></div><form id="user-form"><input type="hidden" id="edit-user-id"><div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label class="text-xs font-bold uppercase">Nama</label><input type="text" id="input-nama" class="w-full border p-2 rounded" required></div><div><label class="text-xs font-bold uppercase">ID User</label><input type="text" id="input-id" class="w-full border p-2 rounded" required></div><div><label class="text-xs font-bold uppercase">Sandi</label><input type="text" id="input-sandi" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold uppercase">HUB</label><select id="input-kode-hub" class="w-full border p-2 rounded" required></select></div><div><label class="text-xs font-bold uppercase">Posisi</label><select id="input-posisi" class="w-full border p-2 rounded"><option value="Sorter">Sorter</option><option value="DW">DW</option><option value="PIC">PIC</option><option value="Admin">Admin</option></select></div><div class="col-span-2"><label class="text-xs font-bold uppercase">Akses Laporan</label><div class="flex gap-4"><label><input type="radio" name="akses_laporan" value="YA"> YA</label><label><input type="radio" name="akses_laporan" value="TIDAK" checked> TIDAK</label></div></div></div><div class="mt-6 flex justify-end gap-2"><button type="button" onclick="window.closeUserModal()" class="px-4 py-2 border rounded">Batal</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button></div></form></div></div>
    <div id="laporan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50 overflow-y-auto"><div class="bg-white rounded-lg w-full max-w-4xl shadow-2xl my-10 flex flex-col max-h-screen"><div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-lg"><h3 class="text-xl font-bold" id="laporan-modal-title">Laporan</h3><button onclick="window.closeLaporanModal()" class="text-2xl">&times;</button></div><div class="p-6 overflow-y-auto"><form id="laporan-form"><input type="hidden" id="edit-laporan-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded border"><div><label class="text-xs font-bold uppercase">Tanggal</label><input type="date" id="lap-tanggal" class="w-full border p-2 rounded" required></div><div><label class="text-xs font-bold uppercase">HUB</label><select id="lap-hub-select" class="w-full border p-2 rounded hidden" onchange="window.loadHubUsersForAttendance()"></select><input type="text" id="lap-hub-text" class="w-full border p-2 rounded bg-gray-200 hidden" readonly></div></div><h4 class="font-bold text-gray-700 mb-2 border-b pb-1">Metrix</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div><label class="text-xs">Gateway</label><input type="text" id="lap-gateway" class="w-full border p-2 rounded font-mono" placeholder="0" onkeyup="window.calcMetrics(this)"></div><div><label class="text-xs">Staging</label><input type="text" id="lap-staging" class="w-full border p-2 rounded font-mono" placeholder="0" onkeyup="window.calcMetrics(this)"></div><div><label class="text-xs">JNE</label><input type="text" id="lap-jne" class="w-full border p-2 rounded font-mono" placeholder="0" onkeyup="window.calcMetrics(this)"></div><div><label class="text-xs">SAP</label><input type="text" id="lap-sap" class="w-full border p-2 rounded font-mono" placeholder="0" onkeyup="window.calcMetrics(this)"></div></div><div class="grid grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded border border-blue-100"><div class="text-center"><p class="text-xs uppercase">Total Paket</p><p class="text-2xl font-bold text-blue-700" id="disp-total-paket">0</p><input type="hidden" id="val-total-paket"></div><div class="text-center"><p class="text-xs uppercase">Productivity</p><p class="text-2xl font-bold text-green-600" id="disp-productivity">0</p></div></div><div class="flex justify-between items-end mb-2 border-b pb-1"><h4 class="font-bold">Absensi</h4><div class="text-right"><span class="text-xs">MPP:</span><span class="font-bold text-lg ml-1" id="disp-total-mpp">0</span></div></div><div class="overflow-x-auto border rounded mb-2"><table class="w-full text-sm text-center"><thead class="bg-gray-100 text-xs uppercase font-bold"><tr><th class="p-2 text-left w-1/3">Nama</th><th class="p-2 w-10">1</th><th class="p-2 w-10">2</th><th class="p-2 w-10">3</th><th class="p-2 w-10 text-yellow-600">I</th><th class="p-2 w-10 text-blue-600">S</th><th class="p-2 w-10 text-red-600">A</th><th class="p-2 text-left">Ket</th><th class="p-2 w-8"></th></tr></thead><tbody id="attendance-tbody"></tbody></table></div><button type="button" onclick="window.addManualDWRow()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded w-full border border-dashed border-gray-400 mb-6">+ DW Manual</button><div class="flex justify-end gap-3 pt-4 border-t"><button type="button" onclick="window.closeLaporanModal()" class="px-5 py-2 border rounded">Batal</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded font-bold">Simpan</button></div></form></div></div></div>

    <!-- MODULE SCRIPT (Firebase) -->
    <script type="module">
        // --- 1. FIREBASE CONFIGURATION & IMPORTS ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, deleteDoc, updateDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- KONFIGURASI BARU (Project: hub-dashboard-92428) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXOfZbVDqtfGB0abQkTeILo-XC6a9xxKI",
            authDomain: "hub-dashboard-92428.firebaseapp.com",
            projectId: "hub-dashboard-92428",
            storageBucket: "hub-dashboard-92428.firebasestorage.app",
            messagingSenderId: "827243064075",
            appId: "1:827243064075:web:21b8e40b88f13b2433d00e"
        };

        const appId = 'hub-dashboard-v1'; // ID Aplikasi untuk path database
        let app, auth, db;
        let unsubscribeUsers, unsubscribeCosts, unsubscribeLaporan, unsubscribeSettings;

        // Global State (Local Cache)
        let appData = {
            adminPass: '123456',
            accessCode: 'SUPERHUB',
            costDW: 120000,
            users: [],
            costs: [],
            laporan: []
        };
        let currentUser = null;
        let annualChart = null, dailyChart = null;

        // --- INIT FIREBASE ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Sign In Anonymously
            signInAnonymously(auth).catch((error) => {
                console.error("Auth Error:", error);
                Swal.fire('Error', 'Gagal koneksi ke server authentication.', 'error');
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('login-section').classList.remove('hidden');
                    initListeners(); // Start listening to data
                }
            });

        } catch (e) {
            console.error(e);
            document.getElementById('loading-overlay').innerHTML = `<p class="text-red-600 font-bold p-4">Error Config Firebase. Cek console.</p>`;
        }

        // --- DATABASE LISTENERS (REALTIME UPDATE) ---
        function initListeners() {
            // Path Helper: artifacts/{appId}/public/data/{collection}
            const publicPath = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

            // 1. Settings (Config Doc)
            unsubscribeSettings = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    appData.adminPass = d.adminPass || '123456';
                    appData.accessCode = d.accessCode || 'SUPERHUB';
                    appData.costDW = d.costDW || 120000;
                } else {
                    // Create default settings if not exists
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                        adminPass: '123456', accessCode: 'SUPERHUB', costDW: 120000
                    });
                }
            });

            // 2. Users
            unsubscribeUsers = onSnapshot(publicPath('users'), (snapshot) => {
                appData.users = [];
                snapshot.forEach(doc => appData.users.push(doc.data()));
                if(document.getElementById('view-pengaturan').classList.contains('hidden') === false) window.renderUserTable();
            });

            // 3. Costs
            unsubscribeCosts = onSnapshot(publicPath('costs'), (snapshot) => {
                appData.costs = [];
                snapshot.forEach(doc => appData.costs.push(doc.data()));
                // Update dropdowns if needed dynamically
                if(document.getElementById('view-pengaturan').classList.contains('hidden') === false) window.renderCostInputs();
            });

            // 4. Laporan
            unsubscribeLaporan = onSnapshot(publicPath('laporan'), (snapshot) => {
                appData.laporan = [];
                snapshot.forEach(doc => appData.laporan.push(doc.data()));
                // Refresh views if active
                if(document.getElementById('view-dashboard').classList.contains('hidden') === false) window.loadDashboardData();
                if(document.getElementById('view-laporan').classList.contains('hidden') === false) window.renderLaporanList();
            });
        }

        // --- EXPORTED FUNCTIONS TO WINDOW (For HTML onclick access) ---
        
        window.Chart.register(ChartDataLabels); // Register Chart Plugin

        // -- UTILS --
        window.formatNumber = (num) => (!num && num !== 0) ? '' : num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        window.parseFormattedNumber = (str) => (!str) ? 0 : parseInt(str.toString().replace(/\./g, ''), 10) || 0;
        window.formatCostInput = (e) => { let val = e.value.replace(/\./g, '').replace(/[^0-9]/g, ''); e.value = window.formatNumber(val); };
        window.formatRupiah = (n) => { if(n == null) return ''; let s = n.toString().replace(/[^,\d]/g, ''), spl = s.split(','), rem = spl[0].length % 3, r = spl[0].substr(0, rem), th = spl[0].substr(rem).match(/\d{3}/gi); if(th) { let sep = rem ? '.' : ''; r += sep + th.join('.'); } return 'Rp. ' + r; };

        // -- AUTH UI --
        window.switchLoginTab = (type) => {
            if(type === 'user') {
                document.getElementById('form-login-user').classList.remove('hidden'); document.getElementById('form-login-admin').classList.add('hidden');
                document.getElementById('tab-user').classList.add('bg-white', 'text-blue-600', 'shadow'); document.getElementById('tab-user').classList.remove('text-gray-500');
                document.getElementById('tab-admin').classList.remove('bg-white', 'text-blue-600', 'shadow'); document.getElementById('tab-admin').classList.add('text-gray-500');
            } else {
                document.getElementById('form-login-user').classList.add('hidden'); document.getElementById('form-login-admin').classList.remove('hidden');
                document.getElementById('tab-admin').classList.add('bg-white', 'text-blue-600', 'shadow'); document.getElementById('tab-admin').classList.remove('text-gray-500');
                document.getElementById('tab-user').classList.remove('bg-white', 'text-blue-600', 'shadow'); document.getElementById('tab-user').classList.add('text-gray-500');
            }
        };
        window.togglePasswordField = () => {
            const isPic = document.getElementById('is-pic-checkbox').checked; const pass = document.getElementById('login-pass-user');
            isPic ? (pass.classList.remove('hidden'), pass.setAttribute('required', 'true')) : (pass.classList.add('hidden'), pass.removeAttribute('required'), pass.value = '');
        };

        // -- LOGIN HANDLERS --
        document.getElementById('form-login-admin').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('login-pass-admin').value === appData.adminPass) { currentUser = { role: 'admin', name: 'Administrator', id: 'admin', kode_hub: 'ALL' }; window.enterApp(); } 
            else Swal.fire('Error', 'Password Admin Salah!', 'error');
        });

        document.getElementById('form-login-user').addEventListener('submit', (e) => {
            e.preventDefault(); 
            const id = document.getElementById('login-id').value; const isPic = document.getElementById('is-pic-checkbox').checked; const pass = document.getElementById('login-pass-user').value; 
            const u = appData.users.find(u => u.id === id);
            if (!u) return Swal.fire('Error', 'ID User tidak ditemukan.', 'error');
            if (isPic) { if (u.sandi === pass) { currentUser = { role: 'pic', name: u.nama, id: u.id, akses_laporan: u.akses, kode_hub: u.kode_hub }; window.enterApp(); } else Swal.fire('Error', 'Password Salah!', 'error'); }
            else { if (u.posisi === 'PIC' || u.posisi === 'Admin') return Swal.fire('Warning', 'Gunakan login PIC.', 'warning'); currentUser = { role: 'sorter', name: u.nama, id: u.id, akses_laporan: 'TIDAK', kode_hub: u.kode_hub }; window.enterApp(); }
        });

        window.enterApp = () => {
            document.getElementById('login-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-name-display').innerText = currentUser.name; document.getElementById('user-badge').innerText = currentUser.role.toUpperCase();
            
            const navSet = document.getElementById('nav-pengaturan'); const btnAdd = document.getElementById('btn-tambah-laporan');
            if (currentUser.role === 'admin') { navSet.classList.remove('hidden'); btnAdd.classList.remove('hidden'); }
            else if (currentUser.role === 'pic' && currentUser.akses_laporan === 'YA') { navSet.classList.add('hidden'); btnAdd.classList.remove('hidden'); }
            else { navSet.classList.add('hidden'); btnAdd.classList.add('hidden'); }
            
            window.initDashboardFilters();
            window.navigate('dashboard');
        };

        window.logout = () => { 
            currentUser = null; document.getElementById('app-section').classList.add('hidden'); document.getElementById('login-section').classList.remove('hidden'); 
            document.getElementById('form-login-user').reset(); document.getElementById('form-login-admin').reset(); window.togglePasswordField(); 
        };

        window.navigate = (viewId) => {
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('aside nav a').forEach(el => el.classList.remove('sidebar-item-active', 'bg-gray-800'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden'); document.getElementById(`nav-${viewId}`).classList.add('sidebar-item-active', 'bg-gray-800');
            
            if (viewId === 'dashboard') window.loadDashboardData();
            if (viewId === 'pengaturan') window.loadSettingsUI();
            if (viewId === 'laporan') window.renderLaporanList();
            
            const sb = document.getElementById('sidebar'); if(window.innerWidth < 768 && !sb.classList.contains('-translate-x-full')) window.toggleSidebar();
        };
        window.toggleSidebar = () => { const sb = document.getElementById('sidebar'); sb.classList.toggle('hidden'); sb.classList.toggle('absolute'); sb.classList.toggle('z-50'); sb.classList.toggle('h-full'); };

        // -- DASHBOARD --
        window.initDashboardFilters = () => {
            const end = new Date(); const start = new Date(); start.setDate(end.getDate() - 30);
            document.getElementById('dash-end-date').valueAsDate = end; document.getElementById('dash-start-date').valueAsDate = start;
            const hubSel = document.getElementById('dash-hub-select'); hubSel.innerHTML = '<option value="ALL">Semua HUB</option>';
            appData.costs.forEach(c => { hubSel.innerHTML += `<option value="${c.hub}">${c.hub}</option>`; });
            if (currentUser.role !== 'admin') { hubSel.value = currentUser.kode_hub; hubSel.disabled = true; hubSel.classList.add('bg-gray-100'); }
            else { hubSel.disabled = false; hubSel.classList.remove('bg-gray-100'); }
        };

        window.loadDashboardData = () => {
            const startStr = document.getElementById('dash-start-date').value; const endStr = document.getElementById('dash-end-date').value; const hubFilter = document.getElementById('dash-hub-select').value;
            if(!startStr || !endStr) return;
            const startDate = new Date(startStr); const endDate = new Date(endStr);
            let filtered = appData.laporan.filter(l => { const lDate = new Date(l.tanggal); return lDate >= startDate && lDate <= endDate && (hubFilter === 'ALL' || l.hub === hubFilter); });
            filtered.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            window.updateCharts(filtered, hubFilter); window.updateDashboardTables(filtered);
        };

        window.getHubCostRate = (hubName) => { const cfg = appData.costs.find(c => c.hub === hubName); return cfg ? cfg.cost : 0; };
        
        window.calculateReportCost = (report) => {
            let total = 0; const hubRate = window.getHubCostRate(report.hub); const dwRate = appData.costDW || 0;
            if (report.attendance_data) {
                report.attendance_data.forEach(att => {
                    if (att.s1 || att.s2 || att.s3) {
                        let isDW = att.userId.startsWith('manual_');
                        if (!isDW) { const u = appData.users.find(user => user.id === att.userId); if (u && u.posisi === 'DW') isDW = true; }
                        total += isDW ? dwRate : hubRate;
                    }
                });
            } else total = report.total_mpp * hubRate;
            return total;
        };

        window.updateCharts = (periodData, hubFilter) => {
            const currentYear = new Date().getFullYear();
            const monthlyData = Array(12).fill(0).map(() => ({ pkg: 0, mpp: 0 }));
            let annualSource = appData.laporan.filter(l => new Date(l.tanggal).getFullYear() === currentYear);
            if (hubFilter !== 'ALL') annualSource = annualSource.filter(l => l.hub === hubFilter);
            annualSource.forEach(l => { const m = new Date(l.tanggal).getMonth(); monthlyData[m].pkg += l.total_paket; monthlyData[m].mpp += l.total_mpp; });
            const dataPkgMonth = monthlyData.map(d => d.pkg); const dataProdMonth = monthlyData.map(d => d.mpp > 0 ? Math.round(d.pkg / d.mpp) : 0);
            window.renderChart('chart-annual', ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'], dataPkgMonth, dataProdMonth, 'Total Paket', 'Prod.');

            const aggDaily = {};
            periodData.forEach(l => {
                if (!aggDaily[l.tanggal]) aggDaily[l.tanggal] = { pkg: 0, mpp: 0 };
                aggDaily[l.tanggal].pkg += l.total_paket; aggDaily[l.tanggal].mpp += l.total_mpp;
            });
            const sDates = Object.keys(aggDaily).sort();
            const lbls = sDates.map(dStr => { const d = new Date(dStr); return `${d.getDate()}/${d.getMonth()+1}`; });
            const dPkg = sDates.map(d => aggDaily[d].pkg); const dProd = sDates.map(d => aggDaily[d].mpp > 0 ? Math.round(aggDaily[d].pkg / aggDaily[d].mpp) : 0);
            window.renderChart('chart-daily', lbls, dPkg, dProd, 'Total Paket', 'Prod.');
        };

        window.renderChart = (canvasId, labels, dataBar, dataLine, labelBar, labelLine) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (canvasId === 'chart-annual') { if(annualChart) annualChart.destroy(); }
            if (canvasId === 'chart-daily') { if(dailyChart) dailyChart.destroy(); }
            const config = { type: 'bar', data: { labels: labels, datasets: [
                { label: labelBar, data: dataBar, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, order: 2, datalabels: { align: 'end', anchor: 'end', color: '#1e3a8a', font: { weight: 'bold', size: 11 }, formatter: v => v > 0 ? window.formatNumber(v) : '' } },
                { label: labelLine, data: dataLine, type: 'line', borderColor: 'rgba(234, 88, 12, 1)', backgroundColor: 'rgba(234, 88, 12, 1)', borderWidth: 2, tension: 0.2, order: 1, datalabels: { align: 'top', anchor: 'start', color: '#c2410c', font: { weight: 'bold', size: 11 }, offset: 4, formatter: v => v > 0 ? window.formatNumber(v) : '' } }
            ] }, options: { responsive: true, maintainAspectRatio: false, layout: { padding: { top: 25 } }, plugins: { legend: { display: false }, tooltip: { enabled: true }, datalabels: { display: true } }, scales: { x: { grid: { display: false } }, y: { display: false }, y1: { display: false } } } };
            const chart = new Chart(ctx, config);
            if (canvasId === 'chart-annual') annualChart = chart; if (canvasId === 'chart-daily') dailyChart = chart;
        };

        window.updateDashboardTables = (data) => {
            const tbodyDetail = document.getElementById('tbody-daily-detail'); tbodyDetail.innerHTML = '';
            data.forEach(l => {
                const totalCost = window.calculateReportCost(l);
                tbodyDetail.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-3 py-2 text-left whitespace-nowrap">${l.tanggal}</td><td class="px-3 py-2 font-semibold">${l.hub}</td><td class="px-3 py-2 text-blue-700 font-bold">${l.total_mpp}</td><td class="px-3 py-2">${window.formatNumber(l.staging)}</td><td class="px-3 py-2">${window.formatNumber(l.gateway)}</td><td class="px-3 py-2">${window.formatNumber(l.jne)}</td><td class="px-3 py-2">${window.formatNumber(l.sap)}</td><td class="px-3 py-2 font-bold">${window.formatNumber(l.total_paket)}</td><td class="px-3 py-2 text-green-700 font-bold">${window.formatNumber(Math.round(l.productivity))}</td><td class="px-3 py-2 text-right text-red-600 text-xs">${window.formatRupiah(totalCost)}</td></tr>`;
            });
            const tbodyHub = document.getElementById('tbody-hub-breakdown'); tbodyHub.innerHTML = '';
            const hubAgg = {};
            data.forEach(l => {
                if(!hubAgg[l.hub]) hubAgg[l.hub] = { mpp: 0, out: 0, cost: 0 };
                hubAgg[l.hub].mpp += l.total_mpp; hubAgg[l.hub].out += l.total_paket; hubAgg[l.hub].cost += window.calculateReportCost(l);
            });
            Object.keys(hubAgg).forEach(hub => {
                const d = hubAgg[hub]; const avgProd = d.mpp > 0 ? Math.round(d.out / d.mpp) : 0;
                tbodyHub.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 text-left font-bold text-gray-800">${hub}</td><td class="px-4 py-3">${d.mpp}</td><td class="px-4 py-3 font-bold">${window.formatNumber(d.out)}</td><td class="px-4 py-3 text-green-700 font-bold">${window.formatNumber(avgProd)}</td><td class="px-4 py-3 text-right text-red-600 font-bold">${window.formatRupiah(d.cost)}</td></tr>`;
            });
        };
        window.exportTableToCSV = (tableId, filename) => {
            const table = document.getElementById(tableId); let csv = []; const rows = table.querySelectorAll("tr");
            for (let i = 0; i < rows.length; i++) { let row = [], cols = rows[i].querySelectorAll("td, th"); for (let j = 0; j < cols.length; j++) row.push(cols[j].innerText); csv.push(row.join(",")); }
            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"}); const dl = document.createElement("a"); dl.download = filename; dl.href = window.URL.createObjectURL(csvFile); dl.style.display = "none"; document.body.appendChild(dl); dl.click();
        };

        // -- SETTINGS & CRUD (Async Firestore) --
        window.switchSettingsTab = (tab) => {
            document.querySelectorAll('.settings-panel').forEach(el => el.classList.add('hidden')); document.getElementById(`settings-${tab}`).classList.remove('hidden');
            ['users', 'general', 'cost'].forEach(t => { const btn = document.getElementById(`set-tab-${t}`); t===tab ? (btn.classList.add('text-blue-600','border-blue-600','active'),btn.classList.remove('border-transparent')) : (btn.classList.remove('text-blue-600','border-blue-600','active'),btn.classList.add('border-transparent')); });
        };
        window.loadSettingsUI = () => { window.renderUserTable(); document.getElementById('access-code-input').value = appData.accessCode; document.getElementById('global-cost-dw').value = window.formatNumber(appData.costDW); window.renderCostInputs(); };
        
        window.renderUserTable = () => {
            const tb = document.getElementById('user-table-body'); tb.innerHTML = '';
            appData.users.forEach((u) => { // No index used for delete anymore, use ID
                tb.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-medium">${u.nama}</td><td class="px-6 py-4">${u.id}</td><td class="px-6 py-4">${u.kode_hub}</td><td class="px-6 py-4">${u.posisi}</td><td class="px-6 py-4"><span class="${u.akses==='YA'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'} text-xs font-medium px-2.5 py-0.5 rounded">${u.akses}</span></td><td class="px-6 py-4 text-right"><button onclick="window.openUserModal('${u.id}')" class="text-blue-600 hover:underline mr-3">Edit</button><button onclick="window.deleteUser('${u.id}')" class="text-red-600 hover:underline">Hapus</button></td></tr>`;
            });
        };
        window.openUserModal = (id=null) => {
            document.getElementById('user-modal').classList.remove('hidden'); const hubSel = document.getElementById('input-kode-hub'); hubSel.innerHTML = '<option value="">-- Pilih HUB --</option>'; appData.costs.forEach(c => { if(c.hub) hubSel.innerHTML += `<option value="${c.hub}">${c.hub}</option>`; });
            if (id) { 
                const u = appData.users.find(x => x.id === id); 
                document.getElementById('modal-title').innerText = 'Edit User'; document.getElementById('edit-index').value = id; // use ID as key
                document.getElementById('input-nama').value = u.nama; document.getElementById('input-id').value = u.id; document.getElementById('input-sandi').value = u.sandi; document.getElementById('input-kode-hub').value = u.kode_hub; document.getElementById('input-posisi').value = u.posisi; document.getElementsByName('akses_laporan').forEach(r => { if(r.value === u.akses) r.checked = true; }); document.getElementById('input-id').readOnly = true; document.getElementById('input-id').classList.add('bg-gray-100'); 
            } else { document.getElementById('modal-title').innerText = 'Tambah User'; document.getElementById('edit-index').value = ''; document.getElementById('user-form').reset(); document.getElementById('input-id').readOnly = false; document.getElementById('input-id').classList.remove('bg-gray-100'); }
        };
        window.closeUserModal = () => { document.getElementById('user-modal').classList.add('hidden'); };
        
        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const editId = document.getElementById('edit-index').value; 
            const nu = { nama: document.getElementById('input-nama').value, id: document.getElementById('input-id').value, sandi: document.getElementById('input-sandi').value, kode_hub: document.getElementById('input-kode-hub').value, posisi: document.getElementById('input-posisi').value, akses: document.querySelector('input[name="akses_laporan"]:checked').value }; 
            
            try {
                if (!editId && appData.users.some(u => u.id === nu.id)) return Swal.fire('Error', 'ID User sudah ada!', 'error');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', nu.id), nu);
                window.closeUserModal(); Swal.fire('Sukses', 'Data user tersimpan.', 'success');
            } catch (err) { console.error(err); Swal.fire('Error', 'Gagal simpan user.', 'error'); }
        });

        window.deleteUser = async (id) => { 
            Swal.fire({title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya', confirmButtonColor: '#d33'}).then(async (r) => { 
                if(r.isConfirmed) { 
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
                    Swal.fire('Terhapus', '', 'success'); 
                } 
            }); 
        };
        
        window.saveAdminPass = async () => { 
            const p = document.getElementById('new-admin-pass').value; if(p.length<4) return Swal.fire('Error', 'Min 4 char', 'error'); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { adminPass: p });
            document.getElementById('new-admin-pass').value=''; Swal.fire('Sukses', 'Pass Admin Updated', 'success'); 
        };
        window.saveAccessCode = async () => { 
            const c = document.getElementById('access-code-input').value; if(!c) return; 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { accessCode: c });
            Swal.fire('Sukses', 'Kode Akses Updated', 'success'); 
        };
        
        window.renderCostInputs = () => { const c = document.getElementById('cost-container'); c.innerHTML = ''; appData.costs.forEach((x, i) => { c.innerHTML += `<div class="flex gap-2 mb-2"><input type="text" placeholder="Kode HUB" value="${x.hub}" id="cost-hub-${i}" class="border p-2 rounded w-1/3"><input type="text" placeholder="Biaya" value="${window.formatRupiah(x.cost)}" id="cost-val-${i}" class="border p-2 rounded w-1/3 text-right" onkeyup="window.formatCostInput(this)"><button onclick="window.removeCostRow(${i})" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-trash"></i></button></div>`; }); };
        window.addCostRow = () => { appData.costs.push({ hub: '', cost: 0 }); window.renderCostInputs(); }; // Temp push locally until save
        window.removeCostRow = (i) => { appData.costs.splice(i, 1); window.renderCostInputs(); };
        window.saveCosts = async () => { 
            const n = []; for(let i=0; i<appData.costs.length; i++) { const h = document.getElementById(`cost-hub-${i}`).value; const c = window.parseFormattedNumber(document.getElementById(`cost-val-${i}`).value); if(h) n.push({hub: h, cost: c}); } 
            const dw = window.parseFormattedNumber(document.getElementById('global-cost-dw').value);
            
            try {
                // Batch write costs collection
                // Strategy: Delete all first? Or just Overwrite. Simplest here: Overwrite per doc ID (HubName).
                // Actually to sync array order is hard in NoSQL. We will replace each doc.
                // For simplicity in this demo: We save costs as individual docs.
                // BUT current logic uses appData.costs array. Let's rewrite the whole collection logic slightly?
                // No, to keep it simple: Save 'costs' array into a single doc 'costs/main' OR multiple docs. 
                // Let's stick to instruction: "Collection must only contain documents". 
                // So, we iterate and setDoc each HUB.
                
                // Better approach for "List Editing": Save the array into 'settings/main' or individual docs.
                // Let's use individual docs for scalable HUBs.
                // Collection: costs. Doc ID: HUB Name.
                
                // 1. Update Global DW
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { costDW: dw });

                // 2. Update Hubs
                // Warning: This simplistic approach doesn't delete removed rows from DB. 
                // Proper way: Get all docs, delete ones not in new list.
                // For this helper: We just setDoc.
                for (const item of n) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'costs', item.hub), item);
                }
                Swal.fire('Sukses', 'Cost saved', 'success'); 
            } catch(e) { console.error(e); Swal.fire('Error', 'Save failed', 'error'); }
        };

        // -- LAPORAN CRUD (Async) --
        window.renderLaporanList = () => {
            const tb = document.getElementById('laporan-list-body'); tb.innerHTML = ''; let d = appData.laporan;
            if(currentUser.role !== 'admin') d = d.filter(l => l.hub === currentUser.kode_hub);
            if(d.length === 0) document.getElementById('empty-laporan-msg').classList.remove('hidden');
            else {
                document.getElementById('empty-laporan-msg').classList.add('hidden');
                d.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
                d.forEach(l => {
                    const canEdit = (currentUser.role === 'admin') || (currentUser.role === 'pic' && currentUser.akses_laporan === 'YA' && l.hub === currentUser.kode_hub);
                    const acts = canEdit ? `<div class="flex justify-end gap-2"><button onclick="window.editLaporan('${l.id}')" class="text-blue-600 hover:underline text-xs"><i class="fas fa-edit"></i> Edit</button><button onclick="window.deleteLaporan('${l.id}')" class="text-red-500 hover:underline text-xs"><i class="fas fa-trash"></i> Hapus</button></div>` : '<span class="text-gray-400 text-xs">View Only</span>';
                    tb.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${l.tanggal}</td><td class="px-6 py-4 font-bold">${l.hub}</td><td class="px-6 py-4 text-blue-600 font-bold">${window.formatNumber(l.total_paket)}</td><td class="px-6 py-4">${l.total_mpp}</td><td class="px-6 py-4 text-green-600 font-bold">${Math.round(l.productivity)}</td><td class="px-6 py-4 text-right">${acts}</td></tr>`;
                });
            }
        };
        window.openLaporanModal = () => {
            document.getElementById('laporan-modal').classList.remove('hidden'); document.getElementById('laporan-form').reset(); document.getElementById('laporan-modal-title').innerText = 'Buat Laporan'; document.getElementById('edit-laporan-id').value = ''; document.getElementById('lap-tanggal').valueAsDate = new Date();
            const sel = document.getElementById('lap-hub-select'); const txt = document.getElementById('lap-hub-text');
            if(currentUser.role==='admin') { sel.classList.remove('hidden'); txt.classList.add('hidden'); sel.innerHTML='<option value="">-- Pilih HUB --</option>'; appData.costs.forEach(c=>{sel.innerHTML+=`<option value="${c.hub}">${c.hub}</option>`}); document.getElementById('attendance-tbody').innerHTML='<tr><td colspan="9" class="p-4 text-gray-400">Pilih HUB dulu.</td></tr>'; }
            else { sel.classList.add('hidden'); txt.classList.remove('hidden'); txt.value=currentUser.kode_hub; window.loadHubUsersForAttendance(currentUser.kode_hub); }
            document.getElementById('disp-total-paket').innerText = '0'; document.getElementById('disp-total-mpp').innerText = '0'; document.getElementById('disp-productivity').innerText = '0';
        };
        window.closeLaporanModal = () => { document.getElementById('laporan-modal').classList.add('hidden'); };
        
        window.editLaporan = (id) => {
            const d = appData.laporan.find(x => x.id === id); if(!d) return;
            if(currentUser.role!=='admin' && d.hub!==currentUser.kode_hub) return Swal.fire('Error', 'No Access', 'error');
            window.openLaporanModal(); document.getElementById('laporan-modal-title').innerText = 'Edit Laporan'; document.getElementById('edit-laporan-id').value = id;
            document.getElementById('lap-tanggal').value = d.tanggal;
            if(currentUser.role==='admin') document.getElementById('lap-hub-select').value = d.hub; else document.getElementById('lap-hub-text').value = d.hub;
            document.getElementById('lap-gateway').value = window.formatNumber(d.gateway); document.getElementById('lap-staging').value = window.formatNumber(d.staging); document.getElementById('lap-jne').value = window.formatNumber(d.jne); document.getElementById('lap-sap').value = window.formatNumber(d.sap);
            window.loadHubUsersForAttendance(d.hub, d.attendance_data); window.calcMetrics();
        };

        window.loadHubUsersForAttendance = (hName=null, existing=null) => {
            let h = hName || (document.getElementById('lap-hub-select').value || document.getElementById('lap-hub-text').value);
            const tb = document.getElementById('attendance-tbody'); tb.innerHTML = ''; if(!h) return;
            const users = appData.users.filter(u => u.kode_hub === h);
            const map = {}; if(existing) existing.forEach(x => map[x.userId] = x);
            users.forEach(u => {
                const isL = (u.posisi==='PIC'||u.posisi==='Admin'); const sv = map[u.id] || {s1:0,s2:0,s3:0,i:0,s:0,a:0,ket:''};
                window.renderRow(tb, u.id, u.nama, u.posisi, isL?'<span class="text-xs bg-yellow-200 px-1 rounded ml-1">L</span>':'', isL?'bg-yellow-50':'bg-white', sv, false);
            });
            if(existing) existing.forEach(x => { if(x.userId.startsWith('manual_')) window.renderRow(tb, x.userId, x.nama, 'DW', '<span class="text-xs bg-gray-200 px-1 rounded ml-1">Man</span>', 'bg-white', map[x.userId], true); });
            window.calcMetrics();
        };
        
        window.renderRow = (tb, id, nm, role, badge, cls, sv, man) => {
            const nmF = man ? `<input type="text" name="user_nama[]" value="${nm}" class="w-full border p-1 rounded text-sm" placeholder="Nama">` : `${nm} ${badge}<input type="hidden" name="user_nama[]" value="${nm}">`;
            const del = man ? `<button type="button" onclick="this.closest('tr').remove();window.calcMetrics()" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : '';
            const rowHtml = `<tr class="border-b ${cls}" data-role="${role}"><td class="p-2 text-left font-medium">${nmF}<input type="hidden" name="user_id[]" value="${id}"><input type="hidden" name="is_manual[]" value="${man}"></td>
            <td class="p-2"><input type="checkbox" name="s1[]" class="attendance-checkbox shift-chk" onchange="window.handleSingleCheck(this)" ${sv.s1?'checked':''}></td>
            <td class="p-2"><input type="checkbox" name="s2[]" class="attendance-checkbox shift-chk" onchange="window.handleSingleCheck(this)" ${sv.s2?'checked':''}></td>
            <td class="p-2"><input type="checkbox" name="s3[]" class="attendance-checkbox shift-chk" onchange="window.handleSingleCheck(this)" ${sv.s3?'checked':''}></td>
            <td class="p-2"><input type="checkbox" name="ijin[]" class="attendance-checkbox status-chk" onchange="window.handleSingleCheck(this)" ${sv.i?'checked':''}></td>
            <td class="p-2"><input type="checkbox" name="sakit[]" class="attendance-checkbox status-chk" onchange="window.handleSingleCheck(this)" ${sv.s?'checked':''}></td>
            <td class="p-2"><input type="checkbox" name="alfa[]" class="attendance-checkbox status-chk" onchange="window.handleSingleCheck(this)" ${sv.a?'checked':''}></td>
            <td class="p-2"><input type="text" name="ket[]" value="${sv.ket||''}" class="w-full border p-1 text-xs rounded" placeholder="..."></td><td class="p-2 text-center">${del}</td></tr>`;
            tb.insertAdjacentHTML('beforeend', rowHtml);
        };
        window.addManualDWRow = () => { window.renderRow(document.getElementById('attendance-tbody'), 'manual_'+Date.now(), '', 'DW', '', 'bg-white', {}, true); };
        window.handleSingleCheck = (chk) => { if(chk.checked) { chk.closest('tr').querySelectorAll('.attendance-checkbox').forEach(c => { if(c!==chk) c.checked = false; }); } window.calcMetrics(); };
        window.calcMetrics = (el=null) => {
            if(el) window.formatCostInput(el);
            const g=window.parseFormattedNumber(document.getElementById('lap-gateway').value), s=window.parseFormattedNumber(document.getElementById('lap-staging').value), j=window.parseFormattedNumber(document.getElementById('lap-jne').value), p=window.parseFormattedNumber(document.getElementById('lap-sap').value);
            const tot = g+s+j+p; document.getElementById('disp-total-paket').innerText=window.formatNumber(tot); document.getElementById('val-total-paket').value=tot;
            let mpp = 0;
            document.querySelectorAll('#attendance-tbody tr').forEach(r => {
                const role = r.getAttribute('data-role');
                if(role!=='PIC' && role!=='Admin') { if(r.querySelector('input[name="s1[]"]').checked || r.querySelector('input[name="s2[]"]').checked || r.querySelector('input[name="s3[]"]').checked) mpp++; }
            });
            document.getElementById('disp-total-mpp').innerText = mpp;
            document.getElementById('disp-productivity').innerText = mpp>0 ? window.formatNumber(Math.round(tot/mpp)) : 0;
        };

        document.getElementById('laporan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const h = currentUser.role==='admin'?document.getElementById('lap-hub-select').value:document.getElementById('lap-hub-text').value; if(!h) return Swal.fire('Error','Pilih HUB','error');
            const metrics = { gateway: window.parseFormattedNumber(document.getElementById('lap-gateway').value), staging: window.parseFormattedNumber(document.getElementById('lap-staging').value), jne: window.parseFormattedNumber(document.getElementById('lap-jne').value), sap: window.parseFormattedNumber(document.getElementById('lap-sap').value), total_paket: parseInt(document.getElementById('val-total-paket').value)||0 };
            const att = []; let mpp=0; let err=false;
            document.querySelectorAll('#attendance-tbody tr').forEach(r => {
                const uid=r.querySelector('input[name="user_id[]"]').value, nm=r.querySelector('input[name="user_nama[]"]').value, man=r.querySelector('input[name="is_manual[]"]').value==='true';
                if(man && !nm.trim()) err=true;
                const s1=r.querySelector('input[name="s1[]"]').checked, s2=r.querySelector('input[name="s2[]"]').checked, s3=r.querySelector('input[name="s3[]"]').checked;
                if((s1||s2||s3) && r.getAttribute('data-role')!=='PIC' && r.getAttribute('data-role')!=='Admin') mpp++;
                att.push({ userId:uid, nama:nm, s1, s2, s3, i:r.querySelector('input[name="ijin[]"]').checked, s:r.querySelector('input[name="sakit[]"]').checked, a:r.querySelector('input[name="alfa[]"]').checked, ket:r.querySelector('input[name="ket[]"]').value });
            });
            if(err) return Swal.fire('Error', 'Nama DW Manual kosong', 'warning');
            const prod = mpp>0 ? metrics.total_paket/mpp : 0;
            const idx = document.getElementById('edit-laporan-id').value; // if ID exists
            const docId = idx || Date.now().toString();
            
            const newData = { id: docId, tanggal: document.getElementById('lap-tanggal').value, hub: h, ...metrics, total_mpp: mpp, productivity: prod, attendance_data: att };
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'laporan', docId), newData);
                window.closeLaporanModal(); Swal.fire('Sukses', 'Laporan tersimpan online', 'success');
            } catch (error) { console.error(error); Swal.fire('Error', 'Gagal simpan', 'error'); }
        });

        window.deleteLaporan = async (id) => {
            const r = appData.laporan.find(x => x.id === id); if(currentUser.role!=='admin' && r.hub!==currentUser.kode_hub) return;
            const del = async () => { 
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'laporan', id));
                Swal.fire('Terhapus','','success'); 
            };
            if(currentUser.role==='pic') { Swal.fire({title: 'Kode Akses', input: 'password', showCancelButton: true, preConfirm: (c) => c!==appData.accessCode?Swal.showValidationMessage('Salah'):true}).then((res) => { if(res.isConfirmed) del(); }); }
            else Swal.fire({title: 'Hapus?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(res=>{if(res.isConfirmed) del();});
        };

    </script>
</body>
</html>