<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report Team - Fixed</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Modern Font */
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Utilities */
        .hidden { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Smooth Transitions */
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dynamic Island Notification */
        #dynamic-island {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translate(-50%, -150%) scale(0.9);
            opacity: 0;
        }
        #dynamic-island.active {
            transform: translate(-50%, 20px) scale(1);
            opacity: 1;
        }

        /* Tab Styles */
        .login-tab-active { background-color: #eff6ff; color: #2563eb; border-color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .login-tab-inactive { color: #64748b; background-color: transparent; }
        .login-tab-inactive:hover { background-color: #f1f5f9; color: #334155; }

        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- NOTIFIKASI -->
    <div id="dynamic-island" class="fixed top-0 left-1/2 z-[100] bg-slate-900 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[300px] justify-center border border-slate-700/50">
        <div id="di-icon-container" class="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white">
            <i id="di-icon" data-lucide="check" class="w-4 h-4"></i>
        </div>
        <span id="di-msg" class="text-sm font-medium tracking-wide">Pesan Sistem</span>
    </div>

    <!-- KONFIRMASI MODAL -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 transform transition-all scale-100 animate-in zoom-in-95 duration-200">
            <div class="text-center mb-4">
                <div class="bg-yellow-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 text-yellow-600">
                    <i data-lucide="alert-circle" class="w-7 h-7"></i>
                </div>
                <h3 id="confirm-title" class="font-bold text-lg text-slate-800">Konfirmasi</h3>
                <p id="confirm-desc" class="text-sm text-slate-500 mt-1">Lanjutkan tindakan ini?</p>
            </div>
            <div class="flex gap-3">
                <button id="btn-confirm-no" class="flex-1 py-2.5 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl text-sm font-medium">Batal</button>
                <button id="btn-confirm-yes" class="flex-1 py-2.5 bg-blue-600 text-white hover:bg-blue-700 rounded-xl text-sm font-medium shadow-lg shadow-blue-200">Ya</button>
            </div>
        </div>
    </div>

    <!-- SECURITY MODAL -->
    <div id="security-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 animate-in zoom-in-95 duration-200">
            <div class="text-center mb-5">
                <div class="bg-red-50 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 text-red-600 border border-red-100">
                    <i data-lucide="shield-lock" class="w-7 h-7"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800">Butuh Otorisasi</h3>
                <p class="text-xs text-slate-500 mt-1">Masukkan Kode Keamanan Admin</p>
            </div>
            <input type="password" id="input-secure-code" class="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl mb-4 text-center tracking-[0.5em] font-bold text-lg focus:bg-white" placeholder="••••">
            <div id="secure-error" class="text-xs text-red-500 text-center mb-3 hidden">Kode salah!</div>
            <div class="flex gap-2">
                <button id="btn-cancel-secure" class="flex-1 py-2 text-slate-500 bg-slate-100 rounded-xl text-sm font-medium">Batal</button>
                <button id="btn-confirm-secure" class="flex-1 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium text-sm shadow-md">Verifikasi</button>
            </div>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-500 text-sm font-medium animate-pulse">Menghubungkan Database...</p>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen bg-slate-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100 fade-in-up">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200 text-white transform -rotate-3">
                    <i data-lucide="bar-chart-2" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Daily Report</h1>
                <p class="text-slate-500 text-sm mt-1">Masuk untuk mengelola laporan</p>
            </div>

            <!-- Tabs Login -->
            <div class="grid grid-cols-3 gap-1 mb-6 p-1 bg-slate-100 rounded-xl border border-slate-200">
                <button onclick="window.switchLoginTab('sorter')" id="tab-login-sorter" class="py-2 text-xs font-medium rounded-lg transition-all login-tab-inactive">Sorter</button>
                <button onclick="window.switchLoginTab('leader')" id="tab-login-leader" class="py-2 text-xs font-medium rounded-lg transition-all login-tab-active">Leader</button>
                <button onclick="window.switchLoginTab('admin')" id="tab-login-admin" class="py-2 text-xs font-medium rounded-lg transition-all login-tab-inactive">Admin</button>
            </div>

            <form id="login-form" class="space-y-4">
                <div id="field-nik">
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">Username / NIK</label>
                    <input type="text" id="login-nik" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:bg-white transition-all" placeholder="Masukkan NIK">
                </div>
                <div id="field-pass">
                    <label class="block text-xs font-bold text-slate-600 mb-1 uppercase">Password</label>
                    <input type="password" id="login-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:bg-white transition-all" placeholder="Masukkan Password">
                </div>
                <div id="login-error" class="bg-red-50 text-red-600 text-xs p-3 rounded-lg border border-red-100 hidden flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> <span id="login-error-text">Login Gagal</span>
                </div>
                <button type="submit" id="btn-login" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span>Masuk Aplikasi</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="flex h-screen overflow-hidden hidden bg-slate-50">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-64 bg-slate-900 text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col h-full shadow-2xl">
            <div class="p-6 flex justify-between items-center">
                <span class="font-bold text-xl tracking-tight flex items-center gap-2"><i data-lucide="activity" class="text-blue-400"></i> DailyReport</span>
                <button id="close-sidebar" class="lg:hidden text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 px-4 space-y-2 py-4">
                <button onclick="window.navigateTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition-all text-sm font-medium" data-target="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="window.navigateTo('reports')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition-all text-sm font-medium" data-target="reports">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Laporan
                </button>
                <button onclick="window.navigateTo('settings')" id="menu-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition-all text-sm font-medium hidden" data-target="settings">
                    <i data-lucide="settings" class="w-5 h-5"></i> Pengaturan
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-blue-400">U</div>
                    <div class="overflow-hidden">
                        <p id="user-name-display" class="text-sm font-bold truncate">User</p>
                        <p id="user-role-display" class="text-[10px] text-slate-400 uppercase font-bold">Role</p>
                    </div>
                </div>
                <button onclick="window.handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-800 hover:bg-red-600 text-slate-400 hover:text-white rounded-lg transition-colors text-xs font-bold">
                    <i data-lucide="log-out" class="w-3 h-3"></i> KELUAR
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center lg:hidden sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button id="open-sidebar" class="text-slate-600"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <span class="font-bold text-slate-800">Daily Report</span>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
                <div class="max-w-6xl mx-auto pb-20">
                    
                    <!-- DASHBOARD -->
                    <div id="view-dashboard" class="content-view hidden fade-in-up space-y-6">
                        <div class="flex justify-between items-end">
                            <div><h2 class="text-2xl font-bold text-slate-800">Dashboard</h2><p class="text-slate-500 text-sm">Ringkasan performa tim.</p></div>
                        </div>

                        <!-- Filter -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Dari</label><input type="date" id="dash-start-date" class="w-full p-2 border rounded-lg text-sm"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Sampai</label><input type="date" id="dash-end-date" class="w-full p-2 border rounded-lg text-sm"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Hub</label><div id="dash-hub-container"><input disabled class="w-full p-2 bg-slate-100 border rounded-lg text-sm" value="Loading..."></div></div>
                            <button onclick="window.loadDashboardStats()" id="btn-filter-dash" class="bg-blue-600 text-white p-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors">Terapkan Filter</button>
                        </div>

                        <!-- KPI -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs text-slate-500 font-bold uppercase">Total Paket</div><div id="kpi-total-paket" class="text-2xl font-bold text-blue-600 mt-1">0</div></div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs text-slate-500 font-bold uppercase">Total MPP</div><div id="kpi-total-mpp" class="text-2xl font-bold text-indigo-600 mt-1">0</div></div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs text-slate-500 font-bold uppercase">Produktivitas</div><div id="kpi-productivity" class="text-2xl font-bold text-green-600 mt-1">0</div></div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs text-slate-500 font-bold uppercase">Est. Cost</div><div id="kpi-total-cost" class="text-2xl font-bold text-red-600 mt-1">0</div></div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-64"><canvas id="dailyChart"></canvas></div>
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-64"><canvas id="annualChart"></canvas></div>
                        </div>

                        <!-- Table -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-slate-100 font-bold text-slate-700 bg-slate-50">Rincian Harian</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase"><tr><th class="p-4">Tanggal</th><th class="p-4 text-right">Paket</th><th class="p-4 text-right">MPP</th><th class="p-4 text-right">Prod</th><th class="p-4 text-right">Cost</th></tr></thead>
                                    <tbody id="dash-table-daily" class="divide-y divide-slate-100"><tr><td colspan="5" class="p-4 text-center text-slate-400">Klik "Terapkan Filter" untuk memuat data.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- REPORTS -->
                    <div id="view-reports" class="content-view hidden fade-in-up space-y-6">
                        <div class="flex justify-between items-center">
                            <div><h2 class="text-2xl font-bold text-slate-800">Laporan Harian</h2></div>
                            <button onclick="window.loadMyReports()" class="text-blue-600 text-xs font-bold hover:bg-blue-50 px-3 py-1 rounded"><i data-lucide="refresh-cw" class="w-3 h-3 inline"></i> Refresh</button>
                        </div>

                        <!-- Input Form -->
                        <div id="section-input-report" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-600"></div>
                            <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-blue-600 w-5 h-5"></i> <span id="form-report-title">Input Laporan</span></h3>
                            
                            <form id="form-daily-report" class="space-y-5">
                                <input type="hidden" id="edit-report-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold text-slate-500 uppercase">Tanggal</label><input type="date" id="rpt-date" class="w-full p-2.5 border rounded-xl text-sm" required></div>
                                    <div><label class="text-xs font-bold text-slate-500 uppercase">HUB</label><div id="rpt-hub-container"><input type="text" disabled class="w-full p-2.5 bg-slate-100 border rounded-xl text-sm" value="Auto"></div></div>
                                </div>

                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Volume Paket</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        <div><label class="text-[10px] font-bold text-slate-400">GATEWAY</label><input type="number" id="rpt-gateway" class="metric-input w-full p-2 border rounded-lg text-sm text-right" placeholder="0"></div>
                                        <div><label class="text-[10px] font-bold text-slate-400">STAGING</label><input type="number" id="rpt-staging" class="metric-input w-full p-2 border rounded-lg text-sm text-right" placeholder="0"></div>
                                        <div><label class="text-[10px] font-bold text-slate-400">SAP</label><input type="number" id="rpt-sap" class="metric-input w-full p-2 border rounded-lg text-sm text-right" placeholder="0"></div>
                                        <div><label class="text-[10px] font-bold text-slate-400">JNE</label><input type="number" id="rpt-jne" class="metric-input w-full p-2 border rounded-lg text-sm text-right" placeholder="0"></div>
                                        <div class="bg-blue-100/50 p-2 rounded-lg border border-blue-100"><label class="text-[10px] font-bold text-blue-600">TOTAL</label><input type="text" id="rpt-total-paket" class="w-full bg-transparent font-bold text-lg text-blue-700 text-right outline-none" value="0" readonly></div>
                                    </div>
                                </div>

                                <div class="border border-slate-200 rounded-xl overflow-hidden">
                                    <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                                        <span class="text-xs font-bold text-slate-600 uppercase">Kehadiran Tim</span>
                                        <span class="text-xs bg-white px-2 py-1 rounded border border-slate-200">Total MPP: <strong id="display-total-mpp">0</strong></span>
                                    </div>
                                    <div class="max-h-64 overflow-y-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 text-slate-500 font-semibold text-xs sticky top-0">
                                                <tr><th class="p-2">Nama</th><th class="p-2 text-center bg-blue-50/50">S1</th><th class="p-2 text-center bg-blue-50/50">S2</th><th class="p-2 text-center bg-blue-50/50">S3</th><th class="p-2 text-center">Ket</th><th class="p-2"></th></tr>
                                            </thead>
                                            <tbody id="sorter-attendance-list" class="divide-y divide-slate-100"></tbody>
                                        </table>
                                    </div>
                                    <div class="p-2 bg-slate-50 border-t border-slate-200">
                                        <button type="button" onclick="window.addDwRow()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-white hover:border-blue-400 hover:text-blue-500 transition-all">+ Tambah DW Manual</button>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-3 pt-2">
                                    <button type="button" id="btn-cancel-report-edit" onclick="window.resetReportForm()" class="hidden text-slate-500 text-sm font-bold px-4 hover:bg-slate-100 rounded-lg">Batal</button>
                                    <button type="submit" id="btn-save-report" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-md transition-all active:scale-95">Simpan Laporan</button>
                                </div>
                            </form>
                        </div>

                        <!-- History Table -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase">
                                    <tr><th class="p-4">Tanggal</th><th class="p-4">HUB</th><th class="p-4 text-right">Paket</th><th class="p-4 text-right">MPP</th><th class="p-4 text-right">Prod</th><th class="p-4 text-right">Aksi</th></tr>
                                </thead>
                                <tbody id="rpt-history-body" class="divide-y divide-slate-100">
                                    <tr><td colspan="6" class="p-6 text-center text-slate-400">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SETTINGS -->
                    <div id="view-settings" class="content-view hidden fade-in-up space-y-6">
                        <div class="flex gap-2 border-b border-slate-200 overflow-x-auto">
                            <button onclick="window.switchSettingsTab('hubs')" id="tab-btn-hubs" class="px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600">Data HUB</button>
                            <button onclick="window.switchSettingsTab('employees')" id="tab-btn-employees" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Data Karyawan</button>
                            <button onclick="window.switchSettingsTab('config')" id="tab-btn-config" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Konfigurasi</button>
                        </div>

                        <!-- Hubs Content -->
                        <div id="tab-content-hubs" class="settings-tab-content">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                                <h3 class="font-bold text-lg mb-4">Kelola HUB</h3>
                                <form id="form-add-hub" class="flex flex-col md:flex-row gap-3 items-end">
                                    <input type="hidden" id="edit-hub-id">
                                    <div class="flex-1 w-full"><label class="text-xs font-bold text-slate-500 uppercase">Kode</label><input id="hub-code" type="text" class="w-full p-2 border rounded-lg text-sm uppercase" required></div>
                                    <div class="flex-[2] w-full"><label class="text-xs font-bold text-slate-500 uppercase">Nama HUB</label><input id="hub-name" type="text" class="w-full p-2 border rounded-lg text-sm" required></div>
                                    <div class="flex-1 w-full"><label class="text-xs font-bold text-slate-500 uppercase">Rate</label><input id="hub-rate" type="number" class="w-full p-2 border rounded-lg text-sm text-right"></div>
                                    <div class="flex gap-2">
                                        <button type="submit" id="btn-save-hub" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Simpan</button>
                                        <button type="button" id="btn-cancel-hub" onclick="window.resetHubForm()" class="hidden bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm">Batal</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                                <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase"><tr><th class="p-3">Kode</th><th class="p-3">Nama</th><th class="p-3 text-right">Rate</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="hub-table-body" class="divide-y divide-slate-100"></tbody></table>
                            </div>
                        </div>

                        <!-- Employees Content -->
                        <div id="tab-content-employees" class="settings-tab-content hidden">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
                                <h3 class="font-bold text-lg mb-4" id="form-user-title">Tambah Karyawan</h3>
                                <form id="form-add-user" class="space-y-4">
                                    <input type="hidden" id="edit-user-id">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">NIK</label><input id="user-nik" type="text" class="w-full p-2 border rounded-lg text-sm" required></div>
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">Nama</label><input id="user-name" type="text" class="w-full p-2 border rounded-lg text-sm" required></div>
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">HUB</label><select id="user-hub" class="w-full p-2 border rounded-lg text-sm bg-white" required><option>Loading...</option></select></div>
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label><select id="user-role" class="w-full p-2 border rounded-lg text-sm bg-white"><option value="sorter">Sorter</option><option value="leader">Leader</option><option value="dw">DW</option></select></div>
                                    </div>
                                    <div class="flex items-center gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <div class="flex items-center gap-2"><input type="checkbox" id="user-can-login" onchange="window.togglePasswordInput()" class="custom-checkbox"><label for="user-can-login" class="text-sm font-medium">Bisa Login?</label></div>
                                        <input type="text" id="user-pass" class="flex-1 p-2 border rounded-lg text-sm hidden" placeholder="Set Password Login">
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="submit" id="btn-save-user" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-bold">Simpan Data</button>
                                        <button type="button" id="btn-cancel-edit" onclick="window.resetUserForm()" class="hidden bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-sm font-medium">Batal</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                                <div class="p-3 bg-slate-50 text-xs font-bold text-slate-500 border-b border-slate-100" id="user-count">Total: 0</div>
                                <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase"><tr><th class="p-3">Nama</th><th class="p-3">HUB</th><th class="p-3">Role</th><th class="p-3">Login</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="user-table-body" class="divide-y divide-slate-100"></tbody></table>
                            </div>
                        </div>

                        <!-- Config Content -->
                        <div id="tab-content-config" class="settings-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 class="font-bold text-lg mb-4">Keamanan</h3>
                                    <form id="form-config-security" class="space-y-4">
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">Pass Admin</label><input id="config-admin-pass" type="text" class="w-full p-2 border rounded-lg text-sm"></div>
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">Kode Otorisasi</label><input id="config-secure-code" type="text" class="w-full p-2 border rounded-lg text-sm font-mono tracking-widest"></div>
                                        <button type="submit" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-bold">Update</button>
                                    </form>
                                </div>
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 class="font-bold text-lg mb-4">Biaya</h3>
                                    <form id="form-config-cost" class="space-y-4">
                                        <div><label class="text-xs font-bold text-slate-500 uppercase">Rate DW</label><input id="config-dw-rate" type="number" class="w-full p-2 border rounded-lg text-sm text-right"></div>
                                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-bold">Update Biaya</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-20 hidden lg:hidden backdrop-blur-sm"></div>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        // Import Firebase Version 11.6.1 (Stable for this env)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, onSnapshot, orderBy, limit, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG & INIT
        let firebaseConfig, APP_ID;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'daily-report-v3'; 
        } else {
            // Fallback for visual testing only
            firebaseConfig = { apiKey: "AIzaSy...", authDomain: "test.firebaseapp.com", projectId: "test" }; 
            APP_ID = 'daily-report-local';
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let state = {
            user: null, role: null, userData: null, loginTab: 'leader',
            currentView: 'dashboard', hubs: [], employees: [],
            config: { secure_code: '123456', admin_password: 'admin123', dw_rate: 0 },
            chartAnnual: null, chartDaily: null
        };

        // --- GLOBAL WINDOW FUNCTIONS (To make buttons click work) ---
        
        window.switchLoginTab = (tab) => {
            state.loginTab = tab;
            ['sorter', 'leader', 'admin'].forEach(t => { 
                const el = document.getElementById(`tab-login-${t}`); 
                el.className = (t===tab) ? "py-2 text-xs font-medium rounded-lg transition-all login-tab-active" : "py-2 text-xs font-medium rounded-lg transition-all login-tab-inactive"; 
            });
            document.getElementById('login-error').classList.add('hidden'); 
            document.getElementById('login-nik').value = ''; 
            document.getElementById('login-pass').value = '';
            document.getElementById('field-nik').classList.toggle('hidden', tab === 'admin'); 
            document.getElementById('field-pass').classList.toggle('hidden', tab === 'sorter');
        };

        window.handleLogout = () => {
            if(confirm('Yakin ingin keluar?')) {
                localStorage.removeItem('userRole'); localStorage.removeItem('userData'); window.location.reload();
            }
        };

        window.navigateTo = (viewId) => {
            state.currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.target === viewId;
                el.classList.toggle('bg-slate-800', isActive); el.classList.toggle('text-white', isActive);
                el.classList.toggle('text-slate-300', !isActive);
            });
            document.querySelectorAll('.content-view').forEach(el => el.classList.add('hidden'));
            const view = document.getElementById(`view-${viewId}`);
            if(view) { view.classList.remove('hidden'); view.classList.remove('fade-in-up'); void view.offsetWidth; view.classList.add('fade-in-up'); }
            
            if (viewId === 'dashboard') window.loadDashboardStats(); 
            if (viewId === 'reports') window.loadReportsView(); 
            if (viewId === 'settings' && state.role === 'admin') window.loadSettings();
            
            // Close mobile menu
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        };

        window.showToast = (msg, type='success') => {
            const el = document.getElementById('dynamic-island');
            document.getElementById('di-msg').textContent = msg;
            const ic = document.getElementById('di-icon-container');
            const icon = document.getElementById('di-icon');
            if(type==='success') { ic.className="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white"; icon.setAttribute('data-lucide', 'check'); }
            else { ic.className="flex items-center justify-center w-6 h-6 rounded-full bg-red-500 text-white"; icon.setAttribute('data-lucide', 'x'); }
            try{lucide.createIcons();}catch(e){}
            el.classList.add('active'); setTimeout(()=>{el.classList.remove('active')}, 3000);
        };

        // --- DASHBOARD LOGIC ---
        window.loadDashboardStats = async () => {
            const btn = document.getElementById('btn-filter-dash');
            const originalText = btn.innerHTML;
            btn.textContent = "Loading..."; btn.disabled = true;
            
            const start = document.getElementById('dash-start-date').value;
            const end = document.getElementById('dash-end-date').value;
            let hubFilter = state.role === 'admin' ? document.getElementById('dash-hub-select')?.value : state.userData?.hub_code;

            try {
                if(!start || !end) throw new Error("Pilih tanggal");
                const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), where("date", ">=", start), where("date", "<=", end));
                const snap = await getDocs(q);
                let reports = []; snap.forEach(d => { const r=d.data(); if(!hubFilter || hubFilter==="" || r.hub === hubFilter) reports.push(r); });
                
                // Calc stats
                let tPaket=0, tMpp=0, tCost=0;
                const daily={};
                reports.forEach(r => {
                    tPaket += (r.total_paket||0); tMpp += (r.total_mpp||0); tCost += (r.est_cost||0);
                    const d = r.date; if(!daily[d]) daily[d]={date:d, mpp:0, paket:0, cost:0};
                    daily[d].mpp+=r.total_mpp; daily[d].paket+=r.total_paket; daily[d].cost+=r.est_cost;
                });

                document.getElementById('kpi-total-paket').textContent = tPaket.toLocaleString('id-ID');
                document.getElementById('kpi-total-mpp').textContent = tMpp.toLocaleString('id-ID');
                document.getElementById('kpi-productivity').textContent = tMpp > 0 ? Math.round(tPaket/tMpp).toLocaleString('id-ID') : 0;
                document.getElementById('kpi-total-cost').textContent = "Rp " + tCost.toLocaleString('id-ID');

                // Render Table
                const tbody = document.getElementById('dash-table-daily');
                tbody.innerHTML = Object.values(daily).sort((a,b)=>b.date.localeCompare(a.date)).map(d => 
                    `<tr class="hover:bg-slate-50 border-b border-slate-50"><td class="p-4 font-medium">${d.date}</td><td class="p-4 text-right text-blue-600 font-bold">${d.paket.toLocaleString('id-ID')}</td><td class="p-4 text-right">${d.mpp}</td><td class="p-4 text-right text-green-600 font-bold">${d.mpp>0?Math.round(d.paket/d.mpp):0}</td><td class="p-4 text-right text-slate-500 text-xs">Rp ${d.cost.toLocaleString('id-ID')}</td></tr>`
                ).join('');
                if(!tbody.innerHTML) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">Tidak ada data di rentang tanggal ini.</td></tr>';

                // Chart dummy render (simplified)
                renderChart(document.getElementById('annualChart'), Object.keys(daily), Object.values(daily).map(x=>x.paket), 'chartAnnual');
                renderChart(document.getElementById('dailyChart'), Object.keys(daily), Object.values(daily).map(x=>x.mpp), 'chartDaily');

            } catch(e) { window.showToast("Gagal memuat: " + e.message, "error"); }
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        function renderChart(canvas, labels, data, key) {
            const ctx = canvas.getContext('2d'); if(state[key]) state[key].destroy();
            state[key] = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Data', data: data, backgroundColor: '#3b82f6', borderRadius:4 }] }, options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false}} } });
        }

        // --- REPORT LOGIC ---
        window.loadReportsView = async () => {
            const d = new Date(); document.getElementById('rpt-date').valueAsDate = d;
            let hCode = state.userData?.hub_code;
            const container = document.getElementById('rpt-hub-container');
            
            if(state.role === 'admin') {
                if(state.hubs.length === 0) {
                    const snap = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'));
                    state.hubs = snap.docs.map(d => d.data());
                }
                const opts = `<option value="">Pilih HUB...</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name}</option>`).join('');
                container.innerHTML = `<select id="rpt-hub-select" class="w-full p-2.5 border rounded-xl text-sm" onchange="window.loadReportsView()">${opts}</select>`;
                hCode = document.getElementById('rpt-hub-select')?.value;
            } else {
                container.innerHTML = `<input type="text" id="rpt-hub-static" value="${hCode}" class="w-full p-2.5 bg-slate-100 border rounded-xl text-sm font-bold text-slate-500" readonly>`;
            }

            const tbody = document.getElementById('sorter-attendance-list');
            if(hCode) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Memuat karyawan...</td></tr>';
                const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("hub_code", "==", hCode));
                const snap = await getDocs(q);
                tbody.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data(); if(u.role === 'admin') return;
                    const row = document.createElement('tr'); row.className = "border-b border-slate-50 hover:bg-slate-50";
                    row.innerHTML = `<td class="p-2 font-medium text-slate-700" data-name="${u.name}" data-is-db="true">${u.name} <span class="text-[10px] text-slate-400">(${u.role})</span></td>${window.generateAttCols(d.id)}<td class="p-2"></td>`;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">Pilih HUB terlebih dahulu.</td></tr>';
            }
            window.loadMyReports();
        };

        window.generateAttCols = (uid) => {
            return ['s1','s2','s3','i','s','a'].map(v => `<td class="p-2 text-center"><input type="radio" name="att_${uid}" value="${v}" class="custom-radio attendance-radio" onclick="window.calculateReportTotals()"></td>`).join('') + `<td class="p-2"><input type="text" class="w-full p-1 border rounded text-xs att-remarks"></td>`;
        };

        window.calculateReportTotals = () => {
            const vals = ['gateway','staging','sap','jne'].map(k => Number(document.getElementById(`rpt-${k}`).value)||0);
            const total = vals.reduce((a,b)=>a+b,0);
            document.getElementById('rpt-total-paket').value = total.toLocaleString('id-ID');
            
            let mpp = 0;
            document.querySelectorAll('.attendance-radio:checked').forEach(r => {
                if(['s1','s2','s3'].includes(r.value)) {
                    // Check if row is leader
                    const row = r.closest('tr');
                    if(!row.textContent.toLowerCase().includes('leader')) mpp++;
                }
            });
            document.getElementById('display-total-mpp').textContent = mpp;
            document.getElementById('rpt-productivity').value = mpp>0 ? Math.round(total/mpp).toLocaleString('id-ID') : 0;
        };

        window.addDwRow = () => {
            const uid = 'dw_' + Date.now();
            const tbody = document.getElementById('sorter-attendance-list');
            const row = document.createElement('tr'); row.className = "border-b border-slate-50 animate-in fade-in";
            row.innerHTML = `<td class="p-2"><input type="text" class="w-full p-1 border rounded text-sm dw-name-input" placeholder="Nama DW..." data-id="${uid}"></td>${window.generateAttCols(uid)}<td class="p-2 text-center"><button onclick="this.closest('tr').remove();window.calculateReportTotals()" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button></td>`;
            tbody.appendChild(row);
            lucide.createIcons();
        };

        window.loadMyReports = async () => {
            const tbody = document.getElementById('rpt-history-body');
            tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center"><div class="animate-spin w-4 h-4 border-2 border-blue-500 rounded-full border-t-transparent inline-block"></div> Memuat...</td></tr>';
            try {
                const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), orderBy("date", "desc"), limit(10));
                const snap = await getDocs(q);
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-slate-400">Belum ada laporan.</td></tr>'; return; }
                tbody.innerHTML = '';
                snap.forEach(d => {
                    const r = d.data();
                    const tr = document.createElement('tr'); tr.className = "border-b border-slate-50 hover:bg-slate-50";
                    // Logic tombol delete/edit
                    let aksi = '';
                    if(state.role === 'admin' || (state.userData && r.hub === state.userData.hub_code)) {
                        aksi = `<button onclick='window.deleteReport("${d.id}")' class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    }
                    tr.innerHTML = `<td class="p-4 font-medium">${r.date}</td><td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${r.hub}</span></td><td class="p-4 text-right font-bold text-blue-600">${r.total_paket.toLocaleString('id-ID')}</td><td class="p-4 text-right">${r.total_mpp}</td><td class="p-4 text-right text-green-600 font-bold">${r.productivity.toLocaleString('id-ID')}</td><td class="p-4 text-right">${aksi}</td>`;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch(e) { tbody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-400">Error: ${e.message}</td></tr>`; }
        };

        window.deleteReport = (id) => {
            if(confirm("Hapus laporan ini permanen?")) {
                deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports', id))
                .then(() => { window.showToast("Terhapus"); window.loadMyReports(); })
                .catch(e => window.showToast("Gagal: " + e.message, "error"));
            }
        };

        // --- SETTINGS LOGIC ---
        window.switchSettingsTab = (tab) => {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            ['hubs', 'employees', 'config'].forEach(k => {
                const btn = document.getElementById(`tab-btn-${k}`);
                btn.className = (k===tab) ? "px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors" : "px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors";
            });
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
        };

        window.loadSettings = () => {
            // Load Hubs Table
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), snap => {
                state.hubs = snap.docs.map(d => ({id:d.id, ...d.data()}));
                const tbody = document.getElementById('hub-table-body');
                tbody.innerHTML = state.hubs.map(h => `<tr class="border-b border-slate-50"><td class="p-3 font-mono font-bold">${h.code}</td><td class="p-3">${h.name}</td><td class="p-3 text-right">${h.sorter_rate}</td><td class="p-3 text-right"><button onclick="window.deleteDocItem('hubs','${h.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
                lucide.createIcons();
            });
            // Load Employees
            onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), snap => {
                state.employees = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(u => u.role !== 'admin');
                document.getElementById('user-count').textContent = `Total: ${state.employees.length}`;
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = state.employees.map(u => `<tr class="border-b border-slate-50"><td class="p-3"><div class="font-bold">${u.name}</div><div class="text-xs text-slate-400 font-mono">${u.nik}</div></td><td class="p-3"><span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-xs font-bold">${u.hub_code}</span></td><td class="p-3 capitalize">${u.role}</td><td class="p-3">${u.can_login?'✅':'❌'}</td><td class="p-3 text-right"><button onclick="window.deleteDocItem('users','${u.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
                lucide.createIcons();
            });
        };

        window.deleteDocItem = (col, id) => {
            if(confirm("Hapus data ini?")) deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id));
        };

        window.togglePasswordInput = () => {
            const chk = document.getElementById('user-can-login');
            const pass = document.getElementById('user-pass');
            if(chk.checked) { pass.classList.remove('hidden'); pass.required = true; } 
            else { pass.classList.add('hidden'); pass.required = false; }
        };

        window.resetHubForm = () => { document.getElementById('form-add-hub').reset(); document.getElementById('edit-hub-id').value=''; document.getElementById('btn-cancel-hub').classList.add('hidden'); document.getElementById('btn-save-hub').textContent="Simpan"; };
        window.resetUserForm = () => { document.getElementById('form-add-user').reset(); document.getElementById('edit-user-id').value=''; document.getElementById('btn-cancel-edit').classList.add('hidden'); document.getElementById('btn-save-user').textContent="Simpan Data"; window.togglePasswordInput(); };

        // --- FORM SUBMISSIONS ---
        document.getElementById('form-daily-report').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-report'); btn.disabled=true; btn.textContent="Menyimpan...";
            try {
                const hub = state.role === 'admin' ? document.getElementById('rpt-hub-select').value : document.getElementById('rpt-hub-static').value;
                if(!hub) throw new Error("Pilih HUB");
                
                const att = []; let mpp=0;
                document.querySelectorAll('#sorter-attendance-list tr').forEach(row => {
                    const chk = row.querySelector('.attendance-radio:checked');
                    if(chk) {
                        const nameEl = row.querySelector('td[data-name]');
                        const name = nameEl ? nameEl.dataset.name : row.querySelector('.dw-name-input').value;
                        const remarks = row.querySelector('.att-remarks').value;
                        att.push({ name, status: chk.value, remarks });
                        if(['s1','s2','s3'].includes(chk.value) && !row.textContent.toLowerCase().includes('leader')) mpp++;
                    }
                });

                const total = parseInt(document.getElementById('rpt-total-paket').value.replace(/\./g,'')) || 0;
                const data = {
                    date: document.getElementById('rpt-date').value,
                    hub: hub,
                    gateway: Number(document.getElementById('rpt-gateway').value)||0,
                    staging: Number(document.getElementById('rpt-staging').value)||0,
                    sap: Number(document.getElementById('rpt-sap').value)||0,
                    jne: Number(document.getElementById('rpt-jne').value)||0,
                    total_paket: total,
                    total_mpp: mpp,
                    productivity: mpp>0 ? Math.round(total/mpp) : 0,
                    attendance_data: att,
                    est_cost: 0, // Simplified for brevity
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), data);
                window.showToast("Laporan Tersimpan");
                document.getElementById('form-daily-report').reset();
                window.loadMyReports();
            } catch(e) { window.showToast(e.message, "error"); }
            finally { btn.disabled=false; btn.textContent="Simpan Laporan"; }
        });

        document.getElementById('form-add-hub').addEventListener('submit', async(e) => {
            e.preventDefault();
            const data = { 
                code: document.getElementById('hub-code').value.toUpperCase(),
                name: document.getElementById('hub-name').value,
                sorter_rate: Number(document.getElementById('hub-rate').value)||0
            };
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), data);
            window.resetHubForm(); window.showToast("HUB Ditambah");
        });

        document.getElementById('form-add-user').addEventListener('submit', async(e) => {
            e.preventDefault();
            const data = {
                nik: document.getElementById('user-nik').value,
                name: document.getElementById('user-name').value,
                hub_code: document.getElementById('user-hub').value,
                role: document.getElementById('user-role').value,
                can_login: document.getElementById('user-can-login').checked,
                password: document.getElementById('user-pass').value
            };
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), data);
            window.resetUserForm(); window.showToast("Karyawan Ditambah");
        });

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nik = document.getElementById('login-nik').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const tab = state.loginTab;
            const errDiv = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');
            
            btn.disabled = true; btn.innerHTML = "Memproses..."; errDiv.classList.add('hidden');

            try {
                // Check if Anonymous Auth is enabled in Firebase Console (Crucial step often missed)
                if(!auth.currentUser) await signInAnonymously(auth);
                
                // Admin Login
                if(tab === 'admin') {
                    if(!state.config.admin_password) {
                        const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'config'));
                        if(snap.exists()) state.config = snap.data();
                    }
                    if(pass === state.config.admin_password) {
                        state.role = 'admin'; state.userData = { name: 'Administrator', role: 'admin' };
                        saveSession(); window.showApp();
                    } else throw new Error("Password Admin Salah");
                } 
                // User Login
                else {
                    const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("nik", "==", nik));
                    const snap = await getDocs(q);
                    if(snap.empty) throw new Error("NIK tidak ditemukan");
                    const user = snap.docs[0].data();
                    if(tab === 'leader') {
                        if(!user.can_login) throw new Error("User tidak punya akses login");
                        if(user.password !== pass) throw new Error("Password salah");
                    }
                    state.role = tab; state.userData = user;
                    saveSession(); window.showApp();
                }
            } catch(e) {
                errDiv.classList.remove('hidden');
                document.getElementById('login-error-text').textContent = e.code === 'auth/configuration-not-found' ? "Aktifkan Anonymous Auth di Firebase Console" : e.message;
            } finally {
                btn.disabled = false; btn.innerHTML = '<span>Masuk Aplikasi</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>';
            }
        });

        function saveSession() {
            localStorage.setItem('userRole', state.role);
            localStorage.setItem('userData', JSON.stringify(state.userData));
        }

        window.showApp = () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name-display').textContent = state.userData?.name || 'Admin';
            document.getElementById('user-role-display').textContent = state.role;
            
            const isAdmin = state.role === 'admin';
            document.getElementById('menu-settings').classList.toggle('hidden', !isAdmin);
            // Auto setup dates
            const now = new Date();
            document.getElementById('dash-end-date').valueAsDate = now;
            document.getElementById('dash-start-date').valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1);
            
            window.navigateTo('dashboard');
        };

        // Init Auth Listener
        onAuthStateChanged(auth, (u) => {
            state.user = u;
            // Auto login logic
            const savedRole = localStorage.getItem('userRole');
            if(u && savedRole) {
                state.role = savedRole;
                state.userData = JSON.parse(localStorage.getItem('userData'));
                window.showApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
            // Hide loading
            setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 500);
        });

        // Setup Sidebar Mobile
        document.getElementById('open-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
        });
        const closeMenu = () => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        };
        document.getElementById('close-sidebar').addEventListener('click', closeMenu);
        document.getElementById('sidebar-overlay').addEventListener('click', closeMenu);
        
        // Listen to metric inputs
        document.querySelectorAll('.metric-input').forEach(i => i.addEventListener('input', window.calculateReportTotals));

        // Initial Load icons
        lucide.createIcons();
    </script>
</body>
</html>