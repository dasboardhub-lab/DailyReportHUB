<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report Team - Enhanced UX</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Modern Font */
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Smooth Transitions */
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dynamic Island Notification */
        #dynamic-island {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translate(-50%, -150%) scale(0.9);
            opacity: 0;
        }
        #dynamic-island.active {
            transform: translate(-50%, 20px) scale(1);
            opacity: 1;
        }

        /* Checkbox & Radio */
        .custom-radio { width: 1.15rem; height: 1.15rem; cursor: pointer; accent-color: #2563eb; }
        .custom-checkbox { width: 1.25rem; height: 1.25rem; cursor: pointer; accent-color: #2563eb; }
        
        /* Table Sticky Header */
        thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Login Tabs */
        .login-tab-active { background-color: #eff6ff; color: #2563eb; border-color: #2563eb; font-weight: 600; }
        .login-tab-inactive { color: #64748b; border-color: transparent; }
        .login-tab-inactive:hover { background-color: #f8fafc; color: #334155; }

        /* Input Number Styling */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); border-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 selection:bg-blue-100 selection:text-blue-700">

    <!-- DYNAMIC ISLAND NOTIFICATION (iOS Style) -->
    <div id="dynamic-island" class="fixed top-0 left-1/2 z-[100] bg-slate-900 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[300px] justify-center border border-slate-700/50">
        <div id="di-icon-container" class="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white">
            <i id="di-icon" data-lucide="check" class="w-4 h-4"></i>
        </div>
        <span id="di-msg" class="text-sm font-medium tracking-wide">Action Successful</span>
    </div>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 transform transition-all scale-95 duration-300" id="confirm-content">
            <div class="text-center mb-4">
                <div class="bg-yellow-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                    <i data-lucide="alert-circle" class="text-yellow-600 w-7 h-7"></i>
                </div>
                <h3 id="confirm-title" class="font-bold text-lg text-slate-800">Konfirmasi</h3>
                <p id="confirm-desc" class="text-sm text-slate-500 mt-1 leading-relaxed">Apakah Anda yakin ingin melakukan tindakan ini?</p>
            </div>
            <div class="flex gap-3">
                <button id="btn-confirm-no" class="flex-1 py-2.5 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl text-sm font-medium transition-colors">Batal</button>
                <button id="btn-confirm-yes" class="flex-1 py-2.5 bg-blue-600 text-white hover:bg-blue-700 rounded-xl text-sm font-medium transition-colors shadow-lg shadow-blue-200">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- SECURITY MODAL -->
    <div id="security-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-80 transform transition-all scale-100 animate-in fade-in zoom-in-95 duration-200">
            <div class="text-center mb-5">
                <div class="bg-red-50 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 border border-red-100">
                    <i data-lucide="shield-lock" class="text-red-600 w-7 h-7"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800">Otorisasi Diperlukan</h3>
                <p class="text-xs text-slate-500 mt-1">Masukkan Kode Keamanan Admin</p>
            </div>
            <input type="password" id="input-secure-code" class="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl mb-4 text-center tracking-[0.5em] font-bold text-lg focus:bg-white transition-colors" placeholder="••••">
            <div id="secure-error" class="text-xs text-red-500 text-center mb-3 hidden bg-red-50 py-1 rounded-lg">Kode keamanan salah!</div>
            <div class="flex gap-2">
                <button id="btn-cancel-secure" class="flex-1 py-2 text-slate-500 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 text-sm font-medium">Batal</button>
                <button id="btn-confirm-secure" class="flex-1 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium text-sm shadow-md shadow-red-200">Verifikasi</button>
            </div>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center">
            <div class="relative w-16 h-16 mb-4">
                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p class="text-slate-500 text-sm font-medium tracking-wide animate-pulse">Memuat Sistem...</p>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen bg-slate-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-100 fade-in-up">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-tr from-blue-600 to-blue-400 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200 transform rotate-3">
                    <i data-lucide="file-bar-chart-2" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Daily Report Tim</h1>
                <p class="text-slate-500 text-sm mt-1">Sistem Laporan Harian Terintegrasi</p>
            </div>

            <!-- Login Tabs -->
            <div class="grid grid-cols-3 gap-1 mb-6 p-1 bg-slate-100 rounded-xl border border-slate-200">
                <button onclick="switchLoginTab('sorter')" id="tab-login-sorter" class="py-2.5 text-xs font-medium rounded-lg transition-all text-center login-tab-inactive">Sorter</button>
                <button onclick="switchLoginTab('leader')" id="tab-login-leader" class="py-2.5 text-xs font-medium rounded-lg transition-all text-center login-tab-active bg-white shadow-sm text-blue-600">Leader</button>
                <button onclick="switchLoginTab('admin')" id="tab-login-admin" class="py-2.5 text-xs font-medium rounded-lg transition-all text-center login-tab-inactive">Admin</button>
            </div>

            <form id="login-form" class="space-y-5">
                <div id="field-nik">
                    <label class="block text-xs font-semibold text-slate-700 mb-2 uppercase tracking-wide">Username / NIK</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                            <i data-lucide="user" class="h-5 w-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                        </div>
                        <input type="text" id="login-nik" class="block w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400 text-sm font-medium" placeholder="Masukkan NIK">
                    </div>
                </div>

                <div id="field-pass">
                    <label class="block text-xs font-semibold text-slate-700 mb-2 uppercase tracking-wide">Password</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="h-5 w-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                        </div>
                        <input type="password" id="login-pass" class="block w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400 text-sm font-medium" placeholder="Masukkan Password">
                    </div>
                </div>

                <div id="login-error" class="bg-red-50 text-red-600 text-xs p-3 rounded-lg border border-red-100 text-center hidden flex items-center justify-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> <span id="login-error-text"></span>
                </div>

                <button type="submit" id="btn-login" class="w-full py-3.5 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all shadow-lg shadow-blue-200 disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center gap-2 mt-2">
                    <span>Masuk Aplikasi</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
                
                <p class="text-xs text-center text-slate-400 mt-6" id="login-hint">
                    Masuk sebagai Leader/Staf (Akses Penuh)
                </p>
            </form>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="flex h-screen overflow-hidden hidden bg-slate-50">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-72 bg-slate-900 text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-300 cubic-bezier(0.4, 0, 0.2, 1) flex flex-col h-full shadow-2xl lg:shadow-none">
            <div class="p-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-400 rounded-xl flex items-center justify-center font-bold shadow-lg shadow-blue-900/50">DR</div>
                    <span class="font-bold text-xl tracking-tight">DailyReport</span>
                </div>
                <button id="close-sidebar" class="lg:hidden text-slate-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-slate-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <nav class="flex-1 px-4 space-y-2 overflow-y-auto py-4">
                <button onclick="navigateTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white group" data-target="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:text-blue-400 transition-colors"></i>
                    <span class="font-medium text-sm">Dashboard</span>
                </button>
                <button onclick="navigateTo('reports')" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white group" data-target="reports">
                    <i data-lucide="file-text" class="w-5 h-5 group-hover:text-blue-400 transition-colors"></i>
                    <span class="font-medium text-sm">Laporan Harian</span>
                </button>
                <button onclick="navigateTo('settings')" id="menu-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white hidden group" data-target="settings">
                    <i data-lucide="settings" class="w-5 h-5 group-hover:text-blue-400 transition-colors"></i>
                    <span class="font-medium text-sm">Pengaturan</span>
                </button>
            </nav>

            <div class="p-4 mt-auto">
                <div class="bg-slate-800/50 rounded-xl p-4 mb-3 backdrop-blur-sm border border-slate-700/50">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-700 p-2 rounded-lg">
                            <i data-lucide="user" class="text-blue-400 w-5 h-5"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p id="user-name-display" class="text-sm font-semibold text-white truncate">User</p>
                            <p id="user-role-display" class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">ROLE</p>
                        </div>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-800 hover:bg-red-600/90 text-slate-300 hover:text-white rounded-xl transition-all text-sm font-medium group">
                    <i data-lucide="log-out" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                    <span>Keluar Aplikasi</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200 lg:hidden flex-shrink-0 sticky top-0 z-20">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="open-sidebar" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg active:scale-95 transition-transform">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <span class="font-bold text-slate-800">Daily Report</span>
                    </div>
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-blue-600 font-bold text-xs">DR</span>
                    </div>
                </div>
            </header>

            <!-- Content Views -->
            <main class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
                <div class="max-w-[1400px] mx-auto pb-10">
                    
                    <!-- VIEW: DASHBOARD -->
                    <div id="view-dashboard" class="content-view hidden space-y-6 fade-in-up">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-2">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">Dashboard</h2>
                                <p class="text-slate-500 text-sm">Ringkasan performa operasional tim.</p>
                            </div>
                        </div>

                        <!-- Filter Section -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-5 items-end">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Mulai Tanggal</label>
                                    <input type="date" id="dash-start-date" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all bg-slate-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Sampai Tanggal</label>
                                    <input type="date" id="dash-end-date" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all bg-slate-50">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Filter HUB</label>
                                    <div id="dash-hub-container">
                                        <div class="animate-pulse h-10 bg-slate-100 rounded-xl w-full"></div>
                                    </div>
                                </div>
                                <div>
                                    <button onclick="loadDashboardStats()" id="btn-filter-dash" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-xl transition-all shadow-md shadow-blue-200 flex items-center justify-center gap-2 active:scale-95">
                                        <i data-lucide="filter" class="w-4 h-4"></i> Terapkan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                            <!-- Card Item -->
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow group">
                                <div class="flex justify-between items-start">
                                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total Paket</div>
                                    <div class="p-1.5 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="package" class="w-4 h-4"></i></div>
                                </div>
                                <div id="kpi-total-paket" class="text-2xl font-bold text-slate-800 mt-2 group-hover:text-blue-600 transition-colors">0</div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow group">
                                <div class="flex justify-between items-start">
                                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total MPP</div>
                                    <div class="p-1.5 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="users" class="w-4 h-4"></i></div>
                                </div>
                                <div id="kpi-total-mpp" class="text-2xl font-bold text-slate-800 mt-2">0</div>
                                <div class="text-[10px] text-slate-400 mt-1">Sorter + DW Only</div>
                            </div>

                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow group">
                                <div class="flex justify-between items-start">
                                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Produktivitas</div>
                                    <div class="p-1.5 bg-green-50 rounded-lg text-green-600"><i data-lucide="activity" class="w-4 h-4"></i></div>
                                </div>
                                <div id="kpi-productivity" class="text-2xl font-bold text-green-600 mt-2">0</div>
                                <div class="text-[10px] text-slate-400 mt-1">Avg (Paket/Orang)</div>
                            </div>

                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow group">
                                <div class="flex justify-between items-start">
                                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Total Cost</div>
                                    <div class="p-1.5 bg-red-50 rounded-lg text-red-600"><i data-lucide="dollar-sign" class="w-4 h-4"></i></div>
                                </div>
                                <div id="kpi-total-cost" class="text-xl font-bold text-red-600 mt-2">0</div>
                            </div>

                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow group">
                                <div class="flex justify-between items-start">
                                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">CPP (AVG)</div>
                                    <div class="p-1.5 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="bar-chart-2" class="w-4 h-4"></i></div>
                                </div>
                                <div id="kpi-cpp" class="text-xl font-bold text-purple-600 mt-2">0</div>
                                <div class="text-[10px] text-slate-400 mt-1">Cost Per Packet</div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i> Tren Bulanan</h3>
                                <div class="relative h-64 w-full">
                                    <canvas id="annualChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="bar-chart" class="w-4 h-4 text-green-500"></i> Tren Harian</h3>
                                <div class="relative h-64 w-full">
                                    <canvas id="dailyChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Tables Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Detailed Daily Table -->
                            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-700">Rincian Pertanggal</h3>
                                </div>
                                <div class="overflow-x-auto max-h-[400px]">
                                    <table class="w-full text-left text-sm whitespace-nowrap">
                                        <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider sticky top-0">
                                            <tr>
                                                <th class="p-4 bg-slate-50">Tanggal</th>
                                                <th class="p-4 bg-slate-50 text-right">MPP</th>
                                                <th class="p-4 bg-slate-50 text-right">Outbound</th>
                                                <th class="p-4 bg-slate-50 text-right">Prod.</th>
                                                <th class="p-4 bg-slate-50 text-right">Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dash-table-daily" class="divide-y divide-slate-100">
                                            <tr><td colspan="5" class="p-8 text-center text-slate-400">
                                                <div class="animate-pulse flex flex-col items-center">
                                                    <div class="h-2 w-24 bg-slate-200 rounded mb-2"></div>
                                                    <div class="h-2 w-16 bg-slate-200 rounded"></div>
                                                </div>
                                            </td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Breakdown Per HUB Table -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                <div class="p-5 border-b border-slate-100 bg-slate-50/50">
                                    <h3 class="font-bold text-slate-700">Performa per HUB</h3>
                                </div>
                                <div class="overflow-x-auto max-h-[400px]">
                                    <table class="w-full text-left text-sm whitespace-nowrap">
                                        <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider sticky top-0">
                                            <tr>
                                                <th class="p-4 bg-slate-50">HUB</th>
                                                <th class="p-4 bg-slate-50 text-right">Outbound</th>
                                                <th class="p-4 bg-slate-50 text-right">Prod.</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dash-table-hub" class="divide-y divide-slate-100">
                                            <tr><td colspan="3" class="p-8 text-center text-slate-400">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: REPORTS -->
                    <div id="view-reports" class="content-view hidden space-y-6 fade-in-up">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">Laporan Harian</h2>
                                <p class="text-slate-500 text-sm">Input dan kelola laporan operasional.</p>
                            </div>
                            <span id="current-date-display" class="mt-2 md:mt-0 text-xs font-medium text-slate-500 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm"></span>
                        </div>
                        
                        <!-- Form Input -->
                        <div id="section-input-report" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-blue-600"></div>
                            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <div class="p-1.5 bg-blue-100 rounded-lg"><i data-lucide="plus" class="w-4 h-4 text-blue-600"></i></div>
                                <span id="form-report-title">Input Laporan Operasional</span>
                            </h3>
                            
                            <form id="form-daily-report" class="space-y-6">
                                <input type="hidden" id="edit-report-id"> 
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 p-5 bg-slate-50 rounded-xl border border-slate-100">
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">Tanggal Laporan</label>
                                        <input type="date" id="rpt-date" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all bg-white" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase tracking-wide">HUB Operasional</label>
                                        <div id="rpt-hub-container">
                                            <input type="text" id="rpt-hub-static" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm bg-slate-100 text-slate-500 font-bold cursor-not-allowed" placeholder="Auto" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Metric Inputs -->
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i> Metrik Operasional
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div class="group">
                                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Gateway</label>
                                            <input type="number" id="rpt-gateway" class="metric-input w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Staging</label>
                                            <input type="number" id="rpt-staging" class="metric-input w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">SAP</label>
                                            <input type="number" id="rpt-sap" class="metric-input w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">JNE</label>
                                            <input type="number" id="rpt-jne" class="metric-input w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0" min="0">
                                        </div>
                                        <div class="bg-blue-50 p-2.5 rounded-xl border border-blue-100">
                                            <label class="block text-[10px] font-bold text-blue-600 mb-1 uppercase">Total Paket</label>
                                            <input type="text" id="rpt-total-paket" class="w-full bg-transparent font-bold text-xl text-blue-700 text-right outline-none cursor-default" value="0" readonly>
                                        </div>
                                    </div>
                                    <div class="mt-3 bg-green-50 p-3 rounded-xl border border-green-100 flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="activity" class="w-4 h-4 text-green-600"></i>
                                            <div>
                                                <p class="text-xs font-bold text-green-800">PRODUKTIVITAS TIM</p>
                                                <p class="text-[10px] text-green-600">Total Paket / Total MPP (Sorter+DW)</p>
                                            </div>
                                        </div>
                                        <input type="text" id="rpt-productivity" class="bg-transparent font-bold text-2xl text-green-700 text-right outline-none w-32 cursor-default" value="0" readonly>
                                    </div>
                                </div>

                                <!-- Attendance -->
                                <div>
                                    <div class="flex justify-between items-end mb-3">
                                        <h4 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                            <i data-lucide="users" class="w-4 h-4 text-blue-500"></i> Kehadiran (MPP)
                                        </h4>
                                        <div class="text-right bg-slate-100 px-3 py-1 rounded-lg">
                                            <span class="text-[10px] text-slate-500 uppercase font-bold">Total Working</span>
                                            <div id="display-total-mpp" class="text-xl font-bold text-slate-700 leading-none">0</div>
                                        </div>
                                    </div>
                                    <div class="border border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm">
                                        <div class="max-h-[350px] overflow-y-auto">
                                            <table class="w-full text-sm text-left">
                                                <thead class="bg-slate-50 text-slate-500 font-semibold text-xs sticky top-0 z-10">
                                                    <tr>
                                                        <th class="p-3 w-1/3 min-w-[150px]">Nama Karyawan</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50/50">S1</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50/50">S2</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50/50">S3</th>
                                                        <th class="p-3 text-center w-12 bg-yellow-50/50">I</th>
                                                        <th class="p-3 text-center w-12 bg-red-50/50">S</th>
                                                        <th class="p-3 text-center w-12 bg-red-100/50">A</th>
                                                        <th class="p-3 w-1/4">Keterangan</th>
                                                        <th class="p-3 w-8"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sorter-attendance-list" class="divide-y divide-slate-50"></tbody>
                                            </table>
                                        </div>
                                        <div class="p-3 bg-slate-50 border-t border-slate-200">
                                            <button type="button" onclick="addDwRow()" class="text-sm text-blue-600 font-medium flex items-center gap-2 hover:text-blue-800 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors w-full justify-center border border-dashed border-blue-300">
                                                <i data-lucide="plus" class="w-4 h-4"></i> Tambah DW Manual
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex items-center justify-end pt-4 gap-3 border-t border-slate-100">
                                    <button type="button" id="btn-cancel-report-edit" class="hidden text-slate-500 px-5 py-2.5 hover:bg-slate-100 rounded-xl text-sm font-medium transition-colors" onclick="resetReportForm()">Batal Edit</button>
                                    <button type="submit" id="btn-save-report" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl text-sm font-semibold hover:bg-blue-700 disabled:opacity-70 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-200 flex items-center gap-2 active:scale-95">
                                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Laporan
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Table History -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700">Riwayat Laporan</h3>
                                <button onclick="loadMyReports()" class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg text-xs font-medium transition-colors flex items-center gap-1">
                                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider">
                                        <tr>
                                            <th class="p-4">Tanggal</th>
                                            <th class="p-4">HUB</th>
                                            <th class="p-4 text-right">Total Paket</th>
                                            <th class="p-4 text-right">Total MPP</th>
                                            <th class="p-4 text-right">Prod.</th>
                                            <th class="p-4 text-right">Cost</th>
                                            <th class="p-4 text-right">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rpt-history-body" class="divide-y divide-slate-100">
                                        <tr><td colspan="7" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: SETTINGS -->
                    <div id="view-settings" class="content-view hidden space-y-6 fade-in-up">
                         <div class="flex flex-col md:flex-row justify-between items-center mb-2">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">Pengaturan</h2>
                                <p class="text-slate-500 text-sm">Konfigurasi Master Data & Sistem.</p>
                            </div>
                        </div>
                        <div class="flex border-b border-slate-200 mb-6 gap-2 overflow-x-auto pb-1">
                            <button onclick="switchSettingsTab('hubs')" id="tab-btn-hubs" class="pb-3 px-4 text-sm font-medium whitespace-nowrap tab-active transition-all rounded-t-lg hover:bg-slate-50">Data HUB</button>
                            <button onclick="switchSettingsTab('employees')" id="tab-btn-employees" class="pb-3 px-4 text-sm font-medium whitespace-nowrap tab-inactive transition-all rounded-t-lg hover:bg-slate-50">Data Karyawan</button>
                            <button onclick="switchSettingsTab('config')" id="tab-btn-config" class="pb-3 px-4 text-sm font-medium whitespace-nowrap tab-inactive transition-all rounded-t-lg hover:bg-slate-50 flex items-center gap-2"><i data-lucide="settings-2" class="w-3 h-3"></i> Konfigurasi</button>
                        </div>
                        
                        <div id="tab-content-hubs" class="settings-tab-content space-y-6">
                             <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-blue-600"></i> Kelola Data HUB</h3>
                                <form id="form-add-hub" class="flex flex-col md:flex-row gap-4 items-end">
                                    <input type="hidden" id="edit-hub-id">
                                    <div class="w-full md:w-1/4">
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Kode HUB</label>
                                        <input type="text" id="hub-code" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm uppercase focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="KODE" required>
                                    </div>
                                    <div class="w-full md:w-2/4">
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Nama HUB</label>
                                        <input type="text" id="hub-name" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Nama Lokasi HUB" required>
                                    </div>
                                    <div class="w-full md:w-1/4">
                                        <label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Rate Sorter</label>
                                        <input type="number" id="hub-rate" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="0">
                                    </div>
                                    <div class="flex gap-2 w-full md:w-auto">
                                        <button type="submit" id="btn-save-hub" class="flex-1 md:flex-none bg-blue-600 text-white py-2.5 px-5 rounded-xl text-sm font-medium hover:bg-blue-700 min-w-[100px] transition-all shadow-md active:scale-95">Simpan</button>
                                        <button type="button" id="btn-cancel-hub" class="hidden text-slate-500 bg-slate-100 hover:bg-slate-200 py-2.5 px-4 rounded-xl text-sm transition-all" onclick="resetHubForm()">Batal</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider">
                                        <tr><th class="p-4">Kode</th><th class="p-4">Nama HUB</th><th class="p-4 text-right">Rate Sorter</th><th class="p-4 text-right">Aksi</th></tr>
                                    </thead>
                                    <tbody id="hub-table-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="tab-content-employees" class="settings-tab-content hidden space-y-6">
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2">
                                    <i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i> <span id="form-user-title">Tambah Karyawan</span>
                                </h3>
                                <form id="form-add-user" class="space-y-5">
                                    <input type="hidden" id="edit-user-id">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">NIK</label><input type="text" id="user-nik" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Nomor Induk" required></div>
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Nama Lengkap</label><input type="text" id="user-name" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Nama" required></div>
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Penempatan</label><select id="user-hub" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" required><option value="">Pilih HUB...</option></select></div>
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Jabatan</label><select id="user-role" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" required><option value="leader">Leader</option><option value="sorter">Sorter</option><option value="dw">DW</option></select></div>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col md:flex-row gap-4 items-center transition-all hover:bg-slate-100">
                                        <div class="flex items-center gap-3">
                                            <input type="checkbox" id="user-can-login" class="custom-checkbox rounded" onchange="togglePasswordInput()">
                                            <label for="user-can-login" class="text-sm font-medium text-slate-700 cursor-pointer select-none">Beri Akses Login Aplikasi?</label>
                                        </div>
                                        <div id="password-container" class="flex-1 hidden animate-in fade-in slide-in-from-left-2">
                                            <input type="text" id="user-pass" class="w-full p-2.5 border border-slate-300 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Set Password Login">
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button type="submit" id="btn-save-user" class="bg-blue-600 text-white px-6 py-2.5 rounded-xl text-sm font-semibold hover:bg-blue-700 shadow-md active:scale-95 transition-all">Simpan Data</button>
                                        <button type="button" id="btn-cancel-edit" class="hidden bg-slate-100 text-slate-600 px-5 py-2.5 rounded-xl text-sm font-medium hover:bg-slate-200 transition-all" onclick="resetUserForm()">Batal Edit</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <span id="user-count" class="text-xs font-bold text-slate-500 uppercase">Total: 0</span>
                                </div>
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider">
                                        <tr><th class="p-4">Nama</th><th class="p-4">HUB</th><th class="p-4">Status</th><th class="p-4">Pass</th><th class="p-4">Aktif</th><th class="p-4 text-right">Aksi</th></tr>
                                    </thead>
                                    <tbody id="user-table-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="tab-content-config" class="settings-tab-content hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <h3 class="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5 text-blue-600"></i> Akun & Keamanan</h3>
                                    <form id="form-config-security" class="space-y-4">
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Ganti Password Admin</label><input type="text" id="config-admin-pass" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Password Baru"></div>
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Kode Otorisasi (Delete/Edit)</label><input type="text" id="config-secure-code" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm font-mono tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="123456"></div>
                                        <button type="submit" class="bg-blue-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-blue-700 w-full shadow-md active:scale-95 transition-all">Update Keamanan</button>
                                    </form>
                                </div>
                                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <h3 class="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2"><i data-lucide="wallet" class="w-5 h-5 text-green-600"></i> Biaya Operasional</h3>
                                    <form id="form-config-cost" class="space-y-4">
                                        <div><label class="block text-xs font-semibold text-slate-500 mb-1.5 uppercase">Biaya DW per Kehadiran</label><input type="number" id="config-dw-rate" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm text-right focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0"><p class="text-[10px] text-slate-400 mt-1">*Berlaku sama untuk semua HUB</p></div>
                                        <button type="submit" class="bg-green-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-green-700 w-full shadow-md active:scale-95 transition-all">Update Biaya</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-20 hidden lg:hidden transition-opacity"></div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, onSnapshot, orderBy, limit, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // CONFIG
        // ==========================================
        let firebaseConfig, APP_ID;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            APP_ID = 'daily-report-app-v2'; 
        } else {
            firebaseConfig = { apiKey: "AIzaSyBBlbxiBpBR522JTI5xyxakGK9AEChXv1o", authDomain: "dailyreport-cfc8f.firebaseapp.com", projectId: "dailyreport-cfc8f", storageBucket: "dailyreport-cfc8f.firebasestorage.app", messagingSenderId: "963104518926", appId: "1:963104518926:web:81fb969a3573764f8c5d5f" };
            APP_ID = "daily-report-app-v2"; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let state = {
            user: null, role: null, userData: null, loginTab: 'leader',
            currentView: 'dashboard', hubs: [], employees: [],
            config: { secure_code: '123456', admin_password: 'admin123', dw_rate: 0 },
            chartAnnual: null, chartDaily: null
        };

        // --- UI HELPERS (NOTIFICATIONS & CONFIRMATIONS) ---
        
        // 1. Dynamic Island Notification
        function showToast(message, type = 'success') {
            const el = document.getElementById('dynamic-island');
            const msgEl = document.getElementById('di-msg');
            const iconEl = document.getElementById('di-icon');
            const iconContainer = document.getElementById('di-icon-container');

            msgEl.textContent = message;
            
            // Icon & Color Logic
            if(type === 'success') {
                iconEl.setAttribute('data-lucide', 'check');
                iconContainer.className = "flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white";
            } else if(type === 'error') {
                iconEl.setAttribute('data-lucide', 'x');
                iconContainer.className = "flex items-center justify-center w-6 h-6 rounded-full bg-red-500 text-white";
            } else {
                iconEl.setAttribute('data-lucide', 'info');
                iconContainer.className = "flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white";
            }
            lucide.createIcons();

            el.classList.add('active');
            setTimeout(() => { el.classList.remove('active'); }, 3000);
        }

        // 2. Custom Confirmation Modal
        function customConfirm(title, desc, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const btnYes = document.getElementById('btn-confirm-yes');
            const btnNo = document.getElementById('btn-confirm-no');
            const titleEl = document.getElementById('confirm-title');
            const descEl = document.getElementById('confirm-desc');

            titleEl.textContent = title;
            descEl.textContent = desc;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            // Handlers (using oneshot to prevent stacking)
            const handleYes = () => { closeConfirm(); onConfirm(); cleanup(); };
            const handleNo = () => { closeConfirm(); cleanup(); };
            
            function cleanup() {
                btnYes.removeEventListener('click', handleYes);
                btnNo.removeEventListener('click', handleNo);
            }

            btnYes.addEventListener('click', handleYes);
            btnNo.addEventListener('click', handleNo);
        }

        function closeConfirm() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // 3. Button Loading State
        function setButtonLoading(btn, isLoading, originalContent = '') {
            if(isLoading) {
                btn.dataset.original = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> <span>Proses...</span>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = originalContent || btn.dataset.original || 'Simpan';
            }
        }

        // --- DOM ELEMENTS ---
        const els = {
            loading: document.getElementById('loading-screen'),
            loginScreen: document.getElementById('login-screen'),
            appScreen: document.getElementById('app-screen'),
            // Login
            loginForm: document.getElementById('login-form'),
            loginNik: document.getElementById('login-nik'),
            loginPass: document.getElementById('login-pass'),
            fieldNik: document.getElementById('field-nik'),
            fieldPass: document.getElementById('field-pass'),
            loginError: document.getElementById('login-error'),
            loginErrorText: document.getElementById('login-error-text'),
            btnLogin: document.getElementById('btn-login'),
            loginHint: document.getElementById('login-hint'),
            
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            openSidebarBtn: document.getElementById('open-sidebar'),
            closeSidebarBtn: document.getElementById('close-sidebar'),
            menuSettings: document.getElementById('menu-settings'),
            userNameDisplay: document.getElementById('user-name-display'),
            userRoleDisplay: document.getElementById('user-role-display'),
            
            // Security Modal
            securityModal: document.getElementById('security-modal'),
            inputSecureCode: document.getElementById('input-secure-code'),
            btnCancelSecure: document.getElementById('btn-cancel-secure'),
            btnConfirmSecure: document.getElementById('btn-confirm-secure'),
            secureError: document.getElementById('secure-error'),

            views: {
                dashboard: document.getElementById('view-dashboard'),
                reports: document.getElementById('view-reports'),
                settings: document.getElementById('view-settings')
            },
            
            // Dashboard
            dashStartDate: document.getElementById('dash-start-date'),
            dashEndDate: document.getElementById('dash-end-date'),
            dashHubContainer: document.getElementById('dash-hub-container'),
            kpiTotalPaket: document.getElementById('kpi-total-paket'),
            kpiTotalMpp: document.getElementById('kpi-total-mpp'),
            kpiProductivity: document.getElementById('kpi-productivity'),
            kpiTotalCost: document.getElementById('kpi-total-cost'),
            kpiCpp: document.getElementById('kpi-cpp'),
            canvasAnnual: document.getElementById('annualChart'),
            canvasDaily: document.getElementById('dailyChart'),
            dashTableDaily: document.getElementById('dash-table-daily'),
            dashTableHub: document.getElementById('dash-table-hub'),
            btnFilterDash: document.getElementById('btn-filter-dash'),

            // Reports
            sectionInputReport: document.getElementById('section-input-report'),
            formDailyReport: document.getElementById('form-daily-report'),
            formReportTitle: document.getElementById('form-report-title'),
            editReportId: document.getElementById('edit-report-id'),
            rptDate: document.getElementById('rpt-date'),
            rptHubContainer: document.getElementById('rpt-hub-container'), 
            rptGateway: document.getElementById('rpt-gateway'),
            rptStaging: document.getElementById('rpt-staging'),
            rptSap: document.getElementById('rpt-sap'),
            rptJne: document.getElementById('rpt-jne'),
            rptTotalPaket: document.getElementById('rpt-total-paket'),
            rptProductivity: document.getElementById('rpt-productivity'),
            btnCancelReportEdit: document.getElementById('btn-cancel-report-edit'),
            sorterAttendanceList: document.getElementById('sorter-attendance-list'),
            displayTotalMpp: document.getElementById('display-total-mpp'),
            btnSaveReport: document.getElementById('btn-save-report'),
            rptHistoryBody: document.getElementById('rpt-history-body'),
            
            // Settings
            formAddHub: document.getElementById('form-add-hub'),
            editHubId: document.getElementById('edit-hub-id'),
            hubCode: document.getElementById('hub-code'),
            hubName: document.getElementById('hub-name'),
            hubRate: document.getElementById('hub-rate'),
            btnSaveHub: document.getElementById('btn-save-hub'),
            btnCancelHub: document.getElementById('btn-cancel-hub'),
            hubTableBody: document.getElementById('hub-table-body'),

            formAddUser: document.getElementById('form-add-user'),
            formUserTitle: document.getElementById('form-user-title'),
            editUserId: document.getElementById('edit-user-id'),
            userNik: document.getElementById('user-nik'),
            userName: document.getElementById('user-name'),
            userHub: document.getElementById('user-hub'),
            userRole: document.getElementById('user-role'),
            userCanLogin: document.getElementById('user-can-login'),
            userPass: document.getElementById('user-pass'),
            passContainer: document.getElementById('password-container'),
            btnSaveUser: document.getElementById('btn-save-user'),
            btnCancelEdit: document.getElementById('btn-cancel-edit'),
            userTableBody: document.getElementById('user-table-body'),
            userCount: document.getElementById('user-count'),

            formConfigSecurity: document.getElementById('form-config-security'),
            configAdminPass: document.getElementById('config-admin-pass'),
            configSecureCode: document.getElementById('config-secure-code'),
            formConfigCost: document.getElementById('form-config-cost'),
            configDwRate: document.getElementById('config-dw-rate'),
        };

        function formatNumber(num) { return Number(num).toLocaleString('id-ID'); }

        // --- INIT ---
        async function init() {
            try { lucide.createIcons(); } catch(e) {}
            
            if (typeof __initial_auth_token !== 'undefined') { try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) {} }
            loadGlobalConfig();
            
            onAuthStateChanged(auth, (currentUser) => {
                state.user = currentUser;
                const savedRole = localStorage.getItem('userRole');
                const savedUserData = localStorage.getItem('userData');
                
                if (currentUser && savedRole) {
                    state.role = savedRole;
                    if (savedUserData) state.userData = JSON.parse(savedUserData);
                    showApp();
                } else { 
                    state.role = null; 
                    state.userData = null; 
                    showLogin(); 
                }
                
                // Hide loading
                els.loading.classList.add('opacity-0');
                setTimeout(() => els.loading.classList.add('hidden'), 500);
            });
        }

        async function loadGlobalConfig() {
            try { const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'config')); if (snap.exists()) state.config = { ...state.config, ...snap.data() }; } catch(e) {}
        }

        // --- SECURITY ---
        let pendingSecureAction = null;
        function secureCheck(callback) {
            if (state.role === 'admin') { callback(); return; }
            pendingSecureAction = callback;
            els.inputSecureCode.value = ''; els.secureError.classList.add('hidden'); els.securityModal.classList.remove('hidden'); els.inputSecureCode.focus();
        }
        els.btnCancelSecure.addEventListener('click', () => { els.securityModal.classList.add('hidden'); pendingSecureAction = null; });
        els.btnConfirmSecure.addEventListener('click', () => {
            if (els.inputSecureCode.value.trim() === state.config.secure_code) { els.securityModal.classList.add('hidden'); if(pendingSecureAction) pendingSecureAction(); } 
            else { els.secureError.classList.remove('hidden'); }
        });

        async function saveConfig(data) {
            try { await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'config'), data, { merge: true }); state.config = { ...state.config, ...data }; showToast("Pengaturan disimpan!", "success"); } catch(e) { showToast("Gagal menyimpan", "error"); }
        }
        els.formConfigSecurity.addEventListener('submit', (e) => { e.preventDefault(); const p = els.configAdminPass.value.trim(); const c = els.configSecureCode.value.trim(); const u={}; if(p)u.admin_password=p; if(c)u.secure_code=c; if(Object.keys(u).length) saveConfig(u); });
        els.formConfigCost.addEventListener('submit', (e) => { e.preventDefault(); saveConfig({ dw_rate: Number(els.configDwRate.value) }); });

        // --- LOGIN ---
        window.switchLoginTab = (tab) => {
            state.loginTab = tab;
            ['sorter', 'leader', 'admin'].forEach(t => { const el = document.getElementById(`tab-login-${t}`); el.className = (t===tab) ? "py-2.5 text-xs font-medium rounded-lg transition-all text-center login-tab-active bg-white shadow-sm text-blue-600" : "py-2.5 text-xs font-medium rounded-lg transition-all text-center login-tab-inactive"; });
            els.loginError.classList.add('hidden'); els.loginNik.value = ''; els.loginPass.value = '';
            els.fieldNik.classList.toggle('hidden', tab === 'admin'); els.fieldPass.classList.toggle('hidden', tab === 'sorter');
            els.loginHint.textContent = tab==='sorter'?"Akses Sorter (Lihat Saja)": (tab==='admin'?"Akses Administrator":"Akses Leader/Staf");
        };

        els.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const tab = state.loginTab; const nik = els.loginNik.value.trim(); const pass = els.loginPass.value.trim();
            els.loginError.classList.add('hidden'); setButtonLoading(els.btnLogin, true, 'Masuk Aplikasi');
            
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                if(!state.config.admin_password) await loadGlobalConfig();
                let role = tab; let uData = null;

                if (tab === 'admin') {
                    if (pass !== state.config.admin_password) throw new Error('Password Admin Salah');
                    uData = { name: 'Administrator', nik: 'ADMIN' };
                } else {
                    const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("nik", "==", nik));
                    const snap = await getDocs(q);
                    if (snap.empty) throw new Error('NIK tidak ditemukan.');
                    uData = snap.docs[0].data();
                    if(tab === 'leader' && (!uData.can_login || uData.password !== pass)) throw new Error(uData.can_login ? 'Password Salah' : 'Akun tidak memiliki akses login');
                }
                
                state.role = role; state.userData = uData;
                localStorage.setItem('userRole', role); localStorage.setItem('userData', JSON.stringify(uData)); 
                showToast(`Selamat datang, ${uData.name}!`, 'success');
                setTimeout(showApp, 800);
            } catch (err) { 
                // Catch specific Firebase Config error
                if (err.code === 'auth/configuration-not-found' || err.code === 'auth/admin-restricted-operation') {
                    els.loginErrorText.innerHTML = "<strong>Error Konfigurasi:</strong><br>Fitur 'Anonymous Auth' belum aktif.<br>Silakan aktifkan di Firebase Console.";
                } else {
                    els.loginErrorText.textContent = err.message || 'Login Gagal';
                }
                els.loginError.classList.remove('hidden'); 
                setButtonLoading(els.btnLogin, false, '<span>Masuk Aplikasi</span><i data-lucide="arrow-right" class="w-4 h-4"></i>');
            }
        });

        function showLogin() { els.loginScreen.classList.remove('hidden'); els.appScreen.classList.add('hidden'); switchLoginTab('leader'); }
        function showApp() {
            els.loginScreen.classList.add('hidden'); els.appScreen.classList.remove('hidden');
            els.userNameDisplay.textContent = state.userData?.name || 'User'; els.userRoleDisplay.textContent = state.userData?.role || state.role;
            els.menuSettings.classList.toggle('hidden', state.role !== 'admin');
            els.sectionInputReport.classList.toggle('hidden', state.role === 'sorter');
            navigateTo('dashboard');
        }

        window.handleLogout = async () => { 
            customConfirm('Keluar Aplikasi', 'Anda yakin ingin keluar dari sesi ini?', () => {
                localStorage.removeItem('userRole'); localStorage.removeItem('userData'); window.location.reload(); 
            });
        };

        window.navigateTo = (viewId) => {
            state.currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.target === viewId;
                el.classList.toggle('bg-slate-800', isActive); el.classList.toggle('text-white', isActive); el.classList.toggle('shadow-lg', isActive); el.classList.toggle('border-l-4', isActive); el.classList.toggle('border-blue-500', isActive);
                el.classList.toggle('text-slate-400', !isActive);
            });
            Object.values(els.views).forEach(el => el.classList.add('hidden'));
            const view = els.views[viewId];
            if(view) { view.classList.remove('hidden'); view.classList.remove('fade-in-up'); void view.offsetWidth; view.classList.add('fade-in-up'); }
            
            if (viewId === 'dashboard') loadDashboard(); if (viewId === 'reports') loadReportsView(); if (viewId === 'settings' && state.role === 'admin') loadSettings();
            els.sidebar.classList.add('-translate-x-full'); els.sidebarOverlay.classList.add('hidden');
        };

        // --- DASHBOARD ---
        function loadDashboard() {
            if(!els.dashStartDate.value) { const now = new Date(); els.dashStartDate.valueAsDate = new Date(now.getFullYear(), now.getMonth(), 1); els.dashEndDate.valueAsDate = now; }
            if (state.role === 'admin' && state.hubs.length === 0) {
                 getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs')).then(snap => {
                    state.hubs = snap.docs.map(d => d.data());
                    renderDashHubSelect();
                 });
            } else if(state.role === 'admin') renderDashHubSelect();
            else els.dashHubContainer.innerHTML = `<input type="text" value="${state.userData?.hub_code || '-'}" readonly class="w-full p-2.5 bg-slate-100 border border-slate-200 rounded-xl text-sm text-slate-500 font-bold">`;
            loadDashboardStats();
        }
        
        function renderDashHubSelect() {
            let options = `<option value="">Semua HUB</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name}</option>`).join('');
            els.dashHubContainer.innerHTML = `<select id="dash-hub-select" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm bg-white focus:ring-2 focus:ring-blue-100">${options}</select>`;
        }

        window.loadDashboardStats = async () => {
            setButtonLoading(els.btnFilterDash, true, '<i data-lucide="filter" class="w-4 h-4"></i> Terapkan');
            const start = els.dashStartDate.value; const end = els.dashEndDate.value;
            let hubFilter = state.role === 'admin' ? (document.getElementById('dash-hub-select')?.value || '') : state.userData?.hub_code;
            
            try {
                const reportsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports');
                const q = query(reportsRef, where("date", ">=", start), where("date", "<=", end)); 
                const snap = await getDocs(q);
                let reports = []; snap.forEach(d => { const r=d.data(); if(!hubFilter || r.hub === hubFilter) reports.push(r); });
                reports.sort((a, b) => a.date.localeCompare(b.date));

                let totalPaket = 0; let totalMpp = 0; let totalCost = 0;
                const monthlyData = {}; const dailyData = {}; const hubData = {};

                reports.forEach(r => {
                    totalPaket += (r.total_paket||0); totalMpp += (r.total_mpp||0); totalCost += (r.est_cost||0);
                    const mKey = r.date.substring(0, 7); if(!monthlyData[mKey]) monthlyData[mKey]={paket:0,mpp:0}; monthlyData[mKey].paket += (r.total_paket||0); monthlyData[mKey].mpp += (r.total_mpp||0);
                    const dKey = r.date; if(!dailyData[dKey]) dailyData[dKey]={date:r.date,mpp:0,outbound:0,cost:0}; dailyData[dKey].mpp += (r.total_mpp||0); dailyData[dKey].outbound += (r.total_paket||0); dailyData[dKey].cost += (r.est_cost||0);
                    const hKey = r.hub; if(!hubData[hKey]) hubData[hKey]={hub:r.hub,mpp:0,outbound:0,cost:0}; hubData[hKey].mpp += (r.total_mpp||0); hubData[hKey].outbound += (r.total_paket||0); hubData[hKey].cost += (r.est_cost||0);
                });

                const avgProd = totalMpp > 0 ? Math.round(totalPaket / totalMpp) : 0;
                const avgCpp = totalPaket > 0 ? Math.round(totalCost / totalPaket) : 0;

                animateValue(els.kpiTotalPaket, totalPaket);
                animateValue(els.kpiTotalMpp, totalMpp);
                animateValue(els.kpiProductivity, avgProd);
                els.kpiTotalCost.textContent = "Rp " + formatNumber(totalCost);
                els.kpiCpp.textContent = "Rp " + formatNumber(avgCpp);

                renderChart(els.canvasAnnual, Object.keys(monthlyData).sort().map(k=>new Date(k+"-01").toLocaleDateString('id-ID',{month:'short',year:'2-digit'})), Object.keys(monthlyData).sort().map(k=>monthlyData[k].paket), Object.keys(monthlyData).sort().map(k=>monthlyData[k].mpp>0?Math.round(monthlyData[k].paket/monthlyData[k].mpp):0), 'chartAnnual');
                renderChart(els.canvasDaily, Object.keys(dailyData).sort().map(d=>new Date(d).toLocaleDateString('id-ID',{day:'numeric',month:'short'})), Object.keys(dailyData).sort().map(k=>dailyData[k].outbound), Object.keys(dailyData).sort().map(k=>dailyData[k].mpp>0?Math.round(dailyData[k].outbound/dailyData[k].mpp):0), 'chartDaily');

                els.dashTableDaily.innerHTML = Object.keys(dailyData).sort().reverse().map(k => {
                    const d = dailyData[k]; const prod = d.mpp>0?Math.round(d.outbound/d.mpp):0;
                    return `<tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="p-4">${d.date}</td><td class="p-4 text-right">${d.mpp}</td><td class="p-4 text-right font-bold text-blue-600">${formatNumber(d.outbound)}</td><td class="p-4 text-right text-green-600 font-bold">${formatNumber(prod)}</td><td class="p-4 text-right text-slate-500">Rp ${formatNumber(d.cost)}</td></tr>`;
                }).join('');
                
                els.dashTableHub.innerHTML = Object.keys(hubData).sort().map(k => {
                    const h = hubData[k]; const prod = h.mpp>0?Math.round(h.outbound/h.mpp):0;
                    return `<tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="p-4 font-medium">${h.hub}</td><td class="p-4 text-right text-blue-600 font-bold">${formatNumber(h.outbound)}</td><td class="p-4 text-right text-green-600">${formatNumber(prod)}</td></tr>`;
                }).join('');

            } catch (e) { showToast("Gagal memuat dashboard", "error"); }
            finally { setButtonLoading(els.btnFilterDash, false, '<i data-lucide="filter" class="w-4 h-4"></i> Terapkan'); }
        };

        function animateValue(obj, end) {
            let start = 0; if (start === end) return;
            let duration = 1000; let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                let progress = Math.min((timestamp - startTime) / duration, 1);
                obj.innerHTML = formatNumber(Math.floor(progress * end));
                if (progress < 1) window.requestAnimationFrame(step);
            }
            window.requestAnimationFrame(step);
        }

        function renderChart(canvas, labels, dataBar, dataLine, stateKey) {
            const ctx = canvas.getContext('2d'); if (state[stateKey]) state[stateKey].destroy();
            state[stateKey] = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Total Paket', data: dataBar, backgroundColor: '#3b82f6', borderRadius: 6, barPercentage: 0.6, order: 2, yAxisID: 'y' }, { type: 'line', label: 'Produktivitas', data: dataLine, borderColor: '#22c55e', borderWidth: 2, tension: 0.4, pointRadius: 0, pointHoverRadius: 4, order: 1, yAxisID: 'y1' }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: {mode: 'index', intersect: false}, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', padding: 10, cornerRadius: 8 } }, scales: { y: { display: false }, y1: { display: false, position: 'right' }, x: { grid: { display: false } } } }
            });
        }

        // --- REPORTS ---
        document.querySelectorAll('.metric-input').forEach(input => { input.addEventListener('input', calculateReportTotals); });
        window.calculateReportTotals = () => {
            const total = (Number(els.rptGateway.value)||0) + (Number(els.rptStaging.value)||0) + (Number(els.rptSap.value)||0) + (Number(els.rptJne.value)||0);
            els.rptTotalPaket.value = formatNumber(total);
            let wCnt = 0; document.querySelectorAll('.attendance-radio:checked').forEach(r => { if(['s1','s2','s3'].includes(r.value)) { const row = r.closest('tr'); if(!row.textContent.toLowerCase().includes('leader')) wCnt++; }});
            els.displayTotalMpp.textContent = wCnt;
            els.rptProductivity.value = wCnt > 0 ? formatNumber(Math.round(total / wCnt)) : 0;
        }

        window.addDwRow = () => {
            const uid = 'dw_' + Date.now();
            const tr = document.createElement('tr'); tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors animate-in fade-in slide-in-from-left-2';
            tr.innerHTML = `<td class="p-3"><input type="text" class="w-full p-1.5 border border-slate-200 rounded-lg text-sm dw-name-input focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Nama DW..." data-id="${uid}"></td>${generateAttCols(uid)}<td class="p-3 text-center"><button type="button" onclick="this.closest('tr').remove(); calculateReportTotals()" class="text-red-400 hover:text-red-600 transition-colors"><i data-lucide="x-circle" class="w-4 h-4"></i></button></td>`;
            els.sorterAttendanceList.appendChild(tr); lucide.createIcons();
        }
        function generateAttCols(uid) { return ['s1','s2','s3','i','s','a'].map(v => `<td class="p-2 text-center ${v.startsWith('s')?'bg-blue-50/30':(v==='i'?'bg-yellow-50/30':'bg-red-50/30')}"><input type="radio" name="att_${uid}" value="${v}" class="attendance-radio custom-radio" onclick="calculateReportTotals()"></td>`).join('') + `<td class="p-2"><input type="text" class="w-full p-1 border border-slate-100 rounded text-xs att-remarks" placeholder="..."></td>`; }

        async function loadReportsView() {
            if(els.editReportId.value) return; els.rptDate.valueAsDate = new Date();
            let hCode = state.userData?.hub_code;
            if(state.role === 'admin') {
                if(!state.hubs.length) { const s = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs')); state.hubs = s.docs.map(d=>d.data()); }
                const opts = `<option value="">Pilih HUB...</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name} (${h.code})</option>`).join('');
                els.rptHubContainer.innerHTML = `<select id="rpt-hub-select" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-100" onchange="loadReportsView()">${opts}</select>`;
                hCode = document.getElementById('rpt-hub-select')?.value;
            } else els.rptHubContainer.innerHTML = `<input type="text" id="rpt-hub-static" value="${hCode}" class="w-full p-2.5 bg-slate-100 border border-slate-200 rounded-xl text-sm font-bold text-slate-500" readonly>`;
            
            if(hCode) {
                 els.sorterAttendanceList.innerHTML = '<tr><td colspan="9" class="p-4 text-center"><div class="flex justify-center"><div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div></td></tr>';
                 const uSnap = await getDocs(query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("hub_code", "==", hCode)));
                 els.sorterAttendanceList.innerHTML = '';
                 uSnap.forEach(d => {
                     const s = d.data(); if(s.role==='admin') return;
                     const tr = document.createElement('tr'); tr.className = 'border-b border-slate-50 hover:bg-slate-50 transition-colors';
                     tr.innerHTML = `<td class="p-3 font-medium text-slate-700" data-name="${s.name}" data-is-db="true">${s.name} <span class="text-[10px] text-slate-400">(${s.role})</span></td>${generateAttCols(d.id)}<td class="p-3"></td>`;
                     els.sorterAttendanceList.appendChild(tr);
                 });
            } else els.sorterAttendanceList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-400 text-sm">Pilih HUB untuk memuat karyawan.</td></tr>';
            loadMyReports(); calculateReportTotals();
        }

        window.loadMyReports = async () => {
            const tbody = els.rptHistoryBody;
            tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center"><div class="flex justify-center items-center gap-2 text-slate-400"><div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div> Memuat...</div></td></tr>';
            try {
                const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), orderBy("date", "desc"), limit(20));
                let snap = await getDocs(q);
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-slate-400 italic">Belum ada riwayat laporan.</td></tr>'; return; }
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr'); tr.className = 'hover:bg-slate-50 border-b border-slate-100 transition-colors animate-in fade-in';
                    let btns = ''; if(state.role === 'admin' || d.hub === state.userData.hub_code) {
                        btns = `<button onclick='confirmEditReport(${JSON.stringify({id: doc.id, ...d})})' class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                <button onclick='confirmDeleteReport("${doc.id}", "${d.hub}")' class="text-red-500 hover:bg-red-100 p-2 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    }
                    tr.innerHTML = `<td class="p-4 whitespace-nowrap font-medium text-slate-600">${d.date}</td><td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${d.hub}</span></td><td class="p-4 text-right font-bold text-blue-600">${formatNumber(d.total_paket)}</td><td class="p-4 text-right font-bold text-slate-700">${d.total_mpp}</td><td class="p-4 text-right font-mono text-green-600 font-bold text-xs">${formatNumber(d.productivity)}</td><td class="p-4 text-right text-slate-500 text-xs">Rp ${formatNumber(d.est_cost)}</td><td class="p-4 text-right flex justify-end gap-1">${btns}</td>`;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch(e) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-400">Gagal memuat data.</td></tr>'; }
        }

        window.confirmDeleteReport = (id, hub) => {
            if(state.role !== 'admin' && hub !== state.userData.hub_code) return;
            customConfirm('Hapus Laporan', 'Tindakan ini tidak dapat dibatalkan. Hapus laporan ini?', () => {
                secureCheck(async () => {
                     try { await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports', id)); loadMyReports(); showToast('Laporan dihapus', 'success'); } 
                     catch(e) { showToast('Gagal menghapus', 'error'); }
                });
            });
        };

        window.confirmEditReport = (rpt) => {
            customConfirm('Edit Laporan', 'Anda akan masuk ke mode edit untuk laporan ini.', () => {
                secureCheck(() => {
                    els.editReportId.value = rpt.id; els.rptDate.value = rpt.date;
                    if(state.role === 'admin') { const sel = document.getElementById('rpt-hub-select'); if(sel) { sel.value = rpt.hub; loadReportsView().then(() => restoreAtt(rpt)); } }
                    else restoreAtt(rpt);
                    ['gateway','staging','sap','jne'].forEach(k => els[`rpt${k.charAt(0).toUpperCase()+k.slice(1)}`].value = rpt[k]);
                    els.formReportTitle.textContent = "Edit Laporan"; els.btnSaveReport.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Update Laporan';
                    els.btnCancelReportEdit.classList.remove('hidden'); els.formDailyReport.scrollIntoView({ behavior: 'smooth' });
                });
            });
        };
        function restoreAtt(rpt) {
             document.querySelectorAll('.attendance-radio').forEach(r => r.checked = false); document.querySelectorAll('.att-remarks').forEach(i => i.value = '');
             if(rpt.attendance_data) rpt.attendance_data.forEach(att => {
                 let row = Array.from(document.querySelectorAll('td[data-name]')).find(td => td.dataset.name === att.name)?.closest('tr');
                 if(!row) { addDwRow(); row = els.sorterAttendanceList.lastElementChild; row.querySelector('.dw-name-input').value = att.name; }
                 if(row) { const r = row.querySelector(`input[value="${att.status}"]`); if(r) r.checked = true; row.querySelector('.att-remarks').value = att.remarks||''; }
             });
             calculateReportTotals();
        }

        window.resetReportForm = () => { els.formDailyReport.reset(); els.editReportId.value = ''; els.formReportTitle.textContent = "Input Laporan Operasional"; els.btnSaveReport.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Simpan Laporan'; els.btnCancelReportEdit.classList.add('hidden'); loadReportsView(); }

        els.formDailyReport.addEventListener('submit', async (e) => {
            e.preventDefault(); setButtonLoading(els.btnSaveReport, true);
            try {
                const hub = state.role === 'admin' ? document.getElementById('rpt-hub-select').value : document.getElementById('rpt-hub-static').value;
                if(!hub) throw new Error("Pilih HUB");
                
                let sRate = 0; const hData = state.hubs.find(h => h.code === hub); if(hData) sRate = Number(hData.sorter_rate)||0;
                const dwRate = Number(state.config.dw_rate)||0;
                
                const att = []; let sCnt=0, dCnt=0, wCnt=0;
                els.sorterAttendanceList.querySelectorAll('tr').forEach(row => {
                    const chk = row.querySelector('.attendance-radio:checked');
                    if(chk) {
                        const isDb = row.querySelector('td[data-is-db="true"]');
                        att.push({ name: isDb ? isDb.dataset.name : row.querySelector('.dw-name-input')?.value || 'Unknown', status: chk.value, remarks: row.querySelector('.att-remarks').value });
                        if(['s1','s2','s3'].includes(chk.value) && !row.textContent.toLowerCase().includes('leader')) { wCnt++; isDb ? sCnt++ : dCnt++; }
                    }
                });

                const total = Number(els.rptTotalPaket.value.replace(/\./g,''));
                const rData = {
                    date: els.rptDate.value, hub, nik: state.userData?.nik || 'SYS', reporter_name: state.userData?.name || 'System',
                    gateway: Number(els.rptGateway.value), staging: Number(els.rptStaging.value), sap: Number(els.rptSap.value), jne: Number(els.rptJne.value),
                    total_paket: total, total_mpp: wCnt, productivity: wCnt>0?Math.round(total/wCnt):0, attendance_data: att, est_cost: (sCnt*sRate)+(dCnt*dwRate), created_at: new Date().toISOString()
                };

                const msg = els.editReportId.value ? "Laporan berhasil diupdate!" : "Laporan berhasil disimpan!";
                if(els.editReportId.value) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports', els.editReportId.value), rData);
                else await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), rData);
                
                showToast(msg, 'success'); resetReportForm(); loadMyReports();
            } catch (err) { showToast(err.message, 'error'); } 
            finally { setButtonLoading(els.btnSaveReport, false, '<i data-lucide="save" class="w-4 h-4"></i> Simpan Laporan'); }
        });

        // --- SETTINGS (Simplified for brevity but styled) ---
        window.switchSettingsTab = (t) => {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            ['hubs', 'employees', 'config'].forEach(k => {
                const btn = document.getElementById(`tab-btn-${k}`);
                btn.className = (k===t) ? "pb-3 px-4 text-sm font-bold whitespace-nowrap border-b-2 border-blue-600 text-blue-600 transition-all rounded-t-lg bg-blue-50/50" : "pb-3 px-4 text-sm font-medium whitespace-nowrap text-slate-500 hover:text-slate-700 transition-all rounded-t-lg hover:bg-slate-50";
            });
            const content = document.getElementById(`tab-content-${t}`);
            content.classList.remove('hidden'); content.classList.add('fade-in-up');
        }
        function loadSettings() {
            if (!unsubscribeHubs) unsubscribeHubs = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), (s) => { state.hubs = s.docs.map(d => ({id:d.id, ...d.data()})); renderHubsTable(); });
            if (!unsubscribeEmployees) unsubscribeEmployees = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), (s) => { state.employees = s.docs.map(d => ({id:d.id, ...d.data()})).filter(u=>u.role!=='admin'); renderEmployeesTable(); });
            if(state.config) { els.configSecureCode.value = state.config.secure_code||''; els.configDwRate.value = state.config.dw_rate||0; }
        }

        els.formAddHub.addEventListener('submit', (e) => {
            e.preventDefault(); const id = els.editHubId.value;
            customConfirm(id ? 'Update HUB' : 'Simpan HUB', 'Pastikan data sudah benar.', () => {
                secureCheck(async () => {
                    const data = { code: els.hubCode.value.toUpperCase().trim(), name: els.hubName.value.trim(), sorter_rate: Number(els.hubRate.value)||0 };
                    try { if(id) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'hubs', id), data); else await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), data); resetHubForm(); showToast("Data HUB tersimpan!", "success"); } catch(e) { showToast(e.message, "error"); }
                });
            });
        });
        window.editHub = (h) => { if(typeof h==='string') h=JSON.parse(h); els.editHubId.value=h.id; els.hubCode.value=h.code; els.hubName.value=h.name; els.hubRate.value=h.sorter_rate; els.btnSaveHub.textContent='Update'; els.btnCancelHub.classList.remove('hidden'); }
        window.resetHubForm = () => { els.formAddHub.reset(); els.editHubId.value=''; els.btnSaveHub.textContent='Simpan'; els.btnCancelHub.classList.add('hidden'); }
        function renderHubsTable() { els.hubTableBody.innerHTML = state.hubs.map(h => `<tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="p-4 font-bold text-slate-700 font-mono">${h.code}</td><td class="p-4">${h.name}</td><td class="p-4 text-right">Rp ${formatNumber(h.sorter_rate)}</td><td class="p-4 text-right"><button onclick='editHub(${JSON.stringify(h)})' class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteDocItem('hubs','${h.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded-lg ml-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join(''); lucide.createIcons(); }

        els.formAddUser.addEventListener('submit', (e) => {
            e.preventDefault(); const id = els.editUserId.value;
            customConfirm(id ? 'Update Karyawan' : 'Simpan Karyawan', 'Pastikan data sudah benar.', () => {
                secureCheck(async () => {
                    const data = { nik: els.userNik.value, name: els.userName.value, hub_code: els.userHub.value, role: els.userRole.value, can_login: els.userCanLogin.checked, password: els.userPass.value };
                    try { if(id) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', id), data); else await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), data); resetUserForm(); showToast("Data Karyawan tersimpan!", "success"); } catch(e) { showToast(e.message, "error"); }
                });
            });
        });
        window.togglePasswordInput = () => { els.passContainer.classList.toggle('hidden', !els.userCanLogin.checked); els.userPass.required = els.userCanLogin.checked; }
        window.resetUserForm = () => { els.formAddUser.reset(); els.editUserId.value=''; els.formUserTitle.textContent='Tambah Karyawan'; els.btnSaveUser.textContent='Simpan Data'; els.btnCancelEdit.classList.add('hidden'); els.userNik.disabled=false; togglePasswordInput(); }
        window.editUser = (u) => { if(typeof u==='string')u=JSON.parse(u); els.editUserId.value=u.id; els.userNik.value=u.nik; els.userNik.disabled=true; els.userName.value=u.name; els.userHub.value=u.hub_code; els.userRole.value=u.role; els.userCanLogin.checked=u.can_login; els.userPass.value=u.password||''; togglePasswordInput(); els.formUserTitle.textContent='Edit Karyawan'; els.btnSaveUser.textContent='Update Data'; els.btnCancelEdit.classList.remove('hidden'); els.formAddUser.scrollIntoView({behavior:'smooth'}); }
        function renderEmployeesTable() { els.userCount.textContent = `Total: ${state.employees.length}`; els.userTableBody.innerHTML = state.employees.map(u => `<tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors"><td class="p-4"><div class="font-medium text-slate-800">${u.name}</div><div class="text-xs text-slate-400 font-mono">${u.nik}</div></td><td class="p-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">${u.hub_code}</span></td><td class="p-4 capitalize text-sm">${u.role}</td><td class="p-4 font-mono text-xs">${u.can_login?u.password:'-'}</td><td class="p-4">${u.can_login?'<span class="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold">Aktif</span>':'<span class="text-slate-400 bg-slate-100 px-2 py-1 rounded text-xs">Non-Aktif</span>'}</td><td class="p-4 text-right flex gap-1 justify-end"><button onclick='editUser(${JSON.stringify(u)})' class="text-blue-500 hover:bg-blue-100 p-2 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteDocItem('users','${u.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join(''); lucide.createIcons(); }
        window.deleteDocItem = (col, id) => { customConfirm('Hapus Data', 'Data yang dihapus tidak dapat dikembalikan.', () => { secureCheck(async () => { try { await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id)); showToast('Data dihapus', 'success'); } catch(e) { showToast('Gagal menghapus', 'error'); } }); }); }

        // Sidebar mobile toggle
        els.openSidebarBtn.addEventListener('click', () => { els.sidebar.classList.remove('-translate-x-full'); els.sidebarOverlay.classList.remove('hidden'); });
        const closeMenu = () => { els.sidebar.classList.add('-translate-x-full'); els.sidebarOverlay.classList.add('hidden'); };
        els.closeSidebarBtn.addEventListener('click', closeMenu); els.sidebarOverlay.addEventListener('click', closeMenu);

        init();
    </script>
    <script>
        // GLOBAL ERROR HANDLER & TIMEOUT
        // Ini berjalan di luar module untuk menangani jika Firebase gagal dimuat
        
        // 1. Timeout Safety (4 detik)
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if (loader && !loader.classList.contains('hidden')) {
                console.warn("Fallback Timer Triggered");
                loader.classList.add('opacity-0');
                setTimeout(() => {
                    loader.classList.add('hidden');
                    // Paksa tampilkan login jika app belum siap
                    if (document.getElementById('app-screen').classList.contains('hidden')) {
                        document.getElementById('login-screen').classList.remove('hidden');
                        // Tampilkan notifikasi error
                        const errDiv = document.getElementById('login-error');
                        if(errDiv) {
                            errDiv.classList.remove('hidden');
                            document.getElementById('login-error-text').innerText = "Koneksi lambat/Offline. Mode terbatas.";
                        }
                    }
                }, 500);
            }
        }, 4000);
    
        // 2. Error Handler
        window.addEventListener('error', function(e) {
            console.error("Global Error:", e);
            // Jika error terjadi saat loading masih ada, matikan loading
            const loader = document.getElementById('loading-screen');
            if (loader && !loader.classList.contains('hidden')) {
                loader.classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>