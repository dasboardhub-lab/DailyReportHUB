<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DailyReport v3.3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        primary: '#4361ee', 
                        primaryDark: '#3a0ca3',
                        primaryLight: '#f2f5ff',
                        secondary: '#64748b',
                        success: '#06d6a0', 
                        danger: '#ef476f', 
                        warning: '#ffd166',
                        dark: '#1e293b',
                        surface: '#ffffff',
                        background: '#f8fafc',
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'card': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 40px -10px rgba(67, 97, 238, 0.3)',
                        'glow': '0 0 15px rgba(67, 97, 238, 0.3)',
                        'input': '0 2px 6px rgba(0,0,0,0.04)', 
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #f1f5f9; 
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, hsla(253,16%,7%,0) 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0.1) 0, hsla(225,39%,30%,0) 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, hsla(339,49%,30%,0) 50%);
            -webkit-tap-highlight-color: transparent; 
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hide { -ms-overflow-style: none;  scrollbar-width: none; }

        .table-scroll-container {
            max-height: 500px;
            overflow-y: auto;
        }

        #dynamic-island-container { pointer-events: none; z-index: 10000; }
        #dynamic-island {
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
            transform-origin: top center;
        }
        .island-hidden { opacity: 0; transform: translateY(-40px) scale(0.5); pointer-events: none !important; }
        .island-loading { width: 120px; height: 40px; border-radius: 99px; justify-content: center; background: #0f172a; }
        .island-expanded { width: auto; min-width: 240px; height: 52px; border-radius: 99px; padding: 0 24px; justify-content: start; background: #0f172a; }
        .island-error .island-icon-bg { background: #ef476f; }
        .island-success .island-icon-bg { background: #06d6a0; }

        .nav-link { 
            position: relative; color: #64748b; transition: all 0.3s ease;
            cursor: pointer; padding: 0.75rem 1.25rem; border-radius: 1rem; font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .nav-link i { font-size: 1.1em; transition: transform 0.3s; }
        .nav-link:hover { color: #4361ee; background: rgba(67, 97, 238, 0.05); }
        .nav-link:hover i { transform: scale(1.1); }
        .nav-link.active { 
            color: #4361ee; background: rgba(67, 97, 238, 0.1); font-weight: 700; 
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.1);
        }
        
        .mobile-nav-item { 
            color: #94a3b8; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; padding: 0.5rem; border-radius: 1rem;
        }
        .mobile-nav-item:active { transform: scale(0.9); }
        .mobile-nav-item.active { 
            color: #4361ee; background: rgba(67, 97, 238, 0.1); 
            transform: translateY(-8px); box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
        }
        .mobile-nav-item.active i { transform: scale(1.1); }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .abs-cell { min-width: 40px; text-align: center; border-right: 1px solid #f1f5f9; font-size: 11px; vertical-align: middle; }
        .abs-header { position: sticky; top: 0; background: #f8fafc; z-index: 20; font-size: 10px; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
        .abs-name-col { position: sticky; left: 0; background: white; z-index: 30; border-right: 1px solid #e2e8f0; min-width: 140px; box-shadow: 4px 0 10px -5px rgba(0,0,0,0.02); }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); backdrop-filter: blur(15px); transition: opacity 0.4s ease-out; }
        .hidden-fade { opacity: 0; pointer-events: none; }
        
        button:active { transform: scale(0.96); }
        .kpi-card { transition: all 0.3s ease; border: 1px solid transparent; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.08); border-color: rgba(67, 97, 238, 0.2); }
        
        /* New Filter Style */
        .filter-container {
            display: flex; gap: 0.5rem; align-items: center; 
            background: white; border: 1px solid #e2e8f0; 
            padding: 0.35rem 0.75rem; border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .filter-container:hover { border-color: #cbd5e1; }
        .filter-input-date { background: transparent; border: none; font-size: 0.75rem; font-weight: 700; color: #334155; width: 85px; outline: none; padding: 0; }
        
        /* Hub Buttons */
        .hub-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s;
            border: 1px solid transparent;
            text-transform: uppercase;
        }
        .hub-btn.active {
            background-color: #4361ee;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            border-color: #4361ee;
        }
        .hub-btn.inactive {
            background-color: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        .hub-btn.inactive:hover {
            border-color: #4361ee;
            color: #4361ee;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-700 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-700 bg-slate-50">

    <!-- DYNAMIC ISLAND -->
    <div id="dynamic-island-container" class="fixed top-6 left-0 right-0 flex justify-center">
        <div id="dynamic-island" class="island-hidden flex items-center text-white group relative overflow-hidden ring-1 ring-white/10">
            <div id="island-spinner" class="absolute inset-0 flex items-center justify-center transition-opacity duration-300">
                <div class="flex space-x-1.5">
                    <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-1.5 h-1.5 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
            <div id="island-content" class="flex items-center gap-3 w-full opacity-0 transition-opacity duration-300">
                <div id="island-icon-bg" class="w-7 h-7 rounded-full flex items-center justify-center bg-white/20 island-icon-bg backdrop-blur-md">
                    <i id="island-icon" class="fas fa-check text-[10px]"></i>
                </div>
                <div class="flex flex-col justify-center">
                    <span id="island-title" class="text-[9px] uppercase font-bold opacity-60 tracking-widest leading-none mb-0.5">Status</span>
                    <span id="island-message" class="text-xs font-semibold whitespace-nowrap leading-none">Berhasil</span>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVBARS -->
    <nav id="app-navbar" class="glass-nav sticky top-0 z-50 hidden transition-all duration-300 md:flex">
        <div class="w-full px-6 md:px-12 mx-auto">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-3 flex-shrink-0">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20 text-white transform hover:scale-105 transition-transform duration-300 border border-white/20">
                        <i class="fas fa-boxes-stacked text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-extrabold text-lg tracking-tight leading-none text-slate-800">DAILY<span class="text-primary">REPORT</span></h1>
                        <p class="text-[10px] text-slate-400 font-bold tracking-widest mt-0.5 uppercase">Operational System</p>
                    </div>
                </div>

                <div class="hidden md:flex items-center justify-center absolute left-1/2 transform -translate-x-1/2">
                    <div class="flex items-center gap-1 bg-slate-100/50 p-1.5 rounded-2xl border border-slate-200/50 backdrop-blur-sm">
                        <a onclick="window.navigate('dashboard')" id="nav-dashboard" class="nav-link active">
                            <i class="fas fa-chart-pie"></i> <span>Dashboard</span>
                        </a>
                        <a onclick="window.navigate('laporan')" id="nav-laporan" class="nav-link">
                            <i class="fas fa-file-contract"></i> <span>Laporan</span>
                        </a>
                        <a onclick="window.navigate('absensi')" id="nav-absensi" class="nav-link">
                            <i class="fas fa-user-check"></i> <span>Absensi</span>
                        </a>
                        <a onclick="window.navigate('pengaturan')" id="nav-pengaturan" class="nav-link hidden">
                            <i class="fas fa-cog"></i> <span>Pengaturan</span>
                        </a>
                    </div>
                </div>

                <div class="flex items-center gap-4 pl-6 flex-shrink-0">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm font-bold text-slate-700 truncate max-w-[120px]" id="user-name-display">User</div>
                        <div class="text-[10px] text-primary font-bold tracking-wider bg-blue-50 px-2 py-0.5 rounded-full inline-block mt-0.5 border border-blue-100" id="user-badge">ROLE</div>
                    </div>
                    <button onclick="window.doLogout()" class="w-10 h-10 rounded-xl bg-white hover:bg-red-50 hover:text-danger text-slate-400 transition-all duration-300 flex items-center justify-center group border border-slate-200 shadow-sm" title="Keluar">
                        <i class="fas fa-power-off text-sm group-hover:scale-110 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Topbar -->
    <div id="mobile-topbar" class="md:hidden glass-nav px-6 py-4 flex justify-between items-center shadow-md z-40 hidden sticky top-0 bg-white/90 backdrop-blur-lg">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 border border-white/20">
                <i class="fas fa-boxes-stacked text-sm"></i>
            </div>
            <div>
                 <span class="font-extrabold text-lg tracking-tight text-slate-800 block leading-tight">DailyReport</span>
                 <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Mobile Ops</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <div class="text-right">
                <div class="text-[11px] font-bold text-slate-700 truncate max-w-[100px]" id="mob-user-name">User</div>
                <div class="text-[9px] text-slate-400 font-medium truncate max-w-[100px]">Logged in</div>
            </div>
            <button onclick="window.doLogout()" class="text-slate-400 hover:text-danger bg-slate-50 p-2.5 rounded-xl border border-slate-200 hover:border-red-200 transition">
                <i class="fas fa-power-off text-xs"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Bottom Nav -->
    <div id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-slate-200/60 shadow-[0_-8px_30px_rgba(0,0,0,0.08)] z-50 flex justify-around items-center pb-safe hidden px-6 py-3 rounded-t-3xl safe-area-bottom">
        <button onclick="window.navigate('dashboard')" id="mob-nav-dashboard" class="mobile-nav-item active flex-1 flex flex-col items-center gap-1.5">
            <i class="fas fa-chart-pie text-lg"></i>
            <span class="text-[10px] font-bold tracking-wide">Dash</span>
        </button>
        <button onclick="window.navigate('laporan')" id="mob-nav-laporan" class="mobile-nav-item flex-1 flex flex-col items-center gap-1.5">
            <i class="fas fa-file-contract text-lg"></i>
            <span class="text-[10px] font-bold tracking-wide">Lapor</span>
        </button>
        <button onclick="window.navigate('absensi')" id="mob-nav-absensi" class="mobile-nav-item flex-1 flex flex-col items-center gap-1.5">
            <i class="fas fa-user-check text-lg"></i>
            <span class="text-[10px] font-bold tracking-wide">Absen</span>
        </button>
        <button onclick="window.navigate('pengaturan')" id="mob-nav-pengaturan" class="mobile-nav-item flex-1 flex flex-col items-center gap-1.5 hidden">
            <i class="fas fa-cog text-lg"></i>
            <span class="text-[10px] font-bold tracking-wide">Atur</span>
        </button>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section" class="fixed inset-0 z-50 bg-slate-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-[-20%] left-[-10%] w-[50rem] h-[50rem] rounded-full bg-blue-400/20 blur-[100px] opacity-60 animate-pulse" style="animation-duration: 4s;"></div>
            <div class="absolute bottom-[-20%] right-[-10%] w-[40rem] h-[40rem] rounded-full bg-purple-400/20 blur-[100px] opacity-60 animate-pulse" style="animation-duration: 6s;"></div>
        </div>
        
        <div class="glass p-8 md:p-12 rounded-[2.5rem] shadow-glass w-full max-w-sm border border-white/60 relative fade-in z-10 m-6">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-gradient-to-tr from-primary to-primaryDark rounded-[2rem] mx-auto flex items-center justify-center shadow-glow mb-6 rotate-6 transition-transform hover:rotate-0">
                    <i class="fas fa-chart-simple text-white text-5xl drop-shadow-md"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-slate-800 mb-1 tracking-tight">DailyReport</h2>
                <p class="text-slate-400 text-xs font-semibold tracking-wide uppercase">Operational Management System</p>
            </div>
            
            <div class="flex p-1.5 bg-slate-100/80 rounded-2xl mb-8 border border-slate-200/60">
                <button onclick="window.switchLoginTab('user')" id="tab-user" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all shadow-sm bg-white text-primary ring-1 ring-black/5 uppercase tracking-wide">User Team</button>
                <button onclick="window.switchLoginTab('admin')" id="tab-admin" class="flex-1 py-3 rounded-xl text-xs font-bold text-slate-400 hover:text-slate-600 transition-all uppercase tracking-wide">Admin</button>
            </div>

            <form id="form-login-user" class="space-y-6">
                <div class="relative group">
                    <input type="text" id="login-id" class="peer block px-4 py-4 w-full text-sm text-slate-900 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold pl-12 shadow-sm" placeholder="Masukkan ID">
                    <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 peer-focus:text-primary transition-colors text-lg"></i>
                    <label for="login-id" class="absolute text-xs font-bold text-slate-400 bg-slate-50 px-2 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-12 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-12 cursor-text rounded-md">ID User</label>
                </div>
                <div>
                    <label class="flex items-center cursor-pointer group select-none">
                        <div class="relative">
                            <input type="checkbox" id="is-pic-checkbox" class="peer sr-only" onchange="window.togglePasswordField()">
                            <div class="w-10 h-6 bg-slate-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-100 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary shadow-inner"></div>
                        </div>
                        <span class="ml-3 text-xs font-bold text-slate-500 group-hover:text-primary transition">Login sebagai Leader / PIC?</span>
                    </label>
                    <div class="relative group mt-4 hidden overflow-hidden transition-all duration-300 origin-top" id="login-pass-container">
                        <input type="password" id="login-pass-user" class="peer block px-4 py-4 w-full text-sm text-slate-900 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold pl-12 shadow-sm" placeholder="Password">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 peer-focus:text-primary transition-colors text-lg"></i>
                        <label for="login-pass-user" class="absolute text-xs font-bold text-slate-400 bg-slate-50 px-2 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-12 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-12 cursor-text rounded-md">Kata Sandi</label>
                    </div>
                </div>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-primary to-primaryDark hover:shadow-glow text-white rounded-2xl font-bold shadow-float transition-all transform hover:-translate-y-1 active:scale-95 text-sm uppercase tracking-wider flex items-center justify-center gap-2">
                    <span>Masuk Aplikasi</span> <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <form id="form-login-admin" class="space-y-6 hidden">
                <div class="relative group">
                    <input type="password" id="login-pass-admin" class="peer block px-4 py-4 w-full text-sm text-slate-900 bg-slate-50 rounded-2xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-slate-800 focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold pl-12 shadow-sm" placeholder="Kunci Admin" required>
                    <i class="fas fa-shield-alt absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 peer-focus:text-slate-800 transition-colors text-lg"></i>
                    <label for="login-pass-admin" class="absolute text-xs font-bold text-slate-400 bg-slate-50 px-2 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] peer-focus:px-2 peer-focus:text-slate-800 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-12 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-12 cursor-text rounded-md">Password Admin</label>
                </div>
                <button type="submit" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-2xl font-bold shadow-lg transition-all transform hover:-translate-y-1 active:scale-95 text-sm uppercase tracking-wider">MASUK SYSTEM</button>
            </form>

            <div id="init-error-container" class="mt-6 p-4 bg-red-50 border border-red-100 rounded-2xl hidden animate-pulse">
                <div class="flex items-center gap-2 text-danger mb-1"><i class="fas fa-wifi"></i><span class="text-xs font-bold">Gagal Terhubung</span></div>
                <p id="init-error-text" class="text-[10px] text-red-400 leading-relaxed"></p>
                <button onclick="location.reload()" class="w-full mt-3 text-xs bg-white border border-red-200 text-danger py-2 rounded-lg font-bold hover:bg-red-50 transition">Coba Lagi</button>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-slate-100 border-t-primary rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-cube text-primary text-2xl animate-pulse"></i>
            </div>
        </div>
        <div id="loading-logs" class="hidden"></div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 pb-44 md:pb-12 hidden scroll-smooth">
        <div class="w-full px-2 md:px-4 space-y-8">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-content fade-in space-y-6">
                <!-- NEW DASHBOARD HEADER LAYOUT -->
                <div class="glass p-5 rounded-3xl shadow-sm border border-white/50 relative z-30">
                    <div class="flex flex-col 2xl:flex-row 2xl:items-center justify-between gap-6">
                        <div class="shrink-0">
                            <h2 class="text-2xl font-extrabold text-slate-800 tracking-tight">Dashboard</h2>
                            <p class="text-xs text-slate-500 font-medium mt-1">Ringkasan Kinerja & Analisis Operasional</p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row items-end gap-3 w-full bg-slate-50/50 p-2 rounded-2xl border border-slate-100/50 overflow-hidden">
                            <!-- SPACER: Mendorong elemen berikutnya ke kanan -->
                            <div class="hidden sm:block flex-1"></div>

                            <!-- Date Range Group -->
                            <div class="flex flex-col gap-1 shrink-0">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Rentang Waktu</span>
                                <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl px-3 py-2 shadow-sm transition hover:border-primary/30 group w-fit h-[38px]">
                                    <i class="far fa-calendar text-slate-400 group-hover:text-primary transition-colors text-xs"></i>
                                    <input type="date" id="dash-start-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.loadDashboardData()">
                                    <span class="text-slate-300 text-[10px] font-bold mx-0.5">SD</span>
                                    <input type="date" id="dash-end-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.loadDashboardData()">
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="hidden sm:block w-px h-8 bg-slate-200 mx-1 self-end mb-1"></div>

                            <!-- Hub Filter Group -->
                            <div class="flex flex-col gap-1 overflow-hidden shrink max-w-[600px]">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Filter Area</span>
                                <div class="flex items-center gap-2 h-[38px]">
                                    <div id="hub-filter-container" class="flex items-center gap-2 overflow-x-auto px-1 scrollbar-hide mask-linear h-full">
                                        <!-- Buttons injected by JS -->
                                    </div>
                                    <!-- Reset Button -->
                                    <button onclick="window.resetDashboardFilters()" class="bg-white text-slate-400 hover:text-primary border border-slate-200 hover:border-primary/30 p-2 rounded-xl shadow-sm transition h-full w-9 flex items-center justify-center shrink-0" title="Reset Filter">
                                        <i class="fas fa-undo-alt text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 relative z-10">
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-12 h-12 bg-blue-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">Total MPP</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-800 mt-1 relative z-10 tracking-tight truncate" id="kpi-total-mpp">0</h3>
                        <div id="diff-total-mpp" class="relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-12 h-12 bg-slate-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">Staging</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-700 mt-1 relative z-10 tracking-tight truncate" id="kpi-staging">0</h3>
                        <div id="diff-staging" class="relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-12 h-12 bg-slate-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">Gateway</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-700 mt-1 relative z-10 tracking-tight truncate" id="kpi-gateway">0</h3>
                        <div id="diff-gateway" class="relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden">
                         <div class="absolute top-0 right-0 w-12 h-12 bg-slate-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">JNE</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-700 mt-1 relative z-10 tracking-tight truncate" id="kpi-jne">0</h3>
                        <div id="diff-jne" class="relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden">
                         <div class="absolute top-0 right-0 w-12 h-12 bg-slate-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest relative z-10">SAP</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-700 mt-1 relative z-10 tracking-tight truncate" id="kpi-sap">0</h3>
                        <div id="diff-sap" class="relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card kpi-card group relative overflow-hidden border-b-4 border-primary">
                        <div class="absolute top-0 right-0 w-12 h-12 bg-blue-50 rounded-bl-3xl -mr-2 -mt-2"></div>
                        <p class="text-[9px] font-bold text-primary uppercase tracking-widest relative z-10">Total Paket</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-800 mt-1 tracking-tight truncate relative z-10" id="kpi-total-paket">0</h3>
                        <div id="diff-total-paket" class="mt-1 relative z-10"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card border-b-4 border-success kpi-card group">
                        <p class="text-[9px] font-bold text-success uppercase tracking-widest">Prod.</p>
                        <h3 class="text-xl md:text-2xl font-extrabold text-slate-800 mt-1 tracking-tight truncate" id="kpi-avg-prod">0</h3>
                        <div id="diff-avg-prod"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-card border-b-4 border-danger kpi-card group">
                        <p class="text-[9px] font-bold text-danger uppercase tracking-widest">Cost</p>
                        <h3 class="text-lg md:text-xl font-extrabold text-slate-800 mt-2 truncate tracking-tight" id="kpi-total-cost">Rp 0</h3>
                        <div id="diff-total-cost"></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100/60">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-primary shadow-sm"><i class="fas fa-chart-area"></i></div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Trend Tahunan</h3>
                                <p class="text-[10px] text-slate-400">Analisis pergerakan volume paket</p>
                            </div>
                        </div>
                        <div class="h-64"><canvas id="chart-annual"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100/60">
                         <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center text-emerald-600 shadow-sm"><i class="fas fa-chart-line"></i></div>
                             <div>
                                <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Trend Harian</h3>
                                <p class="text-[10px] text-slate-400">Monitoring harian productivity</p>
                            </div>
                        </div>
                        <div class="h-64"><canvas id="chart-daily"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white rounded-3xl shadow-sm border border-slate-100/60 overflow-hidden flex flex-col h-fit">
                        <div class="p-6 border-b border-slate-50 flex items-center gap-3 bg-white">
                             <div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center text-amber-500"><i class="fas fa-trophy"></i></div>
                            <h3 class="font-bold text-slate-700 text-sm">Top Performa</h3>
                        </div>
                        <div class="overflow-x-auto table-scroll-container" style="max-height: 500px;">
                            <table class="w-full text-xs text-center">
                                <thead class="text-slate-400 bg-slate-50/50 uppercase font-bold sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                    <tr>
                                        <th class="px-3 py-4 text-left pl-6">HUB</th><th class="px-2 py-4 text-primary">MPP</th>
                                        <th class="px-3 py-4 text-slate-700">Out.</th><th class="px-2 py-4 text-success">Prod</th><th class="px-3 py-4 text-right pr-6 text-slate-400">Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-hub-breakdown" class="text-slate-600 divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-100/60 overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-white">
                            <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="fas fa-list text-slate-400 bg-slate-100 p-1.5 rounded-lg"></i> Rincian Data</h3>
                            <button onclick="window.exportTableToCSV('table-daily-detail', 'rincian.csv')" class="text-[10px] font-bold text-primary bg-blue-50 px-4 py-2 rounded-xl hover:bg-blue-100 transition border border-blue-100"><i class="fas fa-download mr-1"></i> EXPORT CSV</button>
                        </div>
                        <div class="overflow-x-auto flex-1 table-scroll-container">
                            <table id="table-daily-detail" class="w-full text-xs text-center whitespace-nowrap">
                                <thead class="text-slate-400 bg-slate-50/50 uppercase font-bold sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                    <tr>
                                        <th class="px-3 py-4 text-left pl-6 tracking-wider">Tanggal</th><th class="px-3 py-4 tracking-wider">HUB</th><th class="px-3 py-4 text-primary tracking-wider">MPP</th>
                                        <th class="px-3 py-4 text-slate-400">Stg</th><th class="px-3 py-4 text-slate-400">Gtw</th>
                                        <th class="px-3 py-4 text-slate-400">JNE</th><th class="px-3 py-4 text-slate-400">SAP</th>
                                        <th class="px-3 py-4 font-extrabold text-slate-700 bg-slate-50/80">Total</th><th class="px-3 py-4">Prod.</th><th class="px-3 py-4 text-right pr-6 text-slate-500">Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-daily-detail" class="text-slate-600 divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bagian Baru: Log Kendala & Catatan -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100/60 mt-6">
                    <div class="flex items-center gap-3 mb-4 border-b border-slate-50 pb-4">
                         <div class="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center text-orange-500 shadow-sm"><i class="fas fa-clipboard-list"></i></div>
                         <div>
                            <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide">Log Kendala & Catatan Operasional</h3>
                            <p class="text-[10px] text-slate-400">Rekapitulasi isu lapangan berdasarkan filter tanggal</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="dashboard-notes-container">
                        <!-- Content populated by JS -->
                    </div>
                    <div id="dashboard-notes-empty" class="hidden text-center py-8 text-slate-400 text-xs italic">Tidak ada catatan kendala pada periode ini.</div>
                </div>

                <!-- MOVED: EXECUTIVE BRIEF SECTION -->
                <div id="manager-summary-section" class="hidden bg-gradient-to-r from-slate-800 to-slate-900 rounded-3xl p-6 shadow-xl text-white relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 blur-3xl group-hover:bg-white/10 transition duration-700"></div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center relative z-10 gap-4 mb-6">
                        <div>
                            <h3 class="font-bold text-lg text-white flex items-center gap-2"><i class="fas fa-briefcase text-blue-300"></i> SUMMARY REPORT HUB KALSULAMP</h3>
                            <p class="text-xs text-slate-400 mt-1">Ringkasan agregat dari data input tim untuk pelaporan ke Management</p>
                        </div>
                        <button onclick="window.copyManagerSummary()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-blue-500/50 shadow-lg shadow-blue-500/20 active:scale-95">
                            <i class="far fa-copy"></i> SALIN UNTUK MANAGER
                        </button>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-white/5 rounded-2xl border border-white/10" id="manager-summary-stats">
                        <!-- Content populated by JS -->
                    </div>
                </div>

            </div>

            <!-- VIEW: LAPORAN -->
             <div id="view-laporan" class="view-content hidden fade-in space-y-5">
                <!-- NEW LAPORAN HEADER LAYOUT (MATCHING DASHBOARD) -->
                <div class="glass p-5 rounded-3xl shadow-sm border border-white/50 relative z-30">
                     <div class="flex flex-col 2xl:flex-row 2xl:items-center justify-between gap-6">
                        <div class="shrink-0">
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Laporan Harian</h2>
                            <p class="text-xs text-slate-500 font-medium mt-1">Rekapitulasi data operasional & absensi</p>
                        </div>

                        <div class="flex flex-col sm:flex-row items-end gap-3 w-full bg-slate-50/50 p-2 rounded-2xl border border-slate-100/50 overflow-hidden">
                            <!-- SPACER: Mendorong elemen berikutnya ke kanan -->
                            <div class="hidden sm:block flex-1"></div>

                            <!-- Date Filter -->
                            <div class="flex flex-col gap-1 shrink-0">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Rentang Waktu</span>
                                <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl px-3 py-2 shadow-sm transition hover:border-primary/30 group w-fit h-[38px]">
                                    <i class="far fa-calendar text-slate-400 group-hover:text-primary transition-colors text-xs"></i>
                                    <input type="date" id="lap-start-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.renderLaporanList()">
                                    <span class="text-slate-300 font-bold mx-0.5 text-[10px]">SD</span>
                                    <input type="date" id="lap-end-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.renderLaporanList()">
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="hidden sm:block w-px h-8 bg-slate-200 mx-1 self-end mb-1"></div>

                            <!-- Hub Filter -->
                            <div class="flex flex-col gap-1 overflow-hidden shrink max-w-[400px]">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Filter Area</span>
                                <div id="lap-hub-filter-container" class="hidden items-center gap-2 overflow-x-auto px-1 scrollbar-hide mask-linear h-[38px]">
                                    <!-- Buttons injected by JS -->
                                </div>
                            </div>

                            <button onclick="window.openLaporanModal()" class="bg-primary hover:shadow-float text-white px-5 py-2 rounded-xl font-bold text-xs transition hidden flex items-center justify-center gap-2 active:scale-95 group shadow-lg shadow-blue-500/30 shrink-0 h-[38px]" id="btn-tambah-laporan">
                                <div class="w-5 h-5 bg-white/20 rounded-full flex items-center justify-center group-hover:scale-110 transition"><i class="fas fa-plus text-[9px]"></i></div> <span class="hidden sm:inline tracking-wide">BUAT BARU</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-card border border-slate-100/50 overflow-hidden flex flex-col h-[70vh]">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-xs text-left text-slate-600 whitespace-nowrap">
                            <thead class="text-slate-400 uppercase bg-slate-50 border-b border-slate-100 font-bold sticky top-0 z-20 shadow-sm">
                                <tr>
                                    <th class="px-6 py-4 bg-slate-50">Tanggal</th><th class="px-4 py-4 bg-slate-50">HUB</th>
                                    <th class="px-2 py-4 bg-slate-50 text-right">Gtw</th><th class="px-2 py-4 bg-slate-50 text-right">Stg</th><th class="px-2 py-4 bg-slate-50 text-right">JNE</th><th class="px-2 py-4 bg-slate-50 text-right">SAP</th>
                                    <th class="px-4 py-4 bg-slate-100/50 font-bold text-slate-800 text-right">Total</th>
                                    <th class="px-4 py-4 text-primary bg-slate-50 text-right">MPP</th><th class="px-4 py-4 text-success bg-slate-50 text-right">Prod</th>
                                    <th class="px-6 py-4 text-right bg-slate-50">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="laporan-list-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                    <div id="empty-laporan-msg" class="hidden text-center py-24 flex flex-col items-center justify-center">
                        <div class="w-20 h-20 rounded-full bg-slate-50 flex items-center justify-center mb-4 text-slate-300 animate-pulse"><i class="fas fa-folder-open text-3xl"></i></div>
                        <p class="text-slate-400 text-sm font-medium">Belum ada laporan yang tersedia.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: ABSENSI -->
             <div id="view-absensi" class="view-content hidden fade-in space-y-6">
                <!-- NEW ABSENSI HEADER LAYOUT (MATCHING DASHBOARD) -->
                <div class="glass p-5 rounded-3xl shadow-sm border border-white/50 relative z-30">
                    <div class="flex flex-col 2xl:flex-row 2xl:items-center justify-between gap-6">
                         <div class="shrink-0">
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Absensi</h2>
                            <p class="text-xs text-slate-500 font-medium mt-1">Monitoring kehadiran tim</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-end gap-3 w-full bg-slate-50/50 p-2 rounded-2xl border border-slate-100/50 overflow-hidden">
                             <!-- SPACER -->
                             <div class="hidden sm:block flex-1"></div>

                             <!-- Date Range -->
                             <div class="flex flex-col gap-1 shrink-0">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Rentang Waktu</span>
                                <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-xl px-3 py-2 shadow-sm transition hover:border-primary/30 group w-fit h-[38px]">
                                    <i class="far fa-calendar text-slate-400 group-hover:text-primary transition-colors text-xs"></i>
                                    <input type="date" id="abs-start-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.loadAbsensiData()">
                                    <span class="text-slate-300 font-bold mx-0.5 text-[10px]">SD</span>
                                    <input type="date" id="abs-end-date" class="filter-input-date w-[85px] text-center cursor-pointer" onchange="window.loadAbsensiData()">
                                </div>
                            </div>
                            
                            <!-- Separator -->
                            <div class="hidden sm:block w-px h-8 bg-slate-200 mx-1 self-end mb-1"></div>

                            <!-- Hub Selector -->
                            <div class="flex flex-col gap-1 overflow-hidden shrink max-w-[400px]">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider ml-1">Filter Area</span>
                                <div class="flex items-center gap-2 h-[38px]">
                                    <div id="abs-hub-filter-container" class="flex items-center gap-2 overflow-x-auto px-1 scrollbar-hide mask-linear h-full">
                                         <!-- Buttons injected by JS -->
                                    </div>
                                    <!-- Refresh -->
                                    <button onclick="window.initAbsensiFilters()" class="bg-white text-slate-400 hover:text-primary border border-slate-200 hover:border-primary/30 p-2 rounded-xl shadow-sm transition h-full w-9 flex items-center justify-center shrink-0">
                                        <i class="fas fa-sync-alt text-[10px]"></i>
                                    </button>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-gradient-to-br from-blue-50 to-white p-6 rounded-3xl shadow-card border border-blue-100/50 flex flex-col justify-between group">
                        <div class="flex justify-between items-start"><p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Total MPP</p><div class="w-10 h-10 rounded-xl bg-blue-100/50 flex items-center justify-center text-primary"><i class="fas fa-users"></i></div></div>
                        <h3 class="text-3xl font-extrabold text-primary mt-2" id="abs-kpi-mpp">0</h3>
                    </div>
                    <div class="bg-gradient-to-br from-rose-50 to-white p-6 rounded-3xl shadow-card border border-rose-100/50 flex flex-col justify-between group">
                        <div class="flex justify-between items-start"><p class="text-[10px] font-bold text-rose-400 uppercase tracking-widest">Total Cost</p><div class="w-10 h-10 rounded-xl bg-rose-100/50 flex items-center justify-center text-danger"><i class="fas fa-coins"></i></div></div>
                        <h3 class="text-3xl font-extrabold text-danger mt-2" id="abs-kpi-cost">Rp 0</h3>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-[50vh]">
                    <div class="overflow-auto flex-1">
                        <div id="absensi-table-container" class="min-h-full bg-white"><div class="flex items-center justify-center h-full text-slate-400 text-xs font-medium flex-col gap-2"><i class="fas fa-search text-3xl opacity-20"></i><p>Silakan pilih filter...</p></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-fit">
                        <div class="p-6 border-b border-slate-50 flex items-center gap-3 bg-white">
                            <div class="w-8 h-8 rounded-lg bg-orange-50 flex items-center justify-center text-orange-500"><i class="fas fa-building"></i></div>
                            <h3 class="font-bold text-slate-700 text-sm">Rekapitulasi per HUB</h3>
                        </div>
                        <div class="overflow-x-auto">
                             <table class="w-full text-xs text-center">
                                <thead class="text-slate-400 bg-slate-50/50 uppercase font-bold sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                    <tr>
                                        <th class="px-4 py-4 text-left">HUB</th>
                                        <th class="px-3 py-4 text-primary">H</th>
                                        <th class="px-3 py-4 text-amber-500">I</th>
                                        <th class="px-3 py-4 text-purple-500">S</th>
                                        <th class="px-3 py-4 text-red-500">A</th>
                                    </tr>
                                </thead>
                                <tbody id="hub-recap-tbody" class="divide-y divide-slate-50 text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-3 bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-50 flex items-center gap-3 bg-white">
                            <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-500"><i class="fas fa-list-alt"></i></div>
                            <h3 class="font-bold text-slate-700 text-sm">Ringkasan Detail Absensi</h3>
                        </div>
                        <div class="overflow-x-auto max-h-[400px]">
                             <table class="w-full text-xs text-left">
                                <thead class="text-slate-400 bg-slate-50/50 uppercase font-bold sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                    <tr>
                                        <th class="px-6 py-4">Nama Personil</th>
                                        <th class="px-2 py-4 text-center text-primary" title="Hadir">H</th>
                                        <th class="px-2 py-4 text-center text-amber-500" title="Ijin">I</th>
                                        <th class="px-2 py-4 text-center text-purple-500" title="Sakit">S</th>
                                        <th class="px-2 py-4 text-center text-red-500" title="Alfa">A</th>
                                        <th class="px-6 py-4 w-1/2">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="absensi-summary-tbody" class="divide-y divide-slate-50 text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-pengaturan" class="view-content hidden fade-in space-y-8">
                 <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Pengaturan</h2>
                        <p class="text-xs text-slate-500 mt-1">Konfigurasi sistem dan pengguna</p>
                    </div>
                    <div class="flex space-x-1 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                        <button onclick="window.switchSettingsTab('users')" id="set-tab-users" class="px-5 py-2.5 rounded-xl text-xs font-bold transition bg-primary/10 text-primary shadow-sm">User</button>
                        <button onclick="window.switchSettingsTab('general')" id="set-tab-general" class="px-5 py-2.5 rounded-xl text-xs font-bold text-slate-500 hover:text-slate-700 transition">Akses</button>
                        <button onclick="window.switchSettingsTab('cost')" id="set-tab-cost" class="px-5 py-2.5 rounded-xl text-xs font-bold text-slate-500 hover:text-slate-700 transition">Cost</button>
                    </div>
                </div>

                <div id="settings-users" class="settings-panel">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Kolom Kiri: Daftar User -->
                        <div class="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-[75vh]">
                            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-white sticky top-0 z-10">
                                <h3 class="font-bold text-slate-800 text-sm">Daftar Pengguna</h3>
                                <button onclick="window.openUserModal()" class="text-[10px] bg-success/10 text-success px-4 py-2 rounded-xl hover:bg-success/20 font-bold transition border border-success/20 flex items-center gap-2 shadow-sm">
                                    <i class="fas fa-user-plus"></i> Tambah
                                </button>
                            </div>
                            <div class="overflow-auto flex-1 custom-scrollbar">
                                <table class="w-full text-xs text-left text-slate-600 relative">
                                    <thead class="text-slate-400 uppercase bg-slate-50/80 backdrop-blur-sm sticky top-0 z-10 font-bold border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-4 tracking-wide pl-8">Nama</th>
                                            <th class="px-4 py-4 tracking-wide">ID</th>
                                            <th class="px-4 py-4 tracking-wide">HUB</th>
                                            <th class="px-4 py-4 tracking-wide">Posisi</th>
                                            <th class="px-6 py-4 text-right tracking-wide pr-8">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-table-body" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Kolom Kanan: Summary -->
                        <div class="lg:col-span-1 bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-fit sticky top-6 flex flex-col">
                            <div class="p-6 border-b border-slate-50 bg-white">
                                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-primary"><i class="fas fa-chart-pie"></i></div>
                                    Ringkasan Tim
                                </h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead class="text-slate-400 uppercase bg-slate-50/50 font-bold border-b border-slate-50">
                                        <tr>
                                            <th class="px-3 py-3 text-left pl-6">HUB</th>
                                            <th class="px-2 py-3 text-left">Posisi</th>
                                            <th class="px-2 py-3 text-center text-emerald-600">Aktif</th>
                                            <th class="px-2 py-3 text-center text-rose-500">Resign</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-summary-tbody" class="divide-y divide-slate-50 text-slate-600 font-medium">
                                        <!-- Diisi Javascript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-4 bg-slate-50 border-t border-slate-100 grid grid-cols-2 gap-3">
                                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                                    <div class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Total Aktif</div>
                                    <div class="text-xl font-extrabold text-slate-700 mt-1" id="sum-total-active">0</div>
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                                    <div class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Total Resign</div>
                                    <div class="text-xl font-extrabold text-rose-500 mt-1" id="sum-total-resign">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings-general" class="settings-panel hidden">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-800 mb-6 text-sm flex items-center gap-2"><i class="fas fa-key text-primary"></i> Password Admin</h3>
                            <div class="mb-5 relative group">
                                <input type="password" id="new-admin-pass" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold shadow-sm" placeholder="Password Baru">
                                <label for="new-admin-pass" class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Password Baru</label>
                            </div>
                            <button onclick="window.saveAdminPass()" class="w-full bg-primary text-white px-4 py-3.5 rounded-xl text-xs font-bold hover:shadow-glow transition shadow-float tracking-wide uppercase">Update Password</button>
                        </div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-800 mb-6 text-sm flex items-center gap-2"><i class="fas fa-lock text-purple-500"></i> Kode Akses Leader</h3>
                            <div class="mb-5 relative group">
                                <input type="text" id="access-code-input" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-purple-500 focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold shadow-sm" placeholder="Kode Baru">
                                <label for="access-code-input" class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-purple-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Kode Baru</label>
                            </div>
                            <button onclick="window.saveAccessCode()" class="w-full bg-purple-600 text-white px-4 py-3.5 rounded-xl text-xs font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-500/20 tracking-wide uppercase">Simpan Kode</button>
                        </div>
                    </div>
                </div>

                <div id="settings-cost" class="settings-panel hidden space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center justify-between"><div><h3 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fas fa-coins text-amber-500"></i> Biaya DW (Global)</h3><p class="text-[10px] text-slate-400 mt-1 ml-6">Tarif harian default untuk DW Manual</p></div><input type="text" id="global-cost-dw" placeholder="Rp 0" class="w-40 text-right font-mono font-bold text-slate-700 border-none bg-slate-100 rounded-xl focus:ring-2 focus:ring-amber-400 text-sm py-2.5 px-4" onkeyup="window.formatCostInput(this)"></div>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 h-fit"><h4 class="font-bold text-slate-800 mb-5 text-sm flex items-center gap-2"><i class="fas fa-plus-circle text-primary"></i> Tambah HUB</h4><div class="space-y-4"><input type="text" id="new-hub-name" placeholder="Kode HUB" class="w-full border border-slate-200 p-3.5 rounded-xl text-xs focus:ring-2 focus:ring-primary outline-none font-bold uppercase"><input type="text" id="new-hub-cost" placeholder="Biaya Sorter (Rp)" class="w-full border border-slate-200 p-3.5 rounded-xl text-xs font-mono text-right focus:ring-2 focus:ring-primary outline-none" onkeyup="window.formatCostInput(this)"><button onclick="window.addHubToTable()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold text-xs hover:bg-slate-900 transition shadow-lg uppercase tracking-wide">Tambah</button></div></div>
                        <div class="md:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><h4 class="font-bold text-slate-800 mb-5 text-sm">Daftar Biaya HUB (Sorter)</h4><div id="cost-container" class="space-y-3 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar"></div><div class="mt-6 pt-5 border-t border-slate-100"><button onclick="window.saveCosts()" class="w-full bg-success text-white py-3.5 rounded-xl font-bold text-xs shadow-lg shadow-green-500/30 hover:bg-emerald-600 transition active:scale-95 uppercase tracking-wide">SIMPAN PERUBAHAN</button></div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- MODAL USER -->
    <div id="user-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-opacity duration-300 px-4">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl transform transition-all scale-95 opacity-0 border border-white/50" id="user-modal-content">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800" id="modal-title">User</h3><button onclick="window.closeUserModal()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-danger transition flex items-center justify-center"><i class="fas fa-times"></i></button></div>
            <form id="user-form" class="space-y-5">
                <input type="hidden" id="edit-user-id">
                <div class="relative group mt-2">
                    <input type="text" id="input-nama" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold shadow-sm" placeholder="Nama Lengkap" required>
                    <label class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Nama Lengkap</label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 tracking-wider ml-1">Kode HUB</label>
                        <select id="input-kode-hub" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:bg-white focus:ring-2 focus:ring-primary outline-none transition font-medium cursor-pointer" required></select>
                    </div>
                    <div>
                         <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 tracking-wider ml-1">Posisi</label>
                         <select id="input-posisi" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:bg-white focus:ring-2 focus:ring-primary outline-none transition font-medium cursor-pointer" onchange="window.toggleUserModalPassword()"><option value="Sorter">Sorter</option><option value="DW">DW</option><option value="LEADER">LEADER</option><option value="Admin">Admin</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 relative group" id="id-container">
                         <input type="text" id="input-id" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold shadow-sm" placeholder="ID User" required>
                         <label class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">ID User</label>
                    </div>
                    <div class="hidden col-span-1 relative group" id="password-container">
                        <input type="text" id="input-sandi" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-semibold shadow-sm" placeholder="Kata Sandi">
                        <label class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Kata Sandi</label>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-indigo-50 p-4 rounded-xl border border-indigo-100/50">
                    <div><span class="block text-xs font-bold text-indigo-900">Akses Edit</span><span class="text-[10px] text-indigo-600">Izinkan ubah data?</span></div>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="input-akses-toggle" class="sr-only peer" onchange="document.getElementById('akses-label').innerText = this.checked ? 'YA' : 'TIDAK'"><div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary shadow-sm"></div><span class="ml-3 text-[10px] font-bold text-indigo-800 w-8" id="akses-label">TIDAK</span></label>
                </div>

                <!-- NEW: Toggle Resign -->
                <div class="flex items-center justify-between bg-rose-50 p-4 rounded-xl border border-rose-100/50">
                    <div><span class="block text-xs font-bold text-rose-900">Status Resign</span><span class="text-[10px] text-rose-600">Karyawan Non-Aktif?</span></div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="input-resign-toggle" class="sr-only peer" onchange="window.toggleResignDate()">
                        <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rose-500 shadow-sm"></div>
                    </label>
                </div>
                <div id="resign-date-container" class="hidden relative group mt-2">
                     <input type="date" id="input-tanggal-resign" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-white rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-rose-500 appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm">
                     <label class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-rose-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Tanggal Resign</label>
                </div>

                <div class="pt-6 border-t border-slate-100 flex justify-end gap-3">
                    <button type="button" onclick="window.closeUserModal()" class="px-5 py-2.5 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-100 transition">Batal</button>
                    <button type="submit" class="px-6 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition transform active:scale-95 tracking-wide uppercase">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL LAPORAN -->
    <div id="laporan-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-[2rem] w-full max-w-5xl shadow-2xl my-6 mx-4 flex flex-col max-h-[90vh] transform transition-all scale-95 opacity-0 border border-white/40" id="laporan-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20 rounded-t-[2rem] shadow-sm">
                <div><h3 class="text-xl font-bold text-slate-800" id="laporan-modal-title">Form Laporan</h3></div>
                <button onclick="window.closeLaporanModal()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-danger transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-slate-50/50">
                <form id="laporan-form" class="space-y-8">
                    <input type="hidden" id="edit-laporan-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <div class="relative group mt-1">
                             <input type="date" id="lap-tanggal" class="peer block px-4 py-3.5 w-full text-sm text-slate-900 bg-slate-50 rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary focus:bg-white appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm" required>
                             <label class="absolute text-xs font-bold text-slate-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-transparent px-2 peer-focus:px-2 peer-focus:text-primary peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-placeholder-shown:left-4 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 left-4 cursor-text">Tanggal Laporan</label>
                        </div>
                        <div>
                            <select id="lap-hub-select" class="w-full border-0 ring-1 ring-slate-200 bg-slate-50 p-3.5 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-primary outline-none hidden cursor-pointer transition shadow-sm" onchange="window.loadHubUsersForAttendance()"></select>
                            <input type="text" id="lap-hub-text" class="w-full border-0 ring-1 ring-slate-200 bg-slate-100 p-3.5 rounded-xl text-sm font-bold text-slate-500 cursor-not-allowed hidden shadow-sm" readonly>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-700 mb-4 text-sm flex items-center"><span class="w-8 h-8 rounded-lg bg-blue-100 text-primary flex items-center justify-center mr-3"><i class="fas fa-box"></i></span>Metrix Paket</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-5">
                            <div class="relative group">
                                <input type="text" id="lap-gateway" class="peer block px-4 py-3.5 w-full text-sm font-mono text-right text-slate-900 bg-white rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm" placeholder="0" onkeyup="window.calcMetrics(this)">
                                <label class="absolute text-[10px] font-bold text-slate-400 uppercase tracking-widest top-2 left-4 pointer-events-none">Gateway</label>
                            </div>
                            <div class="relative group">
                                <input type="text" id="lap-staging" class="peer block px-4 py-3.5 w-full text-sm font-mono text-right text-slate-900 bg-white rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm" placeholder="0" onkeyup="window.calcMetrics(this)">
                                <label class="absolute text-[10px] font-bold text-slate-400 uppercase tracking-widest top-2 left-4 pointer-events-none">Staging</label>
                            </div>
                            <div class="relative group">
                                <input type="text" id="lap-jne" class="peer block px-4 py-3.5 w-full text-sm font-mono text-right text-slate-900 bg-white rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm" placeholder="0" onkeyup="window.calcMetrics(this)">
                                <label class="absolute text-[10px] font-bold text-slate-400 uppercase tracking-widest top-2 left-4 pointer-events-none">JNE</label>
                            </div>
                            <div class="relative group">
                                <input type="text" id="lap-sap" class="peer block px-4 py-3.5 w-full text-sm font-mono text-right text-slate-900 bg-white rounded-xl border-0 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary appearance-none focus:outline-none transition-all placeholder-transparent font-bold shadow-sm" placeholder="0" onkeyup="window.calcMetrics(this)">
                                <label class="absolute text-[10px] font-bold text-slate-400 uppercase tracking-widest top-2 left-4 pointer-events-none">SAP</label>
                            </div>
                        </div>
                        <div class="mt-5 grid grid-cols-2 gap-5">
                            <div class="bg-gradient-to-br from-indigo-50 to-white p-5 rounded-2xl border border-indigo-100 text-center shadow-sm"><p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Total Paket</p><p class="text-3xl font-extrabold text-indigo-600 mt-2" id="disp-total-paket">0</p><input type="hidden" id="val-total-paket"></div>
                            <div class="bg-gradient-to-br from-emerald-50 to-white p-5 rounded-2xl border border-emerald-100 text-center shadow-sm"><p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Productivity</p><p class="text-3xl font-extrabold text-emerald-600 mt-2" id="disp-productivity">0</p></div>
                        </div>
                    </div>

                    <!-- BAGIAN CATATAN KENDALA BARU -->
                    <div class="mb-6">
                        <h4 class="font-bold text-slate-700 mb-2 text-sm flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center mr-3"><i class="fas fa-exclamation-triangle"></i></span>
                            Catatan Kendala / Isu Lapangan
                        </h4>
                        <textarea id="lap-catatan" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm focus:ring-2 focus:ring-primary outline-none transition shadow-sm h-24 resize-none" placeholder="Tuliskan kendala operasional, isu system, atau kejadian khusus di sini..."></textarea>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-4"><h4 class="font-bold text-slate-700 text-sm flex items-center"><span class="w-8 h-8 rounded-lg bg-blue-100 text-primary flex items-center justify-center mr-3"><i class="fas fa-users"></i></span>Absensi Tim</h4><div class="text-right bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm"><span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total MPP:</span><span class="font-extrabold text-lg text-slate-800 ml-2" id="disp-total-mpp">0</span></div></div>
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                            <table class="w-full text-xs text-center">
                                <thead class="bg-slate-50 font-bold text-slate-500 uppercase border-b border-slate-200 tracking-wide">
                                    <tr><th class="p-4 text-left w-1/3 pl-6">Nama Personil</th><th class="p-3 w-10 bg-blue-50/50 text-blue-600">1</th><th class="p-3 w-10 bg-blue-50/50 text-blue-600">2</th><th class="p-3 w-10 bg-blue-50/50 text-blue-600 border-r border-slate-200">3</th><th class="p-3 w-10 text-amber-500">I</th><th class="p-3 w-10 text-purple-500">S</th><th class="p-3 w-10 text-red-600">A</th><th class="p-3 text-left">Ket</th><th class="p-3 w-8"></th></tr>
                                </thead>
                                <tbody id="attendance-tbody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <button type="button" onclick="window.addManualDWRow()" class="mt-5 w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-500 text-xs font-bold hover:border-primary hover:text-primary hover:bg-indigo-50 transition flex items-center justify-center gap-2 uppercase tracking-wide"><i class="fas fa-plus-circle"></i> Tambah DW Manual</button>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-slate-100 bg-white sticky bottom-0 z-20 flex justify-end gap-3 rounded-b-[2rem]">
                <button type="button" onclick="window.closeLaporanModal()" class="px-6 py-3 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-50 transition uppercase tracking-wide">Batal</button>
                <button onclick="document.getElementById('laporan-form').requestSubmit()" class="px-8 py-3 bg-primary text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-500/30 hover:shadow-glow hover:bg-blue-600 transition transform active:scale-95 uppercase tracking-wide">SIMPAN LAPORAN</button>
            </div>
        </div>
    </div>

    <!-- MODULE SCRIPT -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, deleteDoc, updateDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDXOfZbVDqtfGB0abQkTeILo-XC6a9xxKI",
            authDomain: "hub-dashboard-92428.firebaseapp.com",
            projectId: "hub-dashboard-92428",
            storageBucket: "hub-dashboard-92428.firebasestorage.app",
            messagingSenderId: "827243064075",
            appId: "1:827243064075:web:21b8e40b88f13b2433d00e"
        };

        const storageId = 'hub-data-v1';
        let app, auth, db;
        
         const SwalTheme = Swal.mixin({
            customClass: {
                popup: 'rounded-[2rem] border border-slate-100 shadow-2xl p-6 font-sans',
                title: 'text-xl font-bold text-slate-800',
                htmlContainer: 'text-sm text-slate-500',
                confirmButton: 'bg-primary text-white px-6 py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 hover:shadow-glow hover:bg-blue-600 transition transform active:scale-95 uppercase tracking-wide mx-2',
                cancelButton: 'bg-slate-100 text-slate-500 px-6 py-3 rounded-xl font-bold text-xs hover:bg-slate-200 transition active:scale-95 uppercase tracking-wide mx-2',
                input: 'w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:bg-white focus:ring-2 focus:ring-primary outline-none transition font-bold shadow-sm'
            },
            buttonsStyling: false
        });
        window.Swal = SwalTheme; 

        const island = document.getElementById('dynamic-island');
        const islandContent = document.getElementById('island-content');
        const islandIcon = document.getElementById('island-icon');
        const islandMsg = document.getElementById('island-message');
        const islandSpinner = document.getElementById('island-spinner');

        window.notify = (msg, type = 'loading') => {
            island.className = 'pointer-events-auto flex items-center justify-center overflow-hidden text-white transition-all duration-500 ease-out shadow-2xl';
            island.classList.remove('island-hidden');
            if (type === 'loading') {
                island.classList.add('island-loading', 'bg-dark');
                islandSpinner.classList.remove('opacity-0');
                islandContent.classList.add('opacity-0', 'scale-90');
            } else {
                island.classList.remove('island-loading');
                island.classList.add('island-expanded');
                if (type === 'success') { island.classList.add('island-success'); islandIcon.className = 'fas fa-check-circle text-white'; }
                else if (type === 'error') { island.classList.add('island-error'); islandIcon.className = 'fas fa-exclamation-circle text-white'; }
                islandSpinner.classList.add('opacity-0');
                setTimeout(() => { islandMsg.innerText = msg; islandContent.classList.remove('opacity-0', 'scale-90'); }, 200);
                setTimeout(() => {
                    islandContent.classList.add('opacity-0', 'scale-90');
                    setTimeout(() => { island.className = 'island-hidden'; island.classList.remove('island-expanded', 'island-success', 'island-error'); }, 200);
                }, 3000);
            }
        };

        let appData = { adminPass: '123456', accessCode: 'SUPERHUB', costDW: 120000, users: [], costs: [], laporan: [] };
        let currentUser = null, annualChart = null, dailyChart = null;
        let isLoggingOut = false;

        function handleAuthSuccess(user) {
            if(isLoggingOut) return;
            window.notify('Terhubung', 'success');
            document.getElementById('loading-overlay').classList.add('hidden-fade');
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('loading-overlay').remove();
            }, 300);
            document.getElementById('login-section').classList.remove('hidden');
            initListeners();
        }

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(err => { console.log('Persistence disabled') });
            onAuthStateChanged(auth, (u) => { 
                if(u) handleAuthSuccess(u); 
            });
            signInAnonymously(auth).catch(e => {
                if(!isLoggingOut) {
                    console.error(e); window.notify('Gagal Koneksi', 'error');
                    document.getElementById('init-error-text').innerText = "Cek koneksi internet.";
                    document.getElementById('init-error-container').classList.remove('hidden');
                }
            });
        } catch(e) { window.notify('Config Error', 'error'); }

        function initListeners() {
            const pub = (c) => collection(db, 'artifacts', storageId, 'public', 'data', c);
            
            onSnapshot(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), (s) => {
                if(s.exists()) { const d = s.data(); appData.adminPass = d.adminPass; appData.accessCode = d.accessCode; appData.costDW = d.costDW; }
                else setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), appData);
            });

            onSnapshot(pub('users'), (s) => { appData.users=[]; s.forEach(d=>appData.users.push(d.data())); if(currentUser) window.renderUserTable(); });
            onSnapshot(pub('costs'), (s) => { appData.costs=[]; s.forEach(d=>appData.costs.push(d.data())); 
                window.renderHubFilterButtons(); // Updated to Buttons
                if(currentUser) { 
                    window.renderCostInputs(); 
                    if(document.getElementById('view-absensi').classList.contains('hidden')===false) window.renderAbsensiHubSelect();
                } 
            });
            
            onSnapshot(pub('laporan'), (s) => { 
                appData.laporan=[]; 
                s.forEach(d=>appData.laporan.push(d.data())); 
                if(currentUser) { 
                    if(!document.getElementById('view-dashboard').classList.contains('hidden')) window.loadDashboardData(); 
                    if(!document.getElementById('view-laporan').classList.contains('hidden')) window.renderLaporanList(); 
                    if(!document.getElementById('view-absensi').classList.contains('hidden')) window.loadAbsensiData();
                } 
            });
        }

        window.Chart.register(ChartDataLabels);
        window.formatNumber = (n) => (!n && n!==0)?'':n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        window.parseFormattedNumber = (s) => { if(!s)return 0; return parseInt(s.toString().replace(/[^0-9]/g,''),10)||0; };
        window.formatCostInput = (e) => { let v=e.value.replace(/[^0-9]/g,''); e.value=window.formatNumber(v); };
        window.formatRupiah = (n) => n==null?'': 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const safeId = (id) => id?id.replace(/'/g,"\\'").replace(/"/g,'&quot;'):'';
        window.getProdColorClass = (val) => val < 600 ? 'bg-red-100 text-red-600 font-bold px-2 py-1 rounded-lg text-[10px]' : 'bg-green-100 text-green-600 font-bold px-2 py-1 rounded-lg text-[10px]';

        // ... existing login code ...

        window.navigate = (id) => {
            document.querySelectorAll('.view-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active', 'text-primary'));
            const dNav = document.getElementById(`nav-${id}`);
            if(dNav) dNav.classList.add('active');
            
            document.querySelectorAll('.mobile-nav-item').forEach(e => e.classList.remove('active', 'text-primary'));
            const mNav = document.getElementById(`mob-nav-${id}`);
            if(mNav) mNav.classList.add('active', 'text-primary');

            if(id==='dashboard') {
                 // UPDATE: Default 30 Hari jika kosong
                 if(!document.getElementById('dash-start-date').value) {
                     const d = new Date();
                     document.getElementById('dash-end-date').valueAsDate = d;
                     d.setDate(d.getDate() - 30);
                     document.getElementById('dash-start-date').valueAsDate = d;
                 }

                 if(document.getElementById('hub-filter-container').children.length === 0) window.renderHubFilterButtons();
                 window.loadDashboardData();
            }
            if(id==='pengaturan') window.loadSettingsUI();
            if(id==='laporan') {
                if(!document.getElementById('lap-start-date').value) {
                    const now = new Date();
                    document.getElementById('lap-end-date').valueAsDate = now;
                    const past = new Date(); past.setDate(past.getDate() - 30);
                    document.getElementById('lap-start-date').valueAsDate = past;
                }
                
                // UPDATED: Render Laporan Hub Buttons logic
                const container = document.getElementById('lap-hub-filter-container');
                if(currentUser.role === 'admin') {
                    container.classList.remove('hidden');
                    container.classList.add('flex');
                    if(container.children.length === 0) window.renderLaporanHubButtons();
                } else {
                    container.classList.add('hidden');
                    container.classList.remove('flex');
                }
                window.renderLaporanList();
            }
            if(id==='absensi') window.initAbsensiFilters();
        };

        // --- DASHBOARD HUB FILTER LOGIC (Keep as is) ---
        window.renderHubFilterButtons = () => {
            const container = document.getElementById('hub-filter-container');
            container.innerHTML = '';
            
            // 1. Tombol "Semua"
            const allBtn = document.createElement('button');
            allBtn.className = 'hub-btn active'; // Default active
            allBtn.dataset.hub = 'ALL';
            allBtn.innerText = 'Semua';
            allBtn.onclick = () => window.toggleHubFilter('ALL');
            container.appendChild(allBtn);

            // 2. Tombol Hubs
            appData.costs.forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'hub-btn inactive';
                btn.dataset.hub = h.hub;
                btn.innerText = h.hub;
                btn.onclick = () => window.toggleHubFilter(h.hub);
                container.appendChild(btn);
            });
        };

        window.toggleHubFilter = (hubName) => {
            const container = document.getElementById('hub-filter-container');
            window.handleHubToggleLogic(container, hubName);
            window.loadDashboardData();
        };
        
        // --- NEW: GENERIC HUB TOGGLE LOGIC ---
        window.handleHubToggleLogic = (container, hubName) => {
             const allBtn = container.querySelector('.hub-btn[data-hub="ALL"]');
             const targetBtn = container.querySelector(`.hub-btn[data-hub="${hubName}"]`);
             
             if(!allBtn || !targetBtn) return;

             if (hubName === 'ALL') {
                // Reset to ALL
                container.querySelectorAll('.hub-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('inactive');
                });
                allBtn.classList.remove('inactive');
                allBtn.classList.add('active');
            } else {
                // If currently ALL is active, deactivate it first
                if (allBtn.classList.contains('active')) {
                    allBtn.classList.remove('active');
                    allBtn.classList.add('inactive');
                }

                // Toggle logic
                if (targetBtn.classList.contains('active')) {
                    targetBtn.classList.remove('active');
                    targetBtn.classList.add('inactive');
                } else {
                    targetBtn.classList.remove('inactive');
                    targetBtn.classList.add('active');
                }

                // Check if any specific hub is still active
                const anyActive = container.querySelector('.hub-btn.active:not([data-hub="ALL"])');
                if (!anyActive) {
                    // Fallback to ALL if none selected
                    allBtn.classList.remove('inactive');
                    allBtn.classList.add('active');
                }
            }
        };

        // --- NEW: LAPORAN HUB FILTER LOGIC ---
        window.renderLaporanHubButtons = () => {
             const container = document.getElementById('lap-hub-filter-container');
             container.innerHTML = '';
             
             const allBtn = document.createElement('button');
             allBtn.className = 'hub-btn active';
             allBtn.dataset.hub = 'ALL';
             allBtn.innerText = 'Semua';
             allBtn.onclick = () => window.toggleLaporanHubFilter('ALL');
             container.appendChild(allBtn);

             appData.costs.forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'hub-btn inactive';
                btn.dataset.hub = h.hub;
                btn.innerText = h.hub;
                btn.onclick = () => window.toggleLaporanHubFilter(h.hub);
                container.appendChild(btn);
            });
        };

        window.toggleLaporanHubFilter = (hubName) => {
             const container = document.getElementById('lap-hub-filter-container');
             window.handleHubToggleLogic(container, hubName);
             window.renderLaporanList();
        };

        // --- NEW: ABSENSI HUB FILTER LOGIC ---
        window.renderAbsensiHubButtons = () => {
             const container = document.getElementById('abs-hub-filter-container');
             container.innerHTML = '';
             
             // If Admin, render All + Hubs. If User, render ONLY their Hub (Active & Disabled)
             if (currentUser.role === 'admin' || currentUser.role === 'pic') {
                 const allBtn = document.createElement('button');
                 allBtn.className = 'hub-btn active';
                 allBtn.dataset.hub = 'ALL';
                 allBtn.innerText = 'Semua';
                 allBtn.onclick = () => window.toggleAbsensiHubFilter('ALL');
                 container.appendChild(allBtn);

                 appData.costs.forEach(h => {
                    const btn = document.createElement('button');
                    btn.className = 'hub-btn inactive';
                    btn.dataset.hub = h.hub;
                    btn.innerText = h.hub;
                    btn.onclick = () => window.toggleAbsensiHubFilter(h.hub);
                    container.appendChild(btn);
                });
             } else {
                 // Single User View
                 const btn = document.createElement('button');
                 btn.className = 'hub-btn active cursor-default';
                 btn.dataset.hub = currentUser.kode_hub;
                 btn.innerText = currentUser.kode_hub;
                 container.appendChild(btn);
             }
        };

        window.toggleAbsensiHubFilter = (hubName) => {
             if (currentUser.role !== 'admin' && currentUser.role !== 'pic') return; // Guard
             const container = document.getElementById('abs-hub-filter-container');
             window.handleHubToggleLogic(container, hubName);
             window.loadAbsensiData();
        };

        window.initDashboardFilters = () => {
            const d = new Date(); document.getElementById('dash-end-date').valueAsDate = d;
            d.setDate(d.getDate()-30); document.getElementById('dash-start-date').valueAsDate = d;
            window.renderHubFilterButtons();
            window.loadDashboardData();
        };

        window.resetDashboardFilters = () => {
            const d = new Date(); document.getElementById('dash-end-date').valueAsDate = d;
            d.setDate(d.getDate()-30); document.getElementById('dash-start-date').valueAsDate = d;
            window.toggleHubFilter('ALL'); // Reset hubs to ALL
        };

        window.loadDashboardData = () => {
            const sEl = document.getElementById('dash-start-date');
            const eEl = document.getElementById('dash-end-date');
            if(!sEl || !eEl) return;

            const s = new Date(sEl.value);
            const e = new Date(eEl.value);
            
            // PERBAIKAN: Scope selector hanya ke container dashboard (#hub-filter-container)
            // Sebelumnya: document.querySelectorAll('.hub-btn.active') -> mengambil tombol dari Laporan/Absensi juga
            const activeBtns = Array.from(document.querySelectorAll('#hub-filter-container .hub-btn.active'));
            
            let hubs = [];
            // If ALL is active (or implicitly if list is empty/contains ALL), we treat hubs as empty list (which means ALL in filter logic)
            const isAll = activeBtns.some(b => b.dataset.hub === 'ALL');
            
            if (!isAll) {
                hubs = activeBtns.map(b => b.dataset.hub);
            }
            
            const data = appData.laporan.filter(l => { 
                const d = new Date(l.tanggal); 
                return d>=s && d<=e && (hubs.length===0 || hubs.includes(l.hub)); 
            }).sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));

            const diffTime = Math.abs(e - s);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            const prevEnd = new Date(s); prevEnd.setDate(prevEnd.getDate() - 1);
            const prevStart = new Date(prevEnd); prevStart.setDate(prevStart.getDate() - diffDays + 1);
            
            const prevData = appData.laporan.filter(l => { 
                const d = new Date(l.tanggal); 
                return d>=prevStart && d<=prevEnd && (hubs.length===0 || hubs.includes(l.hub)); 
            });

            // ... existing calculation logic ...
            const sum = (arr, key) => arr.reduce((acc, curr) => acc + (curr[key]||0), 0);
            const sumCost = (arr) => arr.reduce((acc, curr) => acc + window.calculateReportCost(curr), 0);

            const getStats = (arr) => ({
                pkg: sum(arr, 'total_paket'),
                mpp: sum(arr, 'total_mpp'),
                stg: sum(arr, 'staging'),
                gtw: sum(arr, 'gateway'),
                jne: sum(arr, 'jne'),
                sap: sum(arr, 'sap'),
                cost: sumCost(arr),
                prod: sum(arr, 'total_mpp') > 0 ? Math.round(sum(arr, 'total_paket') / sum(arr, 'total_mpp')) : 0
            });

            const curr = getStats(data);
            const prev = getStats(prevData);

            const render = (id, val, diffId, prevVal, isCost=false) => {
                const el = document.getElementById(id);
                if(el) el.innerText = isCost ? window.formatRupiah(val) : window.formatNumber(val);
                
                const diffEl = document.getElementById(diffId);
                if(diffEl) {
                    const diff = val - prevVal;
                    const pct = prevVal === 0 ? (val === 0 ? 0 : 100) : Math.round((diff / prevVal) * 100);
                    const isUp = diff > 0;
                    const isDown = diff < 0;
                    
                    const colorClass = isUp ? 'text-emerald-600' : (isDown ? 'text-rose-600' : 'text-slate-400');
                    const icon = isUp ? '' : (isDown ? '' : '-');
                    
                    if (diff === 0) {
                         diffEl.innerHTML = `<span class="text-[10px] text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded">- 0%</span>`;
                    } else {
                        diffEl.innerHTML = `
                            <div class="mt-2 flex flex-col items-start">
                                <span class="text-[10px] font-bold ${colorClass}">${icon} ${isCost ? window.formatRupiah(Math.abs(diff)) : window.formatNumber(Math.abs(diff))}</span>
                                <span class="text-[9px] ${colorClass} bg-white px-1.5 py-0.5 rounded-full border border-slate-100 shadow-sm">(${Math.abs(pct)}%)</span>
                            </div>`;
                    }
                }
            };

            render('kpi-total-mpp', curr.mpp, 'diff-total-mpp', prev.mpp);
            render('kpi-staging', curr.stg, 'diff-staging', prev.stg);
            render('kpi-gateway', curr.gtw, 'diff-gateway', prev.gtw);
            render('kpi-jne', curr.jne, 'diff-jne', prev.jne);
            render('kpi-sap', curr.sap, 'diff-sap', prev.sap);
            render('kpi-total-paket', curr.pkg, 'diff-total-paket', prev.pkg);
            render('kpi-avg-prod', curr.prod, 'diff-avg-prod', prev.prod);
            render('kpi-total-cost', curr.cost, 'diff-total-cost', prev.cost, true);

            // Pass hubs array correctly for charts
            // If hubs is empty (ALL), we need to pass all available hubs to charts for correct coloring/data
            const chartHubs = hubs.length > 0 ? hubs : appData.costs.map(c => c.hub);

            window.updateCharts(data, chartHubs); 
            window.updateDashboardTables(data);
            window.renderDashboardNotes(data);
            
            // Trigger Manager Summary Render (Pass Current & Previous Data)
            window.renderManagerBrief(data, prevData);
        };

        window.renderDashboardNotes = (data) => {
            const container = document.getElementById('dashboard-notes-container');
            const emptyMsg = document.getElementById('dashboard-notes-empty');
            container.innerHTML = '';

            const notesData = data.filter(l => l.catatan && l.catatan.trim().length > 0);

            if (notesData.length === 0) {
                emptyMsg.classList.remove('hidden');
                container.classList.add('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                container.classList.remove('hidden');

                notesData.forEach(l => {
                    // Create Date Object
                    const d = new Date(l.tanggal);
                    const dayName = d.toLocaleDateString('id-ID', { weekday: 'long' });
                    const dateStr = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

                    container.innerHTML += `
                        <div class="bg-orange-50/50 p-4 rounded-2xl border border-orange-100 hover:shadow-sm transition group relative">
                             <div class="absolute top-4 right-4 text-orange-200 group-hover:text-orange-300 transition"><i class="fas fa-quote-right text-2xl"></i></div>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-white text-slate-600 border border-slate-100 px-2 py-0.5 rounded-lg text-[10px] font-bold shadow-sm">${l.hub}</span>
                                <span class="text-[10px] font-bold text-orange-600/80 uppercase tracking-wide">${dayName}, ${dateStr}</span>
                            </div>
                            <p class="text-xs text-slate-600 leading-relaxed font-medium relative z-10 whitespace-pre-line">
                                "${l.catatan}"
                            </p>
                        </div>
                    `;
                });
            }
        };
        
        // NEW: FUNCTION TO RENDER MANAGER REPORT SUMMARY
        window.renderManagerBrief = (currData, prevData) => {
            const container = document.getElementById('manager-summary-stats');
            
            if (!container) return;

            // Helper for Summing Data
            const calcStats = (arr) => {
                let stats = {
                    pkt: 0, mpp: 0, cost: 0,
                    stg: 0, gtw: 0, jne: 0, sap: 0, lastMile: 0,
                    hubMap: {} // { hubName: { pkt: 0, mpp: 0 } }
                };
                
                arr.forEach(r => {
                    stats.pkt += r.total_paket || 0;
                    stats.mpp += r.total_mpp || 0;
                    stats.cost += window.calculateReportCost(r);
                    stats.stg += r.staging || 0;
                    stats.gtw += r.gateway || 0;
                    stats.jne += r.jne || 0;
                    stats.sap += r.sap || 0;

                    if (!stats.hubMap[r.hub]) stats.hubMap[r.hub] = { pkt: 0, mpp: 0 };
                    stats.hubMap[r.hub].pkt += r.total_paket || 0;
                    stats.hubMap[r.hub].mpp += r.total_mpp || 0;
                });
                
                stats.lastMile = stats.jne + stats.sap;
                stats.prod = stats.mpp > 0 ? Math.round(stats.pkt / stats.mpp) : 0;
                return stats;
            };

            const curr = calcStats(currData);
            const prev = calcStats(prevData);

            // Determine Best Hub (Productivity) & Top Hub (Load)
            let bestHubName = '-'; let bestHubProd = 0;
            let topLoadHubName = '-'; let topLoadHubVal = 0;

            Object.keys(curr.hubMap).forEach(h => {
                const d = curr.hubMap[h];
                // Prod
                const p = d.mpp > 0 ? Math.round(d.pkt / d.mpp) : 0;
                if (p > bestHubProd) { bestHubProd = p; bestHubName = h; }
                // Load
                if (d.pkt > topLoadHubVal) { topLoadHubVal = d.pkt; topLoadHubName = h; }
            });

            // Helper for formatted comparison string: "Val ( Diff | %)"
            const getCompStr = (valNow, valPrev, isRp = false, isUnit = false) => {
                const diff = valNow - valPrev;
                const pct = valPrev === 0 ? (valNow === 0 ? 0 : 100) : Math.round((diff / valPrev) * 100);
                const icon = diff > 0 ? '+' : (diff < 0 ? '-' : '');
                const displayVal = isRp ? window.formatRupiah(valNow) : window.formatNumber(valNow);
                const displayDiff = isRp ? window.formatRupiah(Math.abs(diff)) : window.formatNumber(Math.abs(diff));
                
                // Format: "1.000 (+ 100 | 10%)"
                return `${displayVal}${isUnit?isUnit:''} (${icon}${displayDiff} | ${icon}${Math.abs(pct)}%)`;
            };

            // Collect Issues (Unique strings) with DATE
            const issues = [];
            // Sort chronological for report text (Oldest -> Newest)
            const sortedLogs = [...currData].sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));
            
            sortedLogs.forEach(r => {
                if (r.catatan && r.catatan.trim().length > 0) {
                     const dObj = new Date(r.tanggal);
                     const dStr = `${dObj.getDate()}/${dObj.getMonth()+1}`; // Format DD/M
                     const issueStr = `[${dStr}] [${r.hub}] ${r.catatan}`;
                     if (!issues.includes(issueStr)) issues.push(issueStr);
                }
            });

            // --- 1. RENDER VISUAL CARDS IN SUMMARY SECTION (UI ONLY) ---
            container.innerHTML = `
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/5">
                    <p class="text-[10px] uppercase font-bold text-blue-200 tracking-wider mb-1">Total Load</p>
                    <h4 class="text-2xl font-extrabold text-white">${window.formatNumber(curr.pkt)} <span class="text-xs font-normal opacity-70">Pkt</span></h4>
                     <p class="text-[10px] text-white/50 mt-1">${curr.pkt >= prev.pkt ? '' : ''} ${Math.abs(curr.pkt - prev.pkt)} vs prev</p>
                </div>
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/5">
                    <p class="text-[10px] uppercase font-bold text-emerald-200 tracking-wider mb-1">Avg Productivity</p>
                    <h4 class="text-2xl font-extrabold text-white">${window.formatNumber(curr.prod)} <span class="text-xs font-normal opacity-70">/Org</span></h4>
                     <p class="text-[10px] text-white/50 mt-1">${curr.prod >= prev.prod ? '' : ''} ${Math.abs(curr.prod - prev.prod)} vs prev</p>
                </div>
                <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/5">
                    <p class="text-[10px] uppercase font-bold text-amber-200 tracking-wider mb-1">Top Hub Load</p>
                    <h4 class="text-xl font-extrabold text-white truncate" title="${topLoadHubName}">${topLoadHubName}</h4>
                    <p class="text-[10px] text-white/60 font-mono">${window.formatNumber(topLoadHubVal)} Pkt</p>
                </div>
                 <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/5">
                    <p class="text-[10px] uppercase font-bold text-rose-200 tracking-wider mb-1">Total Cost</p>
                    <h4 class="text-xl font-extrabold text-white truncate">${window.formatRupiah(curr.cost)}</h4>
                </div>
            `;
            
            // --- 2. GENERATE TEXT FOR CLIPBOARD ---
            const sDate = document.getElementById('dash-start-date').value;
            const eDate = document.getElementById('dash-end-date').value;
            const dateDisplay = (sDate === eDate) ? sDate : `${sDate} s/d ${eDate}`;
            
            let txt = `*SUMMARY REPORT HUB KALSULAMP*\n`;
            txt += `Periode: ${dateDisplay}\n\n`;
            
            txt += `*Global Performance:*\n`;
            txt += ` Load: ${getCompStr(curr.pkt, prev.pkt, false, ' Pkt')}\n`;
            txt += ` Manpower: ${getCompStr(curr.mpp, prev.mpp, false, ' Org')}\n`;
            txt += ` Avg Prod: ${getCompStr(curr.prod, prev.prod, false, ' Pkt/Org')}\n`;
            txt += ` Total Cost: ${getCompStr(curr.cost, prev.cost, true)}\n\n`;
            
            txt += `*Volume Breakdown:*\n`;
            txt += ` Staging: ${getCompStr(curr.stg, prev.stg)}\n`;
            txt += ` Gateway: ${getCompStr(curr.gtw, prev.gtw)}\n`;
            txt += ` JNE & SAP: ${getCompStr(curr.lastMile, prev.lastMile)}\n\n`;

            txt += `*Top HUB Load:* ${topLoadHubName} (${window.formatNumber(topLoadHubVal)} Pkt)\n`;
            txt += `*Top Hub Performance:* ${bestHubName} (${window.formatNumber(bestHubProd)} Pkt/Org)\n\n`;
            
            if (issues.length > 0) {
                txt += `*Log Kendala / Isu:*\n`;
                issues.forEach(i => txt += `- ${i}\n`);
            } else {
                 txt += `*Log Kendala:* Nihil\n`;
            }
            
            txt += `\n_Generated by DailyReport System_`;
            
            // Store in a global variable for the copy button
            window.managerSummaryText = txt;
        };
        
        window.copyManagerSummary = () => {
            if (!window.managerSummaryText) return window.notify('Data belum siap', 'error');
            
            const el = document.createElement('textarea');
            el.value = window.managerSummaryText;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            window.notify('Laporan Manager Disalin!', 'success');
        };

        const getRate = (h) => (appData.costs.find(c=>c.hub===h)||{}).cost||0;
        window.calculateReportCost = (r) => {
            let t=0, hr=getRate(r.hub), dr=appData.costDW||0;
            if(r.attendance_data) r.attendance_data.forEach(a => { if(a.s1||a.s2||a.s3) { 
                let isD = a.userId.startsWith('manual_'); if(!isD) { const u=appData.users.find(x=>x.id===a.userId); if(u&&u.posisi==='DW') isD=true; }
                t += isD?dr:hr;
            }}); else t=r.total_mpp*hr; return t;
        };

        window.updateCharts = (data, hubs) => {
            const cy = new Date().getFullYear(), mD = Array(12).fill(0).map(()=>({p:0,m:0}));
            let yrData = appData.laporan.filter(l=>new Date(l.tanggal).getFullYear()===cy);
            if(hubs.length) yrData=yrData.filter(l=>hubs.includes(l.hub));
            yrData.forEach(l=>{ const m=new Date(l.tanggal).getMonth(); mD[m].p+=l.total_paket; mD[m].m+=l.total_mpp; });
            
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { grid: { display: false } },
                    y: { 
                        type: 'linear', display: false, position: 'left',
                        ticks: { callback: function(value) { return window.formatNumber(value); } }
                    },
                    y1: { 
                        type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false },
                        ticks: { callback: function(value) { return window.formatNumber(value); } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += window.formatNumber(context.parsed.y); }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        backgroundColor: function(context) {
                             if (context.datasetIndex === 1) { 
                                 return context.dataset.data[context.dataIndex] < 600 ? '#ef4444' : '#10b981';
                             }
                             return 'rgba(15, 23, 42, 0.7)';
                        },
                        borderRadius: 4,
                        color: 'white',
                        font: { weight: 'bold', size: 10 },
                        padding: 4,
                        formatter: function(value) { return window.formatNumber(value); }
                    }
                }
            };

            const ctx1=document.getElementById('chart-annual').getContext('2d');
            if(annualChart) annualChart.destroy();
            annualChart=new Chart(ctx1, { 
                type:'bar', 
                data:{ 
                    labels:['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'], 
                    datasets:[
                        {label:'Paket', data:mD.map(d=>d.p), backgroundColor:'#4361ee', borderRadius:8, barPercentage:0.6, yAxisID: 'y'},
                        {label:'Prod', data:mD.map(d=>d.m?Math.round(d.p/d.m):0), type:'line', borderColor:'#94a3b8', borderWidth:2, tension:0.4, pointRadius:4, pointBackgroundColor: mD.map(d=>(d.m && Math.round(d.p/d.m)<600)?'#ef4444':'#10b981'), yAxisID: 'y1'}
                    ] 
                }, 
                options: chartOptions 
            });

            const agg={}; data.forEach(l=>{ if(!agg[l.tanggal])agg[l.tanggal]={p:0,m:0}; agg[l.tanggal].p+=l.total_paket; agg[l.tanggal].m+=l.total_mpp; });
            const sD=Object.keys(agg).sort((a,b)=>new Date(a)-new Date(b)), lbs=sD.map(d=>{const x=new Date(d);return `${x.getDate()}/${x.getMonth()+1}`});
            
            const ctx2=document.getElementById('chart-daily').getContext('2d');
            if(dailyChart) dailyChart.destroy();
            dailyChart=new Chart(ctx2, { 
                type:'bar', 
                data:{ 
                    labels:lbs, 
                    datasets:[
                        {label:'Paket', data:sD.map(d=>agg[d].p), backgroundColor:'#4361ee', borderRadius:8, barPercentage:0.6, yAxisID: 'y'},
                        {label:'Prod', data:sD.map(d=>agg[d].m?Math.round(agg[d].p/agg[d].m):0), type:'line', borderColor:'#94a3b8', borderWidth:2, tension:0.4, pointRadius:4, pointBackgroundColor: sD.map(d=>(agg[d].m && Math.round(agg[d].p/agg[d].m)<600)?'#ef4444':'#10b981'), yAxisID: 'y1'}
                    ] 
                }, 
                options: chartOptions 
            });
        };

        window.updateDashboardTables = (data) => {
            const tb1 = document.getElementById('tbody-daily-detail'); tb1.innerHTML='';
            data.forEach(l => { 
                const prod = Math.round(l.productivity);
                const prodClass = window.getProdColorClass(prod);
                tb1.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><td class="px-4 py-3 text-left font-medium text-slate-800 sticky left-0 bg-white">${l.tanggal}</td><td class="px-4 py-3"><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold">${l.hub}</span></td><td class="px-4 py-3 text-primary font-bold">${l.total_mpp}</td><td class="px-4 py-3 text-slate-400">${window.formatNumber(l.staging)}</td><td class="px-4 py-3 text-slate-400">${window.formatNumber(l.gateway)}</td><td class="px-4 py-3 text-slate-400">${window.formatNumber(l.jne)}</td><td class="px-4 py-3 text-slate-400">${window.formatNumber(l.sap)}</td><td class="px-4 py-3 font-extrabold bg-slate-50 text-slate-800">${window.formatNumber(l.total_paket)}</td><td class="px-4 py-3"><span class="${prodClass}">${window.formatNumber(prod)}</span></td><td class="px-4 py-3 text-right text-rose-500 font-medium">${window.formatRupiah(window.calculateReportCost(l))}</td></tr>`; 
            });
            
            const hAg={}; data.forEach(l=>{ if(!hAg[l.hub])hAg[l.hub]={m:0,o:0,c:0}; hAg[l.hub].m+=l.total_mpp; hAg[l.hub].o+=l.total_paket; hAg[l.hub].c+=window.calculateReportCost(l); });
            const tb2 = document.getElementById('tbody-hub-breakdown'); tb2.innerHTML='';
            Object.keys(hAg).sort((a,b)=>hAg[b].o-hAg[a].o).forEach(h=>{ 
                const d=hAg[h]; 
                const prod = d.m?Math.round(d.o/d.m):0;
                const prodClass = window.getProdColorClass(prod);
                tb2.innerHTML+=`<tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><td class="px-4 py-3 text-left font-bold text-slate-800">${h}</td><td class="px-3 py-3 text-primary font-medium">${d.m}</td><td class="px-4 py-3 font-bold text-slate-700">${window.formatNumber(d.o)}</td><td class="px-3 py-3 font-medium"><span class="${prodClass}">${window.formatNumber(prod)}</span></td><td class="px-4 py-3 text-right text-slate-400 font-medium">${window.formatRupiah(d.c)}</td></tr>`; 
            });
        };

        window.exportTableToCSV = (id, n) => { const t=document.getElementById(id); let c=[]; t.querySelectorAll('tr').forEach(r=>{ let row=[]; r.querySelectorAll('td,th').forEach(z=>row.push(z.innerText)); c.push(row.join(',')); }); const b=new Blob([c.join('\n')],{type:'text/csv'}), a=document.createElement('a'); a.download=n; a.href=window.URL.createObjectURL(b); a.click(); };

        // --- NEW: GENERIC TOGGLE LOGIC (Shared) ---
        window.handleHubToggleLogic = (container, hubName) => {
             const allBtn = container.querySelector('.hub-btn[data-hub="ALL"]');
             const targetBtn = container.querySelector(`.hub-btn[data-hub="${hubName}"]`);
             if(!allBtn || !targetBtn) return;

             if (hubName === 'ALL') {
                container.querySelectorAll('.hub-btn').forEach(b => { b.classList.remove('active'); b.classList.add('inactive'); });
                allBtn.classList.remove('inactive'); allBtn.classList.add('active');
            } else {
                if (allBtn.classList.contains('active')) { allBtn.classList.remove('active'); allBtn.classList.add('inactive'); }
                if (targetBtn.classList.contains('active')) { targetBtn.classList.remove('active'); targetBtn.classList.add('inactive'); } 
                else { targetBtn.classList.remove('inactive'); targetBtn.classList.add('active'); }
                
                if (!container.querySelector('.hub-btn.active:not([data-hub="ALL"])')) {
                    allBtn.classList.remove('inactive'); allBtn.classList.add('active');
                }
            }
        };

        // --- NEW: ABSENSI HUB FILTER BUTTONS ---
        window.renderAbsensiHubButtons = () => {
             const container = document.getElementById('abs-hub-filter-container');
             if(!container) return;
             container.innerHTML = '';
             
             // Logic: Admin/PIC lihat semua, User biasa hanya lihat hub sendiri
             if (currentUser.role === 'admin' || currentUser.role === 'pic') {
                 const allBtn = document.createElement('button');
                 allBtn.className = 'hub-btn active';
                 allBtn.dataset.hub = 'ALL';
                 allBtn.innerText = 'Semua';
                 allBtn.onclick = () => window.toggleAbsensiHubFilter('ALL');
                 container.appendChild(allBtn);

                 appData.costs.forEach(h => {
                    const btn = document.createElement('button');
                    btn.className = 'hub-btn inactive';
                    btn.dataset.hub = h.hub;
                    btn.innerText = h.hub;
                    btn.onclick = () => window.toggleAbsensiHubFilter(h.hub);
                    container.appendChild(btn);
                });
             } else {
                 const btn = document.createElement('button');
                 btn.className = 'hub-btn active cursor-default';
                 btn.dataset.hub = currentUser.kode_hub;
                 btn.innerText = currentUser.kode_hub;
                 container.appendChild(btn);
             }
        };

        window.toggleAbsensiHubFilter = (hubName) => {
             if (currentUser.role !== 'admin' && currentUser.role !== 'pic') return;
             const container = document.getElementById('abs-hub-filter-container');
             window.handleHubToggleLogic(container, hubName);
             window.loadAbsensiData();
        };

        // --- UPDATED INIT FUNCTION ---
        window.initAbsensiFilters = () => {
             const sEl = document.getElementById('abs-start-date');
             const eEl = document.getElementById('abs-end-date');
             
             // Set default 30 hari jika kosong
             if(!sEl.value || !eEl.value) {
                 const d = new Date(); 
                 eEl.valueAsDate = d;
                 const past = new Date(); past.setDate(past.getDate()-30); 
                 sEl.valueAsDate = past;
             }
             
             // Ganti renderSelect dengan renderButtons
             window.renderAbsensiHubButtons();
             window.loadAbsensiData();
        };

        // --- EMPTY OLD FUNCTION TO PREVENT CRASH ---
        window.renderAbsensiHubSelect = () => { 
            // Fungsi ini dideprecate karena sudah diganti tombol. 
            // Dikosongkan agar pemanggilan lama tidak error.
        };

        window.getDatesInRange = (startDate, endDate) => {
            const date = new Date(startDate.getTime());
            const dates = [];
            while (date <= endDate) {
                dates.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return dates;
        };

        // --- UPDATED DATA LOADER ---
        window.loadAbsensiData = () => {
            const startStr = document.getElementById('abs-start-date').value;
            const endStr = document.getElementById('abs-end-date').value;
            
            // NEW: Get Filter from Buttons
            const activeBtns = Array.from(document.querySelectorAll('#abs-hub-filter-container .hub-btn.active'));
            const isAll = activeBtns.some(b => b.dataset.hub === 'ALL');
            let selectedHubs = isAll ? [] : activeBtns.map(b => b.dataset.hub);

            const container = document.getElementById('absensi-table-container');
            const summaryBody = document.getElementById('absensi-summary-tbody');
            const hubRecapBody = document.getElementById('hub-recap-tbody');
            
            if(!startStr || !endStr) return;
            const sDate = new Date(startStr), eDate = new Date(endStr);
            const dateRange = window.getDatesInRange(sDate, eDate).reverse();

            const reports = appData.laporan.filter(l => {
                const d = new Date(l.tanggal);
                // NEW Logic: Filter based on array of selected hubs OR All
                return d >= sDate && d <= eDate && (isAll || selectedHubs.includes(l.hub));
            });
            
            let totAbsMpp = 0;
            let totAbsCost = 0;
            reports.forEach(r => {
                totAbsMpp += r.total_mpp;
                totAbsCost += window.calculateReportCost(r);
            });
            document.getElementById('abs-kpi-mpp').innerText = window.formatNumber(totAbsMpp);
            document.getElementById('abs-kpi-cost').innerText = window.formatRupiah(totAbsCost);

            const attMap = {};
            const colTotals = {}; 
            const userSummary = {};
            const hubStats = {};

            reports.forEach(r => {
                if(!attMap[r.hub]) attMap[r.hub] = {};
                if(!colTotals[r.tanggal]) colTotals[r.tanggal] = 0;
                
                if(!hubStats[r.hub]) hubStats[r.hub] = { h:0, i:0, s:0, a:0 };

                if(r.attendance_data) {
                    r.attendance_data.forEach(a => {
                         let status = '';
                         if(a.s1) status='1'; else if(a.s2) status='2'; else if(a.s3) status='3';
                         else if(a.i) status='I'; else if(a.s) status='S'; else if(a.a) status='A';
                         
                         if(!userSummary[a.userId]) userSummary[a.userId] = { name: a.nama || a.name, h:0, i:0, s:0, a:0, details: [] };
                         
                         if(['1','2','3'].includes(status)) {
                             userSummary[a.userId].h++;
                             hubStats[r.hub].h++;
                         } else if (status === 'I') {
                             userSummary[a.userId].i++;
                             hubStats[r.hub].i++;
                         } else if (status === 'S') {
                             userSummary[a.userId].s++;
                             hubStats[r.hub].s++;
                         } else if (status === 'A') {
                             userSummary[a.userId].a++;
                             hubStats[r.hub].a++;
                         }

                         if (['I','S','A'].includes(status)) {
                             const reason = a.ket ? `(${a.ket})` : '';
                             const label = status === 'I' ? 'Ijin' : (status === 'S' ? 'Sakit' : 'Alfa');
                             const dObj = new Date(r.tanggal);
                             const dStr = `${dObj.getDate()}/${dObj.getMonth()+1}`;
                             userSummary[a.userId].details.push(`<span class="inline-block bg-slate-100 rounded px-1.5 py-0.5 text-[10px] mr-1 mb-1 border border-slate-200"><b>${dStr} ${label}</b> ${reason}</span>`);
                         }

                         if(status) {
                             if(!attMap[r.hub][a.userId]) attMap[r.hub][a.userId] = { name: a.nama };
                             attMap[r.hub][a.userId][r.tanggal] = status;
                             if(['1','2','3'].includes(status)) {
                                 if(!colTotals[r.tanggal]) colTotals[r.tanggal] = 0;
                                 colTotals[r.tanggal]++;
                             }
                         }
                    });
                }
            });

            // Logic to determine which hubs to show in table
            let hubsToShow = isAll ? appData.costs.map(c=>c.hub) : selectedHubs;
            // Fallback for user view
            if (currentUser.role !== 'admin' && currentUser.role !== 'pic') {
                hubsToShow = [currentUser.kode_hub];
            }

            let html = `<table class="w-full text-xs border-collapse">`;
            
            html += `<thead class="abs-header sticky top-0 bg-slate-50 z-20 shadow-sm"><tr>
                        <th class="p-3 border-b bg-white text-left min-w-[180px] abs-name-col sticky left-0 z-30 font-bold text-slate-600">Nama / HUB</th>`;
            dateRange.forEach(d => {
                const dStr = d.toLocaleDateString('id-ID', {day:'2-digit', month:'2-digit'});
                html += `<th class="p-2 border-b bg-white abs-cell font-bold text-slate-500">${dStr}</th>`;
            });
            html += `</tr></thead><tbody>`;

            hubsToShow.forEach(h => {
                // UPDATE: Filter hanya menampilkan User Aktif atau User Resign yang masih masuk periode filter
                const visibleUsers = appData.users.filter(u => {
                    if (u.kode_hub !== h) return false;
                    
                    if (u.is_resign) {
                        // Jika resign tapi tidak ada tanggalnya, sembunyikan (asumsi data lama)
                        if (!u.tanggal_resign) return false; 
                        
                        const rDate = new Date(u.tanggal_resign); 
                        rDate.setHours(0,0,0,0);
                        
                        const fStart = new Date(sDate); 
                        fStart.setHours(0,0,0,0);
                        
                        // HANYA TAMPILKAN jika tanggal resign >= tanggal awal filter
                        return rDate >= fStart; 
                    }
                    return true;
                });

                const registeredIds = new Set(visibleUsers.map(u => u.id));

                reports.forEach(r => {
                    if(r.hub !== h) return;
                    if(r.attendance_data) {
                        r.attendance_data.forEach(a => {
                             if (!registeredIds.has(a.userId)) {
                                 let role = 'DW'; 
                                 if (!a.userId.startsWith('manual_')) role = 'History';
                                 visibleUsers.push({ id: a.userId, nama: a.name || a.nama, posisi: role, kode_hub: h });
                                 registeredIds.add(a.userId);
                             }
                        });
                    }
                });

                visibleUsers.sort((a,b) => {
                     const rA=(a.posisi==='LEADER'||a.posisi==='Admin')?0:1;
                     const rB=(b.posisi==='LEADER'||b.posisi==='Admin')?0:1;
                     if(rA!==rB)return rA-rB; return a.id.localeCompare(b.id);
                });

                if (visibleUsers.length > 0) {
                    html += `<tr class="bg-indigo-50"><td class="p-3 border-b font-extrabold text-indigo-700 abs-name-col sticky left-0 z-20 shadow-sm" colspan="1">${h}</td><td colspan="${dateRange.length}" class="bg-indigo-50 border-b"></td></tr>`;

                    let currentRole = '';

                    visibleUsers.forEach(u => {
                         let roleType = (u.posisi==='LEADER'||u.posisi==='Admin') ? 'LEADER' : 'SORTER/DW';
                         if(roleType !== currentRole) {
                             currentRole = roleType;
                             html += `<tr class="bg-slate-50/50"><td class="p-2 border-b text-[10px] font-bold text-slate-400 pl-6 abs-name-col sticky left-0 z-20" colspan="1">${currentRole}</td><td colspan="${dateRange.length}" class="border-b bg-slate-50/50"></td></tr>`;
                         }

                         html += `<tr class="hover:bg-slate-50 transition"><td class="p-3 border-b font-medium text-slate-700 abs-name-col sticky left-0 bg-white z-20 text-[11px] truncate max-w-[180px] shadow-sm">${u.nama}</td>`;
                         
                         dateRange.forEach(d => {
                             const y = d.getFullYear();
                             const m = String(d.getMonth() + 1).padStart(2, '0');
                             const da = String(d.getDate()).padStart(2, '0');
                             const dateKey = `${y}-${m}-${da}`;
                             
                             let status = '';
                             if(attMap[h] && attMap[h][u.id] && attMap[h][u.id][dateKey]) {
                                 status = attMap[h][u.id][dateKey];
                             }
                             
                             let cellClass = '';
                             if(['1','2','3'].includes(status)) { cellClass='bg-blue-50 text-blue-600 font-bold'; }
                             else if(status==='I') cellClass='bg-yellow-50 text-amber-500 font-bold';
                             else if(status==='S') cellClass='bg-purple-50 text-purple-500 font-bold';
                             else if(status==='A') cellClass='bg-red-50 text-red-500 font-bold';

                             html += `<td class="p-1 border-b abs-cell ${cellClass}">${status}</td>`;
                         });
                         html += `</tr>`;
                    });
                }
            });
            
            html += `<tr class="bg-slate-100 font-bold sticky bottom-0 z-20 shadow-md"><td class="p-3 border-t text-right abs-name-col sticky left-0 bg-slate-100 z-30 text-slate-700 shadow-md">Total Hadir:</td>`;
            dateRange.forEach(d => {
                 const y = d.getFullYear();
                 const m = String(d.getMonth() + 1).padStart(2, '0');
                 const da = String(d.getDate()).padStart(2, '0');
                 const dateKey = `${y}-${m}-${da}`;
                 const tot = colTotals[dateKey] || 0;
                 html += `<td class="p-2 border-t text-center text-primary bg-white font-extrabold">${tot}</td>`;
            });
            html += `</tr>`;
            html += `</tbody></table>`;
            container.innerHTML = html;

            hubRecapBody.innerHTML = '';
            Object.keys(hubStats).sort().forEach(h => {
                const s = hubStats[h];
                hubRecapBody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="px-4 py-3 font-bold text-slate-700 text-left">${h}</td>
                        <td class="px-3 py-3 font-bold text-primary">${s.h}</td>
                        <td class="px-3 py-3 font-bold text-amber-500">${s.i}</td>
                        <td class="px-3 py-3 font-bold text-purple-500">${s.s}</td>
                        <td class="px-3 py-3 font-bold text-red-500">${s.a}</td>
                    </tr>
                `;
            });

            summaryBody.innerHTML = '';
            const sortedUserIds = Object.keys(userSummary).sort((a,b) => userSummary[a].name.localeCompare(userSummary[b].name));
            
            if (sortedUserIds.length === 0) {
                 summaryBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-slate-400 italic">Tidak ada data absensi pada periode ini.</td></tr>`;
            } else {
                sortedUserIds.forEach(uid => {
                    const u = userSummary[uid];
                    if (u.h === 0 && u.i === 0 && u.s === 0 && u.a === 0 && u.details.length === 0) return; 
                    
                    const detailsHtml = u.details.length > 0 ? u.details.join('') : '<span class="text-slate-300">-</span>';
                    
                    summaryBody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="px-6 py-4 font-bold text-slate-700 text-[11px]">${u.name}</td>
                            <td class="px-2 py-4 text-center font-bold text-primary">${u.h}</td>
                            <td class="px-2 py-4 text-center font-bold text-amber-500">${u.i}</td>
                            <td class="px-2 py-4 text-center font-bold text-purple-500">${u.s}</td>
                            <td class="px-2 py-4 text-center font-bold text-red-500">${u.a}</td>
                            <td class="px-6 py-4 text-xs leading-relaxed text-slate-600">${detailsHtml}</td>
                        </tr>
                    `;
                });
            }
        };

        window.switchSettingsTab = (id) => { document.querySelectorAll('.settings-panel').forEach(e=>e.classList.add('hidden')); document.getElementById(`settings-${id}`).classList.remove('hidden'); };
        window.loadSettingsUI = () => { window.renderUserTable(); document.getElementById('access-code-input').value = appData.accessCode; document.getElementById('global-cost-dw').value = window.formatNumber(appData.costDW); window.renderCostInputs(); };
        
        window.toggleResignDate = () => {
            const isResign = document.getElementById('input-resign-toggle').checked;
            document.getElementById('resign-date-container').classList.toggle('hidden', !isResign);
            if(!isResign) document.getElementById('input-tanggal-resign').value = '';
        };

        window.renderUserTable = () => { 
            const tb = document.getElementById('user-table-body'); 
            const tbSum = document.getElementById('user-summary-tbody');
            
            tb.innerHTML = ''; 
            if(tbSum) tbSum.innerHTML = '';

            const stats = []; // Array of {hub, pos, act, rsg}
            let totalActive = 0;
            let totalResign = 0;

            // UPDATE: Sort by NIK (ID) Ascending (Terlama ke Terbaru)
            appData.users.sort((a,b) => {
                // Menggunakan numeric: true agar "2" dianggap lebih kecil dari "10"
                return a.id.localeCompare(b.id, 'en', { numeric: true });
            });

            appData.users.forEach(u => {
                const isResign = u.is_resign === true;
                
                // --- 1. Populate Table Kiri ---
                const statusBadge = isResign 
                    ? `<span class="bg-rose-100 text-rose-600 px-2 py-0.5 rounded text-[9px] font-bold border border-rose-200 ml-2">RESIGN</span>` 
                    : '';
                const rowClass = isResign ? 'bg-slate-50 opacity-70 grayscale' : 'hover:bg-slate-50';
                const nameDisplay = isResign ? `<span class="line-through text-slate-400">${u.nama}</span>` : `<span class="text-slate-700 font-semibold">${u.nama}</span>`;
                const hubClass = u.kode_hub === 'HO' ? 'bg-slate-100 text-slate-600' : 'bg-blue-50 text-primary border-blue-100';

                tb.innerHTML += `
                    <tr class="${rowClass} border-b border-slate-50 transition">
                        <td class="px-6 py-3.5 flex items-center pl-8">${nameDisplay} ${statusBadge}</td>
                        <td class="px-4 py-3.5 font-mono text-slate-400 text-[10px]">${u.id}</td>
                        <td class="px-4 py-3.5"><span class="${hubClass} px-2.5 py-1 rounded-lg text-[10px] font-bold shadow-sm border border-transparent">${u.kode_hub}</span></td>
                        <td class="px-4 py-3.5 text-xs font-medium text-slate-500">${u.posisi}</td>
                        <td class="px-6 py-3.5 text-right pr-8">
                            <button onclick="window.openUserModal('${u.id}')" class="text-blue-500 bg-blue-50 p-1.5 rounded-lg hover:bg-blue-100 transition mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteUser('${u.id}')" class="text-rose-400 bg-rose-50 p-1.5 rounded-lg hover:bg-rose-100 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;

                // --- 2. Calculate Stats untuk Kanan ---
                // Normalize Position (Admin digabung ke Leader atau sesuai nama)
                let pos = u.posisi;
                if(pos === 'Admin') pos = 'LEADER';
                pos = pos.toUpperCase(); // LEADER, SORTER, DW

                // Find existing entry in stats
                let entry = stats.find(s => s.hub === u.kode_hub && s.pos === pos);
                if(!entry) {
                    entry = { hub: u.kode_hub, pos: pos, act: 0, rsg: 0 };
                    stats.push(entry);
                }

                if (isResign) {
                    entry.rsg++;
                    totalResign++;
                } else {
                    entry.act++; 
                    totalActive++;
                }
            }); 

            // --- 3. Populate Table Kanan (Summary) ---
            if(tbSum) {
                // Group by HUB first to calculate subtotals
                const hubGroups = {};
                stats.forEach(s => {
                    if(!hubGroups[s.hub]) hubGroups[s.hub] = [];
                    hubGroups[s.hub].push(s);
                });

                const sortedHubs = Object.keys(hubGroups).sort();

                if(sortedHubs.length === 0) {
                    tbSum.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-[10px] text-slate-400 italic">Belum ada data</td></tr>`;
                }

                sortedHubs.forEach(hub => {
                    const group = hubGroups[hub];
                    // Sort positions: LEADER, SORTER, DW
                    const posOrder = { 'LEADER': 1, 'SORTER': 2, 'DW': 3 };
                    group.sort((a,b) => (posOrder[a.pos]||99) - (posOrder[b.pos]||99));

                    let hubTotalAct = 0;
                    let hubTotalRsg = 0;

                    group.forEach(s => {
                        let posBadge = '';
                        if(s.pos === 'LEADER') posBadge = `<span class="text-blue-600 font-bold text-[10px]">LEADER</span>`;
                        else if(s.pos === 'SORTER') posBadge = `<span class="text-slate-500 text-[10px]">SORTER</span>`;
                        else posBadge = `<span class="text-slate-500 text-[10px]">DW</span>`;

                        tbSum.innerHTML += `
                            <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                                <td class="px-3 py-2 text-left pl-6 font-bold text-slate-700 text-[10px]">${s.hub}</td>
                                <td class="px-2 py-2 text-left">${posBadge}</td>
                                <td class="px-2 py-2 text-center font-mono text-emerald-600 font-bold bg-emerald-50/20">${s.act}</td>
                                <td class="px-2 py-2 text-center font-mono text-rose-500 font-bold bg-rose-50/20">${s.rsg}</td>
                            </tr>
                        `;
                        hubTotalAct += s.act;
                        hubTotalRsg += s.rsg;
                    });

                    // Add Subtotal Row per HUB
                    tbSum.innerHTML += `
                        <tr class="bg-slate-100/50 border-b border-slate-200/50">
                            <td colspan="2" class="px-3 py-2 text-right font-bold text-[10px] text-slate-500 pr-4 tracking-wide">TOTAL ${hub}</td>
                            <td class="px-2 py-2 text-center font-extrabold text-[11px] text-slate-700 bg-slate-200/50 rounded-l-md">${hubTotalAct}</td>
                            <td class="px-2 py-2 text-center font-extrabold text-[11px] text-slate-700 bg-slate-200/50 rounded-r-md">${hubTotalRsg}</td>
                        </tr>
                    `;
                });
            }

            // --- 4. Update Global Totals ---
            const elAct = document.getElementById('sum-total-active');
            const elRsg = document.getElementById('sum-total-resign');
            if(elAct) elAct.innerText = totalActive;
            if(elRsg) elRsg.innerText = totalResign;
        };

        window.toggleUserModalPassword = () => { const p=document.getElementById('input-posisi').value, isL=p==='LEADER'||p==='Admin', pc=document.getElementById('password-container'), ic=document.getElementById('id-container'); pc.classList.toggle('hidden', !isL); if(isL){ic.classList.remove('col-span-2');ic.classList.add('col-span-1')}else{ic.classList.remove('col-span-1');ic.classList.add('col-span-2')} };
        
        window.openUserModal = (id=null) => {
            const m=document.getElementById('user-modal'); m.classList.remove('hidden'); setTimeout(()=>m.children[0].classList.remove('scale-95','opacity-0'), 10);
            const hS=document.getElementById('input-kode-hub'); hS.innerHTML='<option value="">-- Pilih --</option>'; appData.costs.forEach(c=>hS.innerHTML+=`<option value="${c.hub}">${c.hub}</option>`);
            
            if(id) { 
                const u=appData.users.find(x=>x.id===id); 
                document.getElementById('modal-title').innerText='Edit User'; 
                document.getElementById('edit-user-id').value=id; 
                document.getElementById('input-nama').value=u.nama; 
                document.getElementById('input-id').value=u.id; 
                document.getElementById('input-sandi').value=u.sandi||''; 
                document.getElementById('input-kode-hub').value=u.kode_hub; 
                document.getElementById('input-posisi').value=u.posisi; 
                document.getElementById('input-akses-toggle').checked=(u.akses==='YA'); 
                document.getElementById('akses-label').innerText=u.akses; 
                
                // Load Resign Data
                document.getElementById('input-resign-toggle').checked = (u.is_resign === true);
                document.getElementById('input-tanggal-resign').value = u.tanggal_resign || '';
                window.toggleResignDate();

                document.getElementById('input-id').readOnly=true; 
                document.getElementById('input-id').classList.add('bg-slate-100'); 
            } else { 
                document.getElementById('modal-title').innerText='Tambah User'; 
                document.getElementById('edit-user-id').value=''; 
                document.getElementById('user-form').reset(); 
                document.getElementById('input-id').readOnly=false; 
                document.getElementById('input-id').classList.remove('bg-slate-100'); 
                document.getElementById('akses-label').innerText='TIDAK'; 
                
                // Reset Resign
                document.getElementById('input-resign-toggle').checked = false;
                window.toggleResignDate();
            }
            window.toggleUserModalPassword();
        };

        window.closeUserModal = () => { const m=document.getElementById('user-modal'); m.children[0].classList.add('scale-95','opacity-0'); setTimeout(()=>m.classList.add('hidden'), 300); };
        
        document.getElementById('user-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            window.notify('Menyimpan...', 'loading'); 
            const id=document.getElementById('input-id').value;
            const isResign = document.getElementById('input-resign-toggle').checked;
            
            const data={ 
                nama:document.getElementById('input-nama').value, 
                id:id, 
                sandi:document.getElementById('input-sandi').value, 
                kode_hub:document.getElementById('input-kode-hub').value, 
                posisi:document.getElementById('input-posisi').value, 
                akses:document.getElementById('input-akses-toggle').checked?'YA':'TIDAK',
                is_resign: isResign,
                tanggal_resign: isResign ? document.getElementById('input-tanggal-resign').value : ''
            }; 
            
            try { await setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'users', id), data); window.closeUserModal(); window.notify('Tersimpan', 'success'); } catch(err){ window.notify('Gagal', 'error'); } 
        };

        window.renderCostInputs = () => { const c=document.getElementById('cost-container'); c.innerHTML=''; appData.costs.forEach((x,i)=>c.innerHTML+=`<div class="flex gap-3 items-center mb-3 bg-slate-50 p-2 rounded-xl border border-slate-100"><input type="text" id="cost-hub-${i}" value="${x.hub}" class="w-1/3 border-none p-2 rounded-lg text-sm bg-transparent font-bold text-slate-700" readonly><input type="text" id="cost-val-${i}" value="${window.formatRupiah(x.cost)}" class="w-1/3 border border-slate-200 p-2 rounded-lg text-sm text-right font-mono focus:ring-1 focus:ring-primary outline-none" onkeyup="window.formatCostInput(this)"><button onclick="window.removeCostRow(${i})" class="text-rose-400 hover:text-rose-600 px-3 transition"><i class="fas fa-trash"></i></button></div>`); };
        window.addHubToTable = () => { const n=document.getElementById('new-hub-name').value.toUpperCase(), c=window.parseFormattedNumber(document.getElementById('new-hub-cost').value); if(!n) return Swal.fire('Info','Isi HUB','warning'); appData.costs.push({hub:n, cost:c}); window.renderCostInputs(); document.getElementById('new-hub-name').value=''; document.getElementById('new-hub-cost').value=''; };
        window.removeCostRow = (i) => { appData.costs.splice(i,1); window.renderCostInputs(); };
        window.saveCosts = async () => { window.notify('Menyimpan...', 'loading'); const dw=window.parseFormattedNumber(document.getElementById('global-cost-dw').value), batch=[]; const rows=document.getElementById('cost-container').children; const newCosts=[]; for(let i=0;i<rows.length;i++){ const h=document.getElementById(`cost-hub-${i}`).value, c=window.parseFormattedNumber(document.getElementById(`cost-val-${i}`).value); newCosts.push({hub:h, cost:c}); batch.push(setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'costs', h), {hub:h, cost:c})); } try { await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), {costDW:dw}); await Promise.all(batch); window.notify('Tersimpan', 'success'); } catch(e) { window.notify('Gagal', 'error'); } };

        // ... existing clipboard functions ...

        window.renderLaporanList = () => {
            const tb = document.getElementById('laporan-list-body'); 
            tb.innerHTML = ''; 
            let d = appData.laporan;

            // 1. Date Filter
            const sDateVal = document.getElementById('lap-start-date').value;
            const eDateVal = document.getElementById('lap-end-date').value;
            if(sDateVal && eDateVal) {
                const s = new Date(sDateVal); s.setHours(0,0,0,0);
                const e = new Date(eDateVal); e.setHours(23,59,59,999);
                d = d.filter(l => { const x = new Date(l.tanggal); return x >= s && x <= e; });
            }

            // 2. HUB Filter (UPDATED to use Buttons)
            if(currentUser.role !== 'admin') {
                d = d.filter(l => l.hub === currentUser.kode_hub);
            } else {
                // Get Active Buttons from Laporan Filter Container
                const activeBtns = Array.from(document.querySelectorAll('#lap-hub-filter-container .hub-btn.active'));
                const isAll = activeBtns.some(b => b.dataset.hub === 'ALL');
                
                if (!isAll) {
                    const selectedHubs = activeBtns.map(b => b.dataset.hub);
                    // Filter if selectedHubs is not empty
                    if (selectedHubs.length > 0) {
                        d = d.filter(l => selectedHubs.includes(l.hub));
                    }
                }
            }

            if(d.length === 0) document.getElementById('empty-laporan-msg').classList.remove('hidden');
            else {
                document.getElementById('empty-laporan-msg').classList.add('hidden');
                d.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
                d.forEach(l => {
                    const hasEditAccess = (currentUser.role === 'admin') || (currentUser.role === 'pic') || (currentUser.akses_laporan === 'YA' && l.hub === currentUser.kode_hub);
                    const shareBtn = `<button onclick='window.copyReportHandler("${safeId(l.id)}")' class="text-green-600 bg-green-50 hover:bg-green-100 p-2 rounded-lg transition" title="Salin Laporan"><i class="fab fa-whatsapp"></i></button>`;
                    const acts = hasEditAccess ? `<div class="flex justify-end gap-2">${shareBtn}<button onclick="window.editLaporan('${safeId(l.id)}')" class="text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition"><i class="fas fa-edit"></i></button><button onclick="window.deleteLaporan('${safeId(l.id)}')" class="text-rose-500 bg-rose-50 hover:bg-rose-100 p-2 rounded-lg transition"><i class="fas fa-trash"></i></button></div>` : '<span class="text-gray-300 text-[10px] italic">Read-only</span>';
                    
                    const prod = Math.round(l.productivity);
                    const prodClass = window.getProdColorClass(prod);

                    tb.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                            <td class="px-6 py-4 font-medium text-slate-700 sticky left-0 bg-white z-10">${l.tanggal}</td>
                            <td class="px-6 py-4"><span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold shadow-sm border border-indigo-100">${l.hub}</span></td>
                            <td class="px-2 py-4 text-slate-400 text-right text-[10px] font-mono">${window.formatNumber(l.gateway)}</td>
                            <td class="px-2 py-4 text-slate-400 text-right text-[10px] font-mono">${window.formatNumber(l.staging)}</td>
                            <td class="px-2 py-4 text-slate-400 text-right text-[10px] font-mono">${window.formatNumber(l.jne)}</td>
                            <td class="px-2 py-4 text-slate-400 text-right text-[10px] font-mono">${window.formatNumber(l.sap)}</td>
                            <td class="px-4 py-4 font-extrabold text-slate-800 bg-slate-50/80 text-right">${window.formatNumber(l.total_paket)}</td>
                            <td class="px-4 py-4 text-primary font-bold text-right">${l.total_mpp}</td>
                            <td class="px-4 py-4 text-right"><span class="${prodClass}">${window.formatNumber(prod)}</span></td>
                            <td class="px-6 py-4 text-right">${acts}</td>
                        </tr>`;
                });
            }
        };

        window.editLaporan = async (id) => {
            const d = appData.laporan.find(x => x.id === id);
            if (!d) return;

            // Buka Modal
            const m = document.getElementById('laporan-modal');
            m.classList.remove('hidden');
            setTimeout(() => m.children[0].classList.remove('scale-95', 'opacity-0'), 10);

            // Set Form Values
            document.getElementById('laporan-modal-title').innerText = 'Edit Laporan';
            document.getElementById('edit-laporan-id').value = d.id;
            document.getElementById('lap-tanggal').value = d.tanggal;
            document.getElementById('lap-catatan').value = d.catatan || '';

            const s = document.getElementById('lap-hub-select');
            const t = document.getElementById('lap-hub-text');

            // Handle Hub Select/Text logic
            if (currentUser.role === 'admin') {
                s.classList.remove('hidden');
                t.classList.add('hidden');
                s.value = d.hub;
            } else {
                s.classList.add('hidden');
                t.classList.remove('hidden');
                t.value = d.hub;
            }

            // Load Users & Attendance Data
            window.loadHubUsersForAttendance(d.hub, d.attendance_data);

            // Set Metrics Values
            document.getElementById('lap-gateway').value = window.formatNumber(d.gateway);
            document.getElementById('lap-staging').value = window.formatNumber(d.staging);
            document.getElementById('lap-jne').value = window.formatNumber(d.jne);
            document.getElementById('lap-sap').value = window.formatNumber(d.sap);

            window.calcMetrics();
        };

        window.openLaporanModal = () => {
             const m=document.getElementById('laporan-modal'); m.classList.remove('hidden'); setTimeout(()=>m.children[0].classList.remove('scale-95','opacity-0'), 10);
             document.getElementById('laporan-form').reset(); document.getElementById('laporan-modal-title').innerText='Buat Laporan Baru'; document.getElementById('edit-laporan-id').value=''; document.getElementById('lap-tanggal').valueAsDate=new Date();
             document.getElementById('lap-catatan').value = ''; 
             const s=document.getElementById('lap-hub-select'), t=document.getElementById('lap-hub-text');
             if(currentUser.role==='admin') { s.classList.remove('hidden'); t.classList.add('hidden'); s.innerHTML='<option value="">-- Pilih HUB --</option>'; appData.costs.forEach(c=>s.innerHTML+=`<option value="${c.hub}">${c.hub}</option>`); document.getElementById('attendance-tbody').innerHTML='<tr><td colspan="9" class="p-8 text-center text-slate-400">Pilih HUB dulu.</td></tr>'; }
             else { s.classList.add('hidden'); t.classList.remove('hidden'); t.value=currentUser.kode_hub; window.loadHubUsersForAttendance(currentUser.kode_hub); }
             ['disp-total-paket','disp-total-mpp','disp-productivity'].forEach(id=>document.getElementById(id).innerText='0');
        };

        window.closeLaporanModal = () => { const m=document.getElementById('laporan-modal'); m.children[0].classList.add('scale-95','opacity-0'); setTimeout(()=>m.classList.add('hidden'), 300); };
        window.loadHubUsersForAttendance = (hName=null, existingData=[]) => {
            const h = hName || document.getElementById('lap-hub-select').value || document.getElementById('lap-hub-text').value; 
            const tb = document.getElementById('attendance-tbody'); 
            tb.innerHTML = ''; 
            if(!h) return;
            
            // FILTER USERS: 
            // 1. By HUB
            // 2. If Resign, only show if they are already in existingData (Creating new report -> hide resigns. Editing old -> show history)
            const users = appData.users.filter(u => {
                if(u.kode_hub !== h) return false;
                
                if(u.is_resign === true) {
                    const inHistory = existingData && existingData.some(ed => ed.userId === u.id);
                    if(!inHistory) return false; // Hide from new list if resigned
                }
                return true;
            }).sort((a,b) => { 
                const rA=(a.posisi==='LEADER'||a.posisi==='Admin')?0:1, rB=(b.posisi==='LEADER'||b.posisi==='Admin')?0:1; 
                if(rA!==rB)return rA-rB; 
                return a.id.localeCompare(b.id); 
            });

            const map = {}; existingData.forEach(x => map[x.userId] = x);
            users.forEach(u => { const isL = u.posisi==='LEADER'||u.posisi==='Admin'; window.renderRow(tb, u.id, u.nama, u.posisi, isL, map[u.id]||{s1:0,s2:0,s3:0,i:0,s:0,a:0,ket:''}, false); });
            existingData.forEach(x => { if(x.userId.startsWith('manual_')) window.renderRow(tb, x.userId, x.nama, 'DW', false, map[x.userId], true); });
            window.calcMetrics();
        };

        window.deleteLaporan = async (id) => {

            const processDelete = async () => {
                const r = await Swal.fire({
                    title: '',
                    html: `
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 rounded-full border-4 border-orange-300
                                        flex items-center justify-center text-orange-400 mb-4">
                                <i class="fas fa-exclamation text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-extrabold text-slate-800">
                                Hapus Laporan?
                            </h3>
                            <p class="text-xs text-slate-500 mt-2 text-center">
                                Data yang dihapus tidak dapat dikembalikan
                            </p>
                        </div>
                    `,
                    width: '22rem',
                    showCancelButton: true,
                    reverseButtons: true,
                    buttonsStyling: false,
                    confirmButtonText: 'YA, HAPUS',
                    cancelButtonText: 'CANCEL',
                    customClass: {
                        popup: 'rounded-[2rem] border border-slate-100 shadow-2xl px-6 pt-6 pb-5 font-sans',
                        confirmButton: `bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition active:scale-95 uppercase tracking-wide flex-1`,
                        cancelButton: `bg-slate-100 text-slate-500 px-6 py-2.5 rounded-xl font-bold text-xs hover:bg-slate-200 transition active:scale-95 uppercase tracking-wide flex-1`,
                        actions: 'flex gap-3 w-full justify-center mt-6'
                    }
                });

                if (!r.isConfirmed) return;

                try { await deleteDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'laporan', id)); window.notify('Laporan berhasil dihapus', 'success'); } catch (err) { console.error(err); window.notify('Gagal menghapus laporan', 'error'); }
            };

            if (currentUser.role === 'admin') { await processDelete(); return; }

            const { value: code } = await Swal.fire({
                title: '',
                html: `
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 bg-rose-50 rounded-2xl flex items-center justify-center mb-3 text-danger shadow-sm border border-rose-100">
                            <i class="fas fa-user-shield text-xl"></i>
                        </div>
                        <h3 class="text-base font-extrabold text-slate-800">Verifikasi Leader</h3>
                        <p class="text-[11px] text-slate-500 mt-1 font-medium text-center">Masukkan kode akses untuk menghapus laporan</p>
                    </div>
                `,
                input: 'password',
                inputPlaceholder: '',
                inputAttributes: { autocapitalize: 'off', autocorrect: 'off', maxlength: 10, inputmode: 'numeric', pattern: '[0-9A-Za-z]{6,10}' },
                width: '22rem',
                showCancelButton: true,
                confirmButtonText: 'Verifikasi',
                cancelButtonText: 'Batal',
                reverseButtons: true,
                buttonsStyling: false,
                customClass: {
                    popup: 'rounded-[2rem] border border-slate-100 shadow-2xl px-6 pt-6 pb-5 font-sans',
                    input: `w-44 mx-auto bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-center tracking-[0.3em] focus:bg-white focus:ring-2 focus:ring-danger outline-none transition shadow-sm mt-4`,
                    confirmButton: `bg-danger text-white px-5 py-2.5 rounded-xl font-bold text-[11px] shadow-lg shadow-rose-500/30 hover:bg-rose-600 transition active:scale-95 uppercase tracking-wide flex-1`,
                    cancelButton: `bg-slate-100 text-slate-500 px-5 py-2.5 rounded-xl font-bold text-[11px] hover:bg-slate-200 transition active:scale-95 uppercase tracking-wide flex-1`,
                    actions: 'flex gap-2 w-full justify-center mt-4'
                }
            });

            if (!code) return;

            if (code === appData.accessCode) { window.notify('Akses Diberikan', 'success'); await processDelete(); } else { window.notify('Kode Akses Salah', 'error'); }
        };

        window.saveAdminPass = async () => { const p = document.getElementById('new-admin-pass').value; if(p.length<4) return window.notify('Min 4 Char', 'error'); await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { adminPass: p }); window.notify('Password Updated', 'success'); };
        window.saveAccessCode = async () => { const c = document.getElementById('access-code-input').value; if(!c) return; await updateDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'settings', 'main'), { accessCode: c }); window.notify('Kode Updated', 'success'); };
        
        window.getProdColorClass = (val) => val < 600 ? 'bg-red-100 text-red-600 font-bold px-2 py-0.5 rounded text-xs' : 'bg-green-100 text-green-600 font-bold px-2 py-0.5 rounded text-xs';

        // ==========================================================
        // LOGIN & AUTH FUNCTIONS (ADDED FIX)
        // ==========================================================

        window.switchLoginTab = (type) => {
            document.getElementById('form-login-user').classList.toggle('hidden', type !== 'user');
            document.getElementById('form-login-admin').classList.toggle('hidden', type !== 'admin');
            
            const btnUser = document.getElementById('tab-user');
            const btnAdmin = document.getElementById('tab-admin');
            
            if (type === 'user') {
                btnUser.classList.add('bg-white', 'text-primary', 'ring-1', 'ring-black/5', 'shadow-sm');
                btnUser.classList.remove('text-slate-400', 'hover:text-slate-600');
                btnAdmin.classList.remove('bg-white', 'text-primary', 'ring-1', 'ring-black/5', 'shadow-sm');
                btnAdmin.classList.add('text-slate-400', 'hover:text-slate-600');
            } else {
                btnAdmin.classList.add('bg-white', 'text-primary', 'ring-1', 'ring-black/5', 'shadow-sm');
                btnAdmin.classList.remove('text-slate-400', 'hover:text-slate-600');
                btnUser.classList.remove('bg-white', 'text-primary', 'ring-1', 'ring-black/5', 'shadow-sm');
                btnUser.classList.add('text-slate-400', 'hover:text-slate-600');
            }
        };

        window.togglePasswordField = () => {
            const isPic = document.getElementById('is-pic-checkbox').checked;
            const container = document.getElementById('login-pass-container');
            const passInput = document.getElementById('login-pass-user');
            
            if (isPic) {
                container.classList.remove('hidden');
                setTimeout(() => container.style.opacity = '1', 10);
                passInput.setAttribute('required', '');
            } else {
                container.style.opacity = '0';
                setTimeout(() => container.classList.add('hidden'), 300);
                passInput.removeAttribute('required');
                passInput.value = '';
            }
        };

        window.doLogout = () => {
             isLoggingOut = true;
             currentUser = null;
             document.getElementById('app-navbar').classList.add('hidden');
             document.getElementById('app-navbar').classList.remove('md:flex');
             document.getElementById('mobile-topbar').classList.add('hidden');
             document.getElementById('mobile-bottom-nav').classList.add('hidden');
             document.getElementById('mobile-bottom-nav').classList.remove('flex');
             document.getElementById('app-content').classList.add('hidden');
             document.getElementById('login-section').classList.remove('hidden');
             
             // Reset Inputs
             document.getElementById('login-id').value = '';
             document.getElementById('login-pass-user').value = '';
             document.getElementById('login-pass-admin').value = '';
             
             window.switchLoginTab('user');
             isLoggingOut = false;
        };

        function proceedLogin() {
            window.notify('Login Berhasil', 'success');
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Render UI based on role
            const role = currentUser.role;
            document.getElementById('user-name-display').innerText = currentUser.nama;
            document.getElementById('mob-user-name').innerText = currentUser.nama;
            document.getElementById('user-badge').innerText = role === 'admin' ? 'ADMINISTRATOR' : (role === 'pic' ? 'LEADER / PIC' : currentUser.posisi);
            
            // Access Control
            const isAdm = role === 'admin';
            const isAcc = role === 'pic' || (currentUser.akses === 'YA');
            
            // Nav visibility
            document.getElementById('nav-pengaturan').classList.toggle('hidden', !isAdm);
            document.getElementById('mob-nav-pengaturan').classList.toggle('hidden', !isAdm);
            
            // Button Create Laporan visibility
            const btnAdd = document.getElementById('btn-tambah-laporan');
            if (btnAdd) btnAdd.classList.toggle('hidden', !(isAdm || isAcc));

            // Hub Select in Laporan (Admin only)
            const hubSelect = document.getElementById('lap-filter-hub');
            if (hubSelect) hubSelect.classList.toggle('hidden', !isAdm);

            // Hub Select in Absensi (REMOVED OLD CALL, now handled by initAbsensiFilters on nav click)
            // window.renderAbsensiHubSelect(); <-- DELETED

            // Manager Summary Visibility
            const sumSec = document.getElementById('manager-summary-section');
            if (sumSec) sumSec.classList.toggle('hidden', !isAdm);

            // Navbar visibility
            document.getElementById('app-navbar').classList.add('md:flex');
            document.getElementById('mobile-topbar').classList.remove('hidden');
            document.getElementById('mobile-bottom-nav').classList.remove('hidden');
            document.getElementById('mobile-bottom-nav').classList.add('flex');

            // Load Initial Data
            window.navigate('dashboard');
        }

        // Login Submit Handlers
        document.getElementById('form-login-user').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value.trim();
            const isPic = document.getElementById('is-pic-checkbox').checked;
            const pass = document.getElementById('login-pass-user').value;

            if(!id) return window.notify('Masukkan ID', 'error');

            const user = appData.users.find(u => u.id === id);
            
            if (!user) return window.notify('User tidak ditemukan', 'error');
            if (user.is_resign) return window.notify('User Non-Aktif (Resign)', 'error');

            if (isPic) {
                // Login as Leader/PIC
                if (user.posisi !== 'LEADER' && user.posisi !== 'Admin') return window.notify('Bukan akun Leader', 'error');
                if (user.sandi !== pass) return window.notify('Password Salah', 'error');
                currentUser = { ...user, role: 'pic' };
            } else {
                // Login as User
                currentUser = { ...user, role: 'user' };
            }
            proceedLogin();
        };

        document.getElementById('form-login-admin').onsubmit = (e) => {
            e.preventDefault();
            const pass = document.getElementById('login-pass-admin').value;
            if (pass === appData.adminPass) {
                currentUser = { nama: 'Administrator', role: 'admin', kode_hub: 'HO' };
                proceedLogin();
            } else {
                window.notify('Password Admin Salah', 'error');
            }
        };

        // ==========================================================
        // END LOGIN FUNCTIONS
        // ==========================================================

        // ==========================================================
        // MISSING FUNCTIONS DEFINITIONS (Fixed)
        // ==========================================================
        
        // 1. window.renderRow (Untuk Absensi)
        window.renderRow = (tb, id, name, pos, isLeader, d, isManual) => {
            const r = document.createElement('tr');
            r.className = 'hover:bg-slate-50 transition border-b border-slate-50 last:border-0';
            
            // Handle Name Display or Input for Manual
            let nameContent = '';
            if (isManual) {
                nameContent = `<input type="text" class="att-name-input w-full bg-slate-50 border border-slate-200 rounded-lg text-xs px-2 py-1 focus:ring-1 focus:ring-primary font-bold text-slate-700" placeholder="Nama DW..." value="${name}" onkeyup="this.closest('td').querySelector('.att-name').value = this.value">`;
            } else {
                nameContent = `<div class="font-bold text-slate-700 text-xs">${name}</div>`;
            }

            // UPDATE: Menambahkan hidden input 'att-pos' untuk menyimpan posisi (Sorter/DW/Leader)
            r.innerHTML = `
                <td class="p-3 pl-6 text-left">
                    ${nameContent}
                    <div class="text-[10px] text-slate-400 font-mono mt-0.5">${isManual ? 'MANUAL DW' : pos}</div>
                    <input type="hidden" class="att-id" value="${id}">
                    <input type="hidden" class="att-name" value="${name}">
                    <input type="hidden" class="att-pos" value="${isManual ? 'DW' : pos}">
                </td>
                <td class="p-2 text-center"><input type="checkbox" class="att-s1 w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition cursor-pointer" ${d.s1?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2 text-center"><input type="checkbox" class="att-s2 w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition cursor-pointer" ${d.s2?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2 text-center border-r border-slate-100"><input type="checkbox" class="att-s3 w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition cursor-pointer" ${d.s3?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2 text-center"><input type="checkbox" class="att-i w-4 h-4 text-amber-500 rounded focus:ring-amber-500 border-gray-300 transition cursor-pointer" ${d.i?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2 text-center"><input type="checkbox" class="att-s w-4 h-4 text-purple-500 rounded focus:ring-purple-500 border-gray-300 transition cursor-pointer" ${d.s?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2 text-center"><input type="checkbox" class="att-a w-4 h-4 text-red-500 rounded focus:ring-red-500 border-gray-300 transition cursor-pointer" ${d.a?'checked':''} onchange="window.calcMetrics()"></td>
                <td class="p-2"><input type="text" class="att-ket w-full bg-slate-50 border-none rounded-lg text-xs px-2 py-1.5 focus:ring-1 focus:ring-slate-300 placeholder-slate-300" placeholder="..." value="${d.ket||''}"></td>
                <td class="p-2 text-center">${isManual ? `<button type="button" onclick="this.closest('tr').remove(); window.calcMetrics()" class="text-rose-400 hover:text-rose-600 transition"><i class="fas fa-times"></i></button>` : ''}</td>
            `;
            tb.appendChild(r);
        };

        // 2. window.calcMetrics (Menghitung Total MPP & Productivity Real-time)
        window.calcMetrics = () => {
            let mpp = 0;
            // Hitung checkbox yang dicentang (Shift 1/2/3)
            document.querySelectorAll('#attendance-tbody tr').forEach(r => {
                const s1 = r.querySelector('.att-s1').checked;
                const s2 = r.querySelector('.att-s2').checked;
                const s3 = r.querySelector('.att-s3').checked;
                
                // UPDATE: Ambil Posisi
                const posEl = r.querySelector('.att-pos');
                const pos = posEl ? posEl.value : '';

                // UPDATE: Hanya hitung jika posisi adalah 'Sorter' atau 'DW'
                if((s1 || s2 || s3) && (pos === 'Sorter' || pos === 'DW')) mpp++;
            });
            
            // Ambil input paket
            const g = window.parseFormattedNumber(document.getElementById('lap-gateway').value);
            const s = window.parseFormattedNumber(document.getElementById('lap-staging').value);
            const j = window.parseFormattedNumber(document.getElementById('lap-jne').value);
            const sa = window.parseFormattedNumber(document.getElementById('lap-sap').value);
            const total = g + s + j + sa;
            
            // Update UI
            document.getElementById('disp-total-paket').innerText = window.formatNumber(total);
            document.getElementById('val-total-paket').value = total;
            document.getElementById('disp-total-mpp').innerText = mpp;
            
            const prod = mpp > 0 ? Math.round(total / mpp) : 0;
            const prodEl = document.getElementById('disp-productivity');
            prodEl.innerText = window.formatNumber(prod);
            // Dynamic Color Class for Productivity
            if (prod < 600) {
                prodEl.className = 'text-3xl font-extrabold mt-2 text-rose-500';
            } else {
                prodEl.className = 'text-3xl font-extrabold mt-2 text-emerald-600';
            }
        };

        // 3. window.addManualDWRow (Tambah baris manual)
        window.addManualDWRow = () => {
            const id = 'manual_' + Date.now();
            const tb = document.getElementById('attendance-tbody');
            // Cek jika tabel kosong (misal pesan 'Pilih HUB dulu'), bersihkan dulu
            if (tb.children.length > 0 && tb.children[0].innerText.includes('Pilih HUB')) {
                tb.innerHTML = '';
            }
            window.renderRow(tb, id, '', 'DW', false, {s1:0,s2:0,s3:0,i:0,s:0,a:0,ket:''}, true);
        };

        // 4. window.deleteUser (Hapus User)
        window.deleteUser = async (id) => {
            const r = await Swal.fire({
                title: 'Hapus User?',
                text: "User akan dihapus permanen.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Hapus',
                cancelButtonText: 'Batal',
                reverseButtons: true,
                customClass: {
                    popup: 'rounded-[2rem] border border-slate-100 shadow-2xl p-6 font-sans',
                    confirmButton: 'bg-rose-500 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-lg hover:bg-rose-600 transition',
                    cancelButton: 'bg-slate-100 text-slate-500 px-6 py-2.5 rounded-xl font-bold text-xs hover:bg-slate-200 transition'
                }
            });
            if (r.isConfirmed) {
                try {
                    await deleteDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'users', id));
                    window.notify('User dihapus', 'success');
                } catch(e) {
                    window.notify('Gagal menghapus', 'error');
                }
            }
        };

        // 5. Logic SUBMIT FORM LAPORAN
        document.getElementById('laporan-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const hub = currentUser.role==='admin' ? document.getElementById('lap-hub-select').value : document.getElementById('lap-hub-text').value;
            if(!hub) return window.notify('Pilih HUB', 'error');
            
            const rows = document.getElementById('attendance-tbody').children;
            const attData = [];
            let totalMpp = 0;
            let totalFilled = 0; // Variable untuk cek apakah ada absensi yang diisi (Hadir/Ijin/Sakit/Alfa)

            for(let r of rows) {
                if(r.innerText.includes('Pilih HUB')) continue; 
                
                const s1 = r.querySelector('.att-s1').checked;
                const s2 = r.querySelector('.att-s2').checked;
                const s3 = r.querySelector('.att-s3').checked;
                const i = r.querySelector('.att-i').checked;
                const s = r.querySelector('.att-s').checked;
                const a = r.querySelector('.att-a').checked;
                
                // UPDATE: Ambil Posisi untuk filter MPP saat save
                const posEl = r.querySelector('.att-pos');
                const pos = posEl ? posEl.value : '';

                // UPDATE: Hanya hitung Total MPP jika Sorter/DW
                if((s1||s2||s3) && (pos === 'Sorter' || pos === 'DW')) totalMpp++;
                
                if(s1||s2||s3||i||s||a) totalFilled++; // Cek jika ada checkbox yang dicentang
                
                attData.push({
                    userId: r.querySelector('.att-id').value,
                    nama: r.querySelector('.att-name').value, // Use hidden input for name stability
                    s1, s2, s3, i, s, a,
                    ket: r.querySelector('.att-ket').value
                });
            }

            const g = window.parseFormattedNumber(document.getElementById('lap-gateway').value);
            const st = window.parseFormattedNumber(document.getElementById('lap-staging').value);
            const j = window.parseFormattedNumber(document.getElementById('lap-jne').value);
            const sa = window.parseFormattedNumber(document.getElementById('lap-sap').value);
            const totalPaket = g+st+j+sa;
            
            // VALIDASI UPDATED:
            // Wajib isi Paket DAN Absensi (MPP) agar bisa disimpan
            // Jika salah satu masih 0, tolak penyimpanan.
            if (totalPaket <= 0 || totalMpp <= 0) {
                let msg = 'Gagal Simpan: ';
                if(totalPaket <= 0 && totalMpp <= 0) msg += 'Paket & MPP masih kosong';
                else if(totalPaket <= 0) msg += 'Total Paket tidak boleh 0';
                else if(totalMpp <= 0) msg += 'Total MPP (Absen Hadir) tidak boleh 0';
                
                return window.notify(msg, 'error');
            }

            window.notify('Menyimpan Laporan...', 'loading');
            
            const editId = document.getElementById('edit-laporan-id').value;
            const docId = editId || (hub + '_' + document.getElementById('lap-tanggal').value);
            
            const data = {
                id: docId,
                tanggal: document.getElementById('lap-tanggal').value,
                hub: hub,
                gateway: g, staging: st, jne: j, sap: sa,
                total_paket: totalPaket,
                total_mpp: totalMpp,
                productivity: totalMpp>0 ? totalPaket/totalMpp : 0,
                attendance_data: attData,
                last_updated: new Date().toISOString(),
                updated_by: currentUser.name,
                catatan: document.getElementById('lap-catatan').value // Simpan catatan
            };

            try {
                await setDoc(doc(db, 'artifacts', storageId, 'public', 'data', 'laporan', docId), data);
                window.closeLaporanModal();
                window.notify('Laporan Tersimpan', 'success');
            } catch(err) {
                console.error(err);
                window.notify('Gagal menyimpan', 'error');
            }
        };

    </script>
</body>
</html>