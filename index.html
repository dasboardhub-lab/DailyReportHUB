<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report Team</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Styles untuk Tab Navigasi */
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; }

        /* Style Checkbox & Radio */
        .custom-radio { width: 1.15rem; height: 1.15rem; cursor: pointer; }
        .custom-checkbox { width: 1.25rem; height: 1.25rem; cursor: pointer; }
        
        /* Table Sticky Header */
        thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
        
        /* Login Tabs */
        .login-tab-active { background-color: #eff6ff; color: #2563eb; border-color: #2563eb; }
        .login-tab-inactive { color: #64748b; border-color: transparent; }
        .login-tab-inactive:hover { background-color: #f8fafc; }

        /* Hide Number Input Spinner */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- SECURITY MODAL -->
    <div id="security-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-80 transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i data-lucide="shield-alert" class="text-red-600 w-6 h-6"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800">Otorisasi Diperlukan</h3>
                <p class="text-xs text-slate-500">Masukkan Kode Keamanan dari Admin untuk melanjutkan tindakan ini.</p>
            </div>
            <input type="password" id="input-secure-code" class="w-full border border-slate-300 p-2 rounded-lg mb-4 text-center tracking-widest font-bold focus:ring-2 focus:ring-red-500 outline-none" placeholder="****">
            <div id="secure-error" class="text-xs text-red-500 text-center mb-2 hidden">Kode salah!</div>
            <div class="flex gap-2">
                <button id="btn-cancel-secure" class="flex-1 py-2 text-slate-500 border border-slate-200 rounded-lg hover:bg-slate-50">Batal</button>
                <button id="btn-confirm-secure" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Verifikasi</button>
            </div>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-40 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-slate-500 text-sm">Memuat Sistem...</p>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen bg-slate-100 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-slate-200">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-blue-200 shadow-lg">
                    <i data-lucide="file-text" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Daily Report Tim</h1>
                <p class="text-slate-500 text-sm mt-1">Sistem Laporan Harian</p>
            </div>

            <!-- Login Tabs -->
            <div class="grid grid-cols-3 gap-1 mb-6 p-1 bg-slate-100 rounded-lg">
                <button onclick="switchLoginTab('sorter')" id="tab-login-sorter" class="py-2 text-sm font-medium rounded-md transition-all text-center login-tab-inactive">Sorter</button>
                <button onclick="switchLoginTab('leader')" id="tab-login-leader" class="py-2 text-sm font-medium rounded-md transition-all text-center login-tab-active bg-white shadow-sm text-blue-600">Leader</button>
                <button onclick="switchLoginTab('admin')" id="tab-login-admin" class="py-2 text-sm font-medium rounded-md transition-all text-center login-tab-inactive">Admin</button>
            </div>

            <form id="login-form" class="space-y-5">
                <div id="field-nik">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Username / NIK</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="h-5 w-5 text-slate-400"></i>
                        </div>
                        <input type="text" id="login-nik" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" placeholder="Masukan NIK">
                    </div>
                </div>

                <div id="field-pass">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="h-5 w-5 text-slate-400"></i>
                        </div>
                        <input type="password" id="login-pass" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" placeholder="Masukan Password">
                    </div>
                </div>

                <div id="login-error" class="bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 text-center hidden"></div>

                <button type="submit" id="btn-login" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-sm disabled:opacity-50 flex justify-center items-center gap-2">
                    <span>Masuk</span>
                </button>
                
                <p class="text-xs text-center text-slate-400 mt-4" id="login-hint">
                    Masuk sebagai Leader/Staf (Akses Penuh)
                </p>
            </form>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="flex h-screen overflow-hidden hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-64 bg-slate-900 text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out flex flex-col h-full">
            <div class="p-6 border-b border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold">DR</div>
                    <span class="font-bold text-lg tracking-wide">DailyReport</span>
                </div>
                <button id="close-sidebar" class="lg:hidden text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <nav class="flex-1 py-6 px-4 space-y-2 overflow-y-auto">
                <button onclick="navigateTo('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-400 hover:bg-slate-800 hover:text-white" data-target="dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="navigateTo('reports')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-400 hover:bg-slate-800 hover:text-white" data-target="reports">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span class="font-medium">Laporan Harian</span>
                </button>
                <button onclick="navigateTo('settings')" id="menu-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-slate-400 hover:bg-slate-800 hover:text-white hidden" data-target="settings">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Pengaturan</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <div class="bg-slate-800 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="user-circle" class="text-slate-400 w-8 h-8"></i>
                        <div class="overflow-hidden">
                            <p id="user-name-display" class="text-sm font-medium text-white truncate">User</p>
                            <p id="user-role-display" class="text-xs text-blue-400 uppercase font-bold tracking-wider">ROLE</p>
                        </div>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-slate-700 rounded-lg text-slate-400 hover:bg-red-600 hover:text-white hover:border-red-600 transition-all text-sm">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Keluar</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm border-b border-slate-200 lg:hidden flex-shrink-0">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="open-sidebar" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <span class="font-bold text-slate-800">Daily Report</span>
                    </div>
                </div>
            </header>

            <!-- Content Views -->
            <main class="flex-1 overflow-y-auto p-4 lg:p-8 bg-slate-50">
                <div class="max-w-[1400px] mx-auto">
                    
                    <!-- VIEW: DASHBOARD -->
                    <div id="view-dashboard" class="content-view hidden space-y-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-800 mb-2 md:mb-0">Dashboard Overview</h2>
                        </div>

                        <!-- Filter Section -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Mulai Tanggal</label>
                                    <input type="date" id="dash-start-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Sampai Tanggal</label>
                                    <input type="date" id="dash-end-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Filter HUB</label>
                                    <div id="dash-hub-container">
                                        <select disabled class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-slate-100"><option>Loading...</option></select>
                                    </div>
                                </div>
                                <div>
                                    <button onclick="loadDashboardStats()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="filter" class="w-4 h-4"></i> Terapkan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Cards (NEW) -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div class="text-xs font-medium text-slate-500 mb-1">TOTAL PAKET</div>
                                <div id="kpi-total-paket" class="text-2xl font-bold text-blue-600">0</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div class="text-xs font-medium text-slate-500 mb-1">TOTAL MPP</div>
                                <div id="kpi-total-mpp" class="text-2xl font-bold text-slate-700">0</div>
                                <div class="text-[10px] text-slate-400">Sorter + DW Only</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div class="text-xs font-medium text-slate-500 mb-1">PRODUKTIVITAS</div>
                                <div id="kpi-productivity" class="text-2xl font-bold text-green-600">0</div>
                                <div class="text-[10px] text-slate-400">Avg (Paket/Orang)</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div class="text-xs font-medium text-slate-500 mb-1">TOTAL COST</div>
                                <div id="kpi-total-cost" class="text-xl font-bold text-red-600">0</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div class="text-xs font-medium text-slate-500 mb-1">CPP (AVG)</div>
                                <div id="kpi-cpp" class="text-xl font-bold text-purple-600">0</div>
                                <div class="text-[10px] text-slate-400">Cost Per Packet</div>
                            </div>
                        </div>

                        <!-- Chart Annual Section -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-700 mb-4">Tren Performa Tahunan (Bulanan)</h3>
                            <div class="relative h-64 w-full">
                                <canvas id="annualChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart Daily Section -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-700 mb-4">Tren Harian (Sesuai Filter)</h3>
                            <div class="relative h-64 w-full">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>

                        <!-- Bottom Tables Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <!-- Detailed Daily Table -->
                            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 border-b border-slate-100 bg-slate-50">
                                    <h3 class="font-bold text-slate-700">Rincian Pertanggal</h3>
                                </div>
                                <div class="overflow-x-auto max-h-96">
                                    <table class="w-full text-left text-sm whitespace-nowrap">
                                        <thead class="bg-slate-50 text-slate-500 font-medium">
                                            <tr>
                                                <th class="p-3">Tanggal</th>
                                                <th class="p-3 text-right">MPP</th>
                                                <th class="p-3 text-right">Gateway</th>
                                                <th class="p-3 text-right">Staging</th>
                                                <th class="p-3 text-right">SAP</th>
                                                <th class="p-3 text-right">JNE</th>
                                                <th class="p-3 text-right font-bold text-blue-600">Total Outbound</th>
                                                <th class="p-3 text-right font-bold text-green-600">Prod. HUB</th>
                                                <th class="p-3 text-right">Cost Mitra</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dash-table-daily" class="divide-y divide-slate-100">
                                            <tr><td colspan="9" class="p-4 text-center text-slate-400">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Breakdown Per HUB Table -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 border-b border-slate-100 bg-slate-50">
                                    <h3 class="font-bold text-slate-700">Breakdown Performance per HUB</h3>
                                </div>
                                <div class="overflow-x-auto max-h-96">
                                    <table class="w-full text-left text-sm whitespace-nowrap">
                                        <thead class="bg-slate-50 text-slate-500 font-medium">
                                            <tr>
                                                <th class="p-3">HUB</th>
                                                <th class="p-3 text-right">Total MPP</th>
                                                <th class="p-3 text-right">Total Outbound</th>
                                                <th class="p-3 text-right">Prod. HUB</th>
                                                <th class="p-3 text-right">Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dash-table-hub" class="divide-y divide-slate-100">
                                            <tr><td colspan="5" class="p-4 text-center text-slate-400">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- VIEW: REPORTS -->
                    <div id="view-reports" class="content-view hidden space-y-6">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-slate-800">Laporan Harian</h2>
                            <span id="current-date-display" class="text-sm text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-200"></span>
                        </div>
                        
                        <!-- Form Input -->
                        <div id="section-input-report" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i> <span id="form-report-title">Input Laporan Operasional</span>
                            </h3>
                            
                            <form id="form-daily-report" class="space-y-6">
                                <input type="hidden" id="edit-report-id"> 
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border border-slate-100">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Tanggal Laporan</label>
                                        <input type="date" id="rpt-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">HUB Operasional</label>
                                        <div id="rpt-hub-container">
                                            <input type="text" id="rpt-hub-static" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-slate-200 text-slate-600 font-bold" placeholder="Auto" readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Metric Inputs -->
                                <div>
                                    <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i> Metrik Operasional
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Gateway</label>
                                            <input type="number" id="rpt-gateway" class="metric-input w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Staging</label>
                                            <input type="number" id="rpt-staging" class="metric-input w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">SAP</label>
                                            <input type="number" id="rpt-sap" class="metric-input w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0" min="0">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">JNE</label>
                                            <input type="number" id="rpt-jne" class="metric-input w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0" min="0">
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded-lg border border-blue-100">
                                            <label class="block text-xs font-bold text-blue-700 mb-1">TOTAL PAKET</label>
                                            <input type="text" id="rpt-total-paket" class="w-full bg-transparent font-bold text-xl text-blue-700 text-right outline-none" value="0" readonly>
                                        </div>
                                        <div class="bg-green-50 p-2 rounded-lg border border-green-100 col-span-2 md:col-span-5 mt-2 flex justify-between items-center">
                                            <div>
                                                <label class="block text-xs font-bold text-green-700">PRODUKTIVITAS</label>
                                                <span class="text-xs text-green-600">(Total Paket / MPP Sorter+DW)</span>
                                            </div>
                                            <input type="text" id="rpt-productivity" class="bg-transparent font-bold text-lg text-green-700 text-right outline-none w-32" value="0" readonly>
                                        </div>
                                    </div>
                                </div>

                                <!-- Attendance -->
                                <div>
                                    <div class="flex justify-between items-end mb-3">
                                        <h4 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                            <i data-lucide="users" class="w-4 h-4 text-blue-500"></i> Kehadiran Tim (MPP)
                                        </h4>
                                        <div class="text-right">
                                            <span class="text-xs text-slate-500 uppercase">Total MPP (Working)</span>
                                            <div id="display-total-mpp" class="text-2xl font-bold text-green-600 leading-none">0</div>
                                            <p class="text-[10px] text-slate-400">*Hanya Sorter & DW</p>
                                        </div>
                                    </div>
                                    <div class="border border-slate-200 rounded-lg overflow-hidden bg-white">
                                        <div class="max-h-80 overflow-y-auto">
                                            <table class="w-full text-sm text-left">
                                                <thead class="bg-slate-100 text-slate-600 font-medium">
                                                    <tr>
                                                        <th class="p-3 w-1/3 min-w-[150px]">Nama Karyawan</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50">S1</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50">S2</th>
                                                        <th class="p-3 text-center w-12 bg-blue-50">S3</th>
                                                        <th class="p-3 text-center w-12 bg-yellow-50">I</th>
                                                        <th class="p-3 text-center w-12 bg-red-50">S</th>
                                                        <th class="p-3 text-center w-12 bg-red-100">A</th>
                                                        <th class="p-3 w-1/4">Keterangan</th>
                                                        <th class="p-3 w-8"></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sorter-attendance-list" class="divide-y divide-slate-100"></tbody>
                                            </table>
                                        </div>
                                        <div class="p-3 bg-slate-50 border-t border-slate-200">
                                            <button type="button" onclick="addDwRow()" class="text-sm text-blue-600 font-medium flex items-center gap-2 hover:text-blue-800">
                                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Tambah DW Manual
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-2">*Pilih satu status per nama (S1/S2/S3 = Shift, I=Ijin, S=Sakit, A=Alfa).</p>
                                </div>

                                <div class="flex items-center justify-end pt-4 gap-3 border-t border-slate-100">
                                    <button type="button" id="btn-cancel-report-edit" class="hidden text-slate-500 px-4 py-2 hover:bg-slate-100 rounded-lg text-sm" onclick="resetReportForm()">Batal Edit</button>
                                    <p id="rpt-msg" class="text-sm hidden"></p>
                                    <button type="submit" id="btn-save-report" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Laporan
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Table History -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <h3 class="font-semibold text-slate-800">Riwayat Laporan</h3>
                                <button onclick="loadMyReports()" class="text-blue-600 text-xs hover:text-blue-800 font-medium">Refresh Data</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 font-medium">
                                        <tr>
                                            <th class="p-3">Tanggal</th>
                                            <th class="p-3">HUB</th>
                                            <th class="p-3 text-right">Total Paket</th>
                                            <th class="p-3 text-right">Total MPP</th>
                                            <th class="p-3 text-right">Prod.</th>
                                            <th class="p-3 text-right">Cost</th>
                                            <th class="p-3 text-right">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rpt-history-body" class="divide-y divide-slate-100">
                                        <tr><td colspan="7" class="p-4 text-center text-slate-400">Memuat data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: SETTINGS (No Changes to this block needed, kept for context) -->
                    <div id="view-settings" class="content-view hidden space-y-6">
                        <!-- ... Settings Content ... -->
                         <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-slate-800">Pengaturan Sistem</h2>
                        </div>
                        <div class="flex border-b border-slate-200 mb-6 gap-6 overflow-x-auto">
                            <button onclick="switchSettingsTab('hubs')" id="tab-btn-hubs" class="pb-3 px-1 text-sm font-medium whitespace-nowrap tab-active transition-colors">Data HUB</button>
                            <button onclick="switchSettingsTab('employees')" id="tab-btn-employees" class="pb-3 px-1 text-sm font-medium whitespace-nowrap tab-inactive transition-colors">Data Karyawan</button>
                            <button onclick="switchSettingsTab('config')" id="tab-btn-config" class="pb-3 px-1 text-sm font-medium whitespace-nowrap tab-inactive transition-colors flex items-center gap-2"><i data-lucide="settings-2" class="w-3 h-3"></i> Konfigurasi Umum</button>
                        </div>
                        <div id="tab-content-hubs" class="settings-tab-content space-y-6">
                             <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-blue-600"></i> Tambah / Edit HUB</h3>
                                <form id="form-add-hub" class="flex flex-col md:flex-row gap-4 items-end">
                                    <input type="hidden" id="edit-hub-id">
                                    <div class="w-full md:w-1/4"><label class="block text-xs font-medium text-slate-500 mb-1">Kode HUB</label><input type="text" id="hub-code" class="w-full p-2 border border-slate-300 rounded-lg text-sm uppercase" placeholder="KODE" required></div>
                                    <div class="w-full md:w-2/4"><label class="block text-xs font-medium text-slate-500 mb-1">Nama HUB</label><input type="text" id="hub-name" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="Nama Lokasi HUB" required></div>
                                    <div class="w-full md:w-1/4"><label class="block text-xs font-medium text-slate-500 mb-1">Rate Sorter (Rp)</label><input type="number" id="hub-rate" class="w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0"></div>
                                    <button type="submit" id="btn-save-hub" class="w-full md:w-auto bg-blue-600 text-white p-2 rounded-lg text-sm font-medium hover:bg-blue-700 min-w-[80px]">Simpan</button>
                                    <button type="button" id="btn-cancel-hub" class="hidden text-slate-500 text-sm" onclick="resetHubForm()">Batal</button>
                                </form>
                                <p id="hub-msg" class="text-xs mt-3 hidden"></p>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-medium"><tr><th class="p-4">Kode</th><th class="p-4">Nama HUB</th><th class="p-4 text-right">Rate Sorter</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="hub-table-body" class="divide-y divide-slate-100"></tbody></table></div>
                        </div>
                        <div id="tab-content-employees" class="settings-tab-content hidden space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-blue-600"></i> <span id="form-user-title">Tambah Data Karyawan</span></h3><form id="form-add-user" class="space-y-4"><input type="hidden" id="edit-user-id"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="block text-xs font-medium text-slate-500 mb-1">NIK</label><input type="text" id="user-nik" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="Nomor Induk" required></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Nama Lengkap</label><input type="text" id="user-name" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="Nama" required></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Penempatan HUB</label><select id="user-hub" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white" required><option value="">Pilih HUB...</option></select></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Status / Jabatan</label><select id="user-role" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white" required><option value="leader">Leader</option><option value="sorter">Sorter</option><option value="dw">DW</option></select></div></div><div class="bg-slate-50 p-4 rounded-lg border border-slate-100 flex flex-col md:flex-row gap-4 items-center"><div class="flex items-center gap-2"><input type="checkbox" id="user-can-login" class="custom-checkbox accent-blue-600" onchange="togglePasswordInput()"><label for="user-can-login" class="text-sm font-medium text-slate-700 cursor-pointer">Beri Akses Login Aplikasi?</label></div><div id="password-container" class="flex-1 hidden"><input type="text" id="user-pass" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="Set Password Login"></div></div><div class="flex gap-2"><button type="submit" id="btn-save-user" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">Simpan Data</button><button type="button" id="btn-cancel-edit" class="hidden bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-300" onclick="resetUserForm()">Batal Edit</button></div></form><p id="user-msg" class="text-xs mt-3 hidden"></p></div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-medium"><tr><th class="p-4">Nama</th><th class="p-4">HUB</th><th class="p-4">Status</th><th class="p-4">Pass Login</th><th class="p-4">Aktif/Tdk</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="user-table-body" class="divide-y divide-slate-100"></tbody></table></div>
                        </div>
                        <div id="tab-content-config" class="settings-tab-content hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5 text-blue-600"></i> Akun & Keamanan</h3><form id="form-config-security" class="space-y-4"><div><label class="block text-xs font-medium text-slate-500 mb-1">Ganti Password Admin</label><input type="text" id="config-admin-pass" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="Password Baru"></div><div><label class="block text-xs font-medium text-slate-500 mb-1">Kode Otorisasi (Delete/Edit)</label><input type="text" id="config-secure-code" class="w-full p-2 border border-slate-300 rounded-lg text-sm font-mono tracking-widest" placeholder="123456"></div><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 w-full">Update Keamanan</button></form></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="wallet" class="w-5 h-5 text-green-600"></i> Biaya Operasional Global</h3><form id="form-config-cost" class="space-y-4"><div><label class="block text-xs font-medium text-slate-500 mb-1">Biaya DW per Kehadiran (Rp)</label><input type="number" id="config-dw-rate" class="w-full p-2 border border-slate-300 rounded-lg text-sm text-right" placeholder="0"><p class="text-xs text-slate-400 mt-1">*Berlaku sama untuk semua HUB</p></div><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 w-full">Update Biaya</button></form></div></div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, onSnapshot, orderBy, limit, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // KONFIGURASI FIREBASE
        // ==========================================
        
        let firebaseConfig;
        let APP_ID;

        if (typeof __firebase_config !== 'undefined') {
            console.log("Mode Preview: Menggunakan Sandbox Database");
            firebaseConfig = JSON.parse(__firebase_config);
            APP_ID = 'daily-report-app-v2'; 
        } else {
            console.log("Mode Live: Menggunakan Database Production");
            firebaseConfig = {
                apiKey: "AIzaSyBBlbxiBpBR522JTI5xyxakGK9AEChXv1o",
                authDomain: "dailyreport-cfc8f.firebaseapp.com",
                projectId: "dailyreport-cfc8f",
                storageBucket: "dailyreport-cfc8f.firebasestorage.app",
                messagingSenderId: "963104518926",
                appId: "1:963104518926:web:81fb969a3573764f8c5d5f"
            };
            APP_ID = "daily-report-app-v2"; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE MANAGEMENT ---
        let state = {
            user: null, role: null, userData: null, loginTab: 'leader',
            currentView: 'dashboard', hubs: [], employees: [],
            config: { secure_code: '123456', admin_password: 'admin123', dw_rate: 0 },
            chartAnnual: null, chartDaily: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            loading: document.getElementById('loading-screen'),
            loginScreen: document.getElementById('login-screen'),
            appScreen: document.getElementById('app-screen'),
            loginForm: document.getElementById('login-form'),
            loginNik: document.getElementById('login-nik'),
            loginPass: document.getElementById('login-pass'),
            fieldNik: document.getElementById('field-nik'),
            fieldPass: document.getElementById('field-pass'),
            loginError: document.getElementById('login-error'),
            btnLogin: document.getElementById('btn-login'),
            loginHint: document.getElementById('login-hint'),
            tabLoginSorter: document.getElementById('tab-login-sorter'),
            tabLoginLeader: document.getElementById('tab-login-leader'),
            tabLoginAdmin: document.getElementById('tab-login-admin'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            openSidebarBtn: document.getElementById('open-sidebar'),
            closeSidebarBtn: document.getElementById('close-sidebar'),
            menuSettings: document.getElementById('menu-settings'),
            userNameDisplay: document.getElementById('user-name-display'),
            userRoleDisplay: document.getElementById('user-role-display'),
            securityModal: document.getElementById('security-modal'),
            inputSecureCode: document.getElementById('input-secure-code'),
            btnCancelSecure: document.getElementById('btn-cancel-secure'),
            btnConfirmSecure: document.getElementById('btn-confirm-secure'),
            secureError: document.getElementById('secure-error'),
            views: { dashboard: document.getElementById('view-dashboard'), reports: document.getElementById('view-reports'), settings: document.getElementById('view-settings') },
            dashName: document.getElementById('dash-name'), dashRole: document.getElementById('dash-role'), dashInfo: document.getElementById('dash-info'),
            dashStartDate: document.getElementById('dash-start-date'), dashEndDate: document.getElementById('dash-end-date'), dashHubContainer: document.getElementById('dash-hub-container'),
            // KPI Elements
            kpiTotalPaket: document.getElementById('kpi-total-paket'),
            kpiTotalMpp: document.getElementById('kpi-total-mpp'),
            kpiProductivity: document.getElementById('kpi-productivity'),
            kpiTotalCost: document.getElementById('kpi-total-cost'),
            kpiCpp: document.getElementById('kpi-cpp'),
            canvasAnnual: document.getElementById('annualChart'), canvasDaily: document.getElementById('dailyChart'),
            dashTableDaily: document.getElementById('dash-table-daily'), dashTableHub: document.getElementById('dash-table-hub'),
            sectionInputReport: document.getElementById('section-input-report'), formDailyReport: document.getElementById('form-daily-report'), formReportTitle: document.getElementById('form-report-title'), editReportId: document.getElementById('edit-report-id'), rptDate: document.getElementById('rpt-date'), rptHubContainer: document.getElementById('rpt-hub-container'), rptHub: document.getElementById('rpt-hub'), rptGateway: document.getElementById('rpt-gateway'), rptStaging: document.getElementById('rpt-staging'), rptSap: document.getElementById('rpt-sap'), rptJne: document.getElementById('rpt-jne'), rptTotalPaket: document.getElementById('rpt-total-paket'), rptProductivity: document.getElementById('rpt-productivity'), btnCancelReportEdit: document.getElementById('btn-cancel-report-edit'), sorterAttendanceList: document.getElementById('sorter-attendance-list'), displayTotalMpp: document.getElementById('display-total-mpp'), btnSaveReport: document.getElementById('btn-save-report'), rptMsg: document.getElementById('rpt-msg'), rptHistoryBody: document.getElementById('rpt-history-body'),
            formAddHub: document.getElementById('form-add-hub'), editHubId: document.getElementById('edit-hub-id'), hubCode: document.getElementById('hub-code'), hubName: document.getElementById('hub-name'), hubRate: document.getElementById('hub-rate'), btnSaveHub: document.getElementById('btn-save-hub'), btnCancelHub: document.getElementById('btn-cancel-hub'), hubMsg: document.getElementById('hub-msg'), hubTableBody: document.getElementById('hub-table-body'),
            formAddUser: document.getElementById('form-add-user'), formUserTitle: document.getElementById('form-user-title'), editUserId: document.getElementById('edit-user-id'), userNik: document.getElementById('user-nik'), userName: document.getElementById('user-name'), userHub: document.getElementById('user-hub'), userRole: document.getElementById('user-role'), userCanLogin: document.getElementById('user-can-login'), userPass: document.getElementById('user-pass'), passContainer: document.getElementById('password-container'), btnSaveUser: document.getElementById('btn-save-user'), btnCancelEdit: document.getElementById('btn-cancel-edit'), userMsg: document.getElementById('user-msg'), userTableBody: document.getElementById('user-table-body'), userCount: document.getElementById('user-count'),
            formConfigSecurity: document.getElementById('form-config-security'), configAdminPass: document.getElementById('config-admin-pass'), configSecureCode: document.getElementById('config-secure-code'), formConfigCost: document.getElementById('form-config-cost'), configDwRate: document.getElementById('config-dw-rate'), configMsg: document.getElementById('config-msg')
        };

        // --- UTILS ---
        function formatNumber(num) { return Number(num).toLocaleString('id-ID'); }

        // --- INITIALIZATION ---
        async function init() {
            try { lucide.createIcons(); } catch(e) {}
            if (typeof __initial_auth_token !== 'undefined') { try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) {} }
            loadGlobalConfig();
            onAuthStateChanged(auth, (currentUser) => {
                state.user = currentUser;
                const savedRole = localStorage.getItem('userRole');
                const savedUserData = localStorage.getItem('userData');
                if (currentUser && savedRole) {
                    state.role = savedRole;
                    if (savedUserData) state.userData = JSON.parse(savedUserData);
                    showApp();
                } else { state.role = null; state.userData = null; showLogin(); }
                els.loading.classList.add('hidden');
            });
        }

        async function loadGlobalConfig() {
            try {
                const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'config'));
                if (snap.exists()) state.config = { ...state.config, ...snap.data() };
            } catch(e) { console.error(e); }
        }

        // --- SECURITY LOGIC ---
        let pendingSecureAction = null;
        function secureCheck(callback) {
            if (state.role === 'admin') { callback(); return; }
            pendingSecureAction = callback;
            els.inputSecureCode.value = ''; els.secureError.classList.add('hidden'); els.securityModal.classList.remove('hidden'); els.inputSecureCode.focus();
        }
        function closeSecureModal() { els.securityModal.classList.add('hidden'); pendingSecureAction = null; }
        els.btnCancelSecure.addEventListener('click', closeSecureModal);
        els.btnConfirmSecure.addEventListener('click', () => {
            if (els.inputSecureCode.value.trim() === state.config.secure_code) { closeSecureModal(); if(pendingSecureAction) pendingSecureAction(); } 
            else { els.secureError.textContent = "Kode salah!"; els.secureError.classList.remove('hidden'); }
        });

        // Config Save
        async function saveConfig(data) {
            try { await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'config'), data, { merge: true }); state.config = { ...state.config, ...data }; showStatusMsg(els.configMsg, "Tersimpan!", "success"); } catch(e) { showStatusMsg(els.configMsg, "Gagal.", "error"); }
        }
        els.formConfigSecurity.addEventListener('submit', (e) => { e.preventDefault(); const p = els.configAdminPass.value.trim(); const c = els.configSecureCode.value.trim(); const u={}; if(p)u.admin_password=p; if(c)u.secure_code=c; if(Object.keys(u).length) saveConfig(u); });
        els.formConfigCost.addEventListener('submit', (e) => { e.preventDefault(); saveConfig({ dw_rate: Number(els.configDwRate.value) }); });

        // --- LOGIN LOGIC ---
        window.switchLoginTab = (tab) => {
            state.loginTab = tab;
            ['sorter', 'leader', 'admin'].forEach(t => { const el = document.getElementById(`tab-login-${t}`); if(t === tab) el.className = "py-2 text-sm font-medium rounded-md transition-all text-center login-tab-active bg-white shadow-sm text-blue-600"; else el.className = "py-2 text-sm font-medium rounded-md transition-all text-center login-tab-inactive"; });
            els.loginError.classList.add('hidden'); els.loginNik.value = ''; els.loginPass.value = '';
            if (tab === 'sorter') { els.fieldNik.classList.remove('hidden'); els.fieldPass.classList.add('hidden'); els.loginHint.textContent = "Masuk sebagai Sorter (View Only)"; els.loginNik.required = true; els.loginPass.required = false; } 
            else if (tab === 'leader') { els.fieldNik.classList.remove('hidden'); els.fieldPass.classList.remove('hidden'); els.loginHint.textContent = "Masuk sebagai Leader/Staf"; els.loginNik.required = true; els.loginPass.required = true; } 
            else if (tab === 'admin') { els.fieldNik.classList.add('hidden'); els.fieldPass.classList.remove('hidden'); els.loginHint.textContent = "Masuk sebagai Administrator"; els.loginNik.required = false; els.loginPass.required = true; }
        };

        els.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const tab = state.loginTab; const nik = els.loginNik.value.trim(); const pass = els.loginPass.value.trim();
            els.loginError.classList.add('hidden'); els.btnLogin.disabled = true; els.btnLogin.textContent = 'Memeriksa...';
            try {
                if (!auth.currentUser) { try { if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch(e) {} }
                if(!state.config.admin_password) await loadGlobalConfig();

                if (tab === 'admin') {
                    if (pass === state.config.admin_password) updateLocalState('admin', { name: 'Administrator', nik: 'ADMIN' });
                    else throw new Error('Password Admin Salah');
                } else if (tab === 'leader') {
                    const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("nik", "==", nik), where("password", "==", pass));
                    const snap = await getDocs(q);
                    if (!snap.empty) { const u = snap.docs[0].data(); if (u.can_login) updateLocalState('leader', u); else throw new Error('Akun ini tidak memiliki akses login.'); } 
                    else throw new Error('NIK atau Password Salah');
                } else if (tab === 'sorter') {
                    const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), where("nik", "==", nik));
                    const snap = await getDocs(q);
                    if (!snap.empty) updateLocalState('sorter', snap.docs[0].data()); else throw new Error('NIK tidak ditemukan.');
                }
            } catch (err) { els.loginError.textContent = err.message || 'Login Gagal'; els.loginError.classList.remove('hidden'); els.btnLogin.disabled = false; els.btnLogin.textContent = 'Masuk'; }
        });

        function updateLocalState(role, userData) {
            state.role = role; state.userData = userData;
            localStorage.setItem('userRole', role); localStorage.setItem('userData', JSON.stringify(userData)); showApp();
        }

        function showLogin() { els.loginScreen.classList.remove('hidden'); els.appScreen.classList.add('hidden'); switchLoginTab('leader'); }
        function showApp() {
            els.loginScreen.classList.add('hidden'); els.appScreen.classList.remove('hidden');
            els.userNameDisplay.textContent = state.userData?.name || 'User'; els.userRoleDisplay.textContent = state.userData?.role || state.role;
            if (state.role === 'admin') els.menuSettings.classList.remove('hidden'); else els.menuSettings.classList.add('hidden');
            if (state.role === 'sorter') els.sectionInputReport.classList.add('hidden'); else els.sectionInputReport.classList.remove('hidden');
            navigateTo('dashboard');
        }

        window.navigateTo = (viewId) => {
            state.currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === viewId) { el.classList.add('bg-blue-600', 'text-white', 'shadow-lg'); el.classList.remove('text-slate-400', 'hover:bg-slate-800'); } 
                else { el.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'); el.classList.add('text-slate-400', 'hover:bg-slate-800'); }
            });
            Object.values(els.views).forEach(el => el.classList.add('hidden'));
            if (els.views[viewId]) els.views[viewId].classList.remove('hidden');
            if (viewId === 'dashboard') loadDashboard(); if (viewId === 'reports') loadReportsView(); if (viewId === 'settings' && state.role === 'admin') loadSettings();
            els.sidebar.classList.add('-translate-x-full'); els.sidebarOverlay.classList.add('hidden');
        };

        function loadDashboard() {
            els.dashName.textContent = state.userData?.name || state.role; els.dashRole.textContent = state.userData?.role || state.role; els.dashInfo.textContent = state.role === 'admin' ? 'Admin Mode' : (state.role === 'sorter' ? 'View Only' : 'User Mode');
            if(!els.dashStartDate.value) { const now = new Date(); const start = new Date(now.getFullYear(), 0, 1); els.dashStartDate.valueAsDate = start; els.dashEndDate.valueAsDate = now; }
            if (state.role === 'admin') {
                if (state.hubs.length === 0) {
                    getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs')).then(snap => {
                        state.hubs = snap.docs.map(d => d.data());
                        let options = `<option value="">Semua HUB</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name}</option>`).join('');
                        els.dashHubContainer.innerHTML = `<select id="dash-hub-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white">${options}</select>`;
                    });
                } else {
                    let options = `<option value="">Semua HUB</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name}</option>`).join('');
                    els.dashHubContainer.innerHTML = `<select id="dash-hub-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white">${options}</select>`;
                }
            } else {
                els.dashHubContainer.innerHTML = `<input type="text" value="${state.userData?.hub_code || '-'}" readonly class="w-full p-2 bg-slate-100 border border-slate-300 rounded-lg text-sm text-slate-500 font-bold">`;
            }
            loadDashboardStats();
        }

        window.loadDashboardStats = async () => {
            const start = els.dashStartDate.value; const end = els.dashEndDate.value;
            let hubFilter = state.role === 'admin' ? (document.getElementById('dash-hub-select')?.value || '') : state.userData?.hub_code;
            
            try {
                const reportsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports');
                const q = query(reportsRef, where("date", ">=", start), where("date", "<=", end)); 
                const snap = await getDocs(q);
                
                let reports = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if (!hubFilter || d.hub === hubFilter) { reports.push(d); }
                });

                reports.sort((a, b) => a.date.localeCompare(b.date));

                let totalPaket = 0; let totalMppAll = 0; let totalCost = 0;
                const monthlyData = {}; const dailyData = {}; const hubData = {};

                reports.forEach(r => {
                    totalPaket += (r.total_paket || 0);
                    totalMppAll += (r.total_mpp || 0);
                    totalCost += (r.est_cost || 0);

                    // Monthly
                    const monthKey = r.date.substring(0, 7);
                    if(!monthlyData[monthKey]) monthlyData[monthKey] = { paket: 0, mpp: 0 };
                    monthlyData[monthKey].paket += (r.total_paket || 0);
                    monthlyData[monthKey].mpp += (r.total_mpp || 0);

                    // Daily (Date)
                    const dateKey = r.date;
                    if(!dailyData[dateKey]) dailyData[dateKey] = { date: r.date, mpp: 0, staging: 0, gateway: 0, jne: 0, sap: 0, outbound: 0, cost: 0 };
                    dailyData[dateKey].mpp += (r.total_mpp || 0);
                    dailyData[dateKey].staging += (r.staging || 0);
                    dailyData[dateKey].gateway += (r.gateway || 0);
                    dailyData[dateKey].jne += (r.jne || 0);
                    dailyData[dateKey].sap += (r.sap || 0);
                    dailyData[dateKey].outbound += (r.total_paket || 0);
                    dailyData[dateKey].cost += (r.est_cost || 0);

                    // Hub
                    const hKey = r.hub;
                    if(!hubData[hKey]) hubData[hKey] = { hub: r.hub, mpp: 0, outbound: 0, cost: 0 };
                    hubData[hKey].mpp += (r.total_mpp || 0);
                    hubData[hKey].outbound += (r.total_paket || 0);
                    hubData[hKey].cost += (r.est_cost || 0);
                });

                // Calculate Aggregates for KPI
                const avgProd = totalMppAll > 0 ? Math.round(totalPaket / totalMppAll) : 0;
                const avgCpp = totalPaket > 0 ? Math.round(totalCost / totalPaket) : 0;

                // Render KPI
                els.kpiTotalPaket.textContent = formatNumber(totalPaket);
                els.kpiTotalMpp.textContent = formatNumber(totalMppAll);
                els.kpiProductivity.textContent = formatNumber(avgProd);
                els.kpiTotalCost.textContent = "Rp " + formatNumber(totalCost);
                els.kpiCpp.textContent = "Rp " + formatNumber(avgCpp);

                // Render Charts
                const monthLabels = Object.keys(monthlyData).sort();
                renderChart(els.canvasAnnual, 
                    monthLabels.map(k => new Date(k+"-01").toLocaleDateString('id-ID', {month:'short', year:'2-digit'})), 
                    monthLabels.map(k => monthlyData[k].paket), 
                    monthLabels.map(k => monthlyData[k].mpp > 0 ? Math.round(monthlyData[k].paket / monthlyData[k].mpp) : 0), 
                    'chartAnnual'
                );

                const dateLabels = Object.keys(dailyData).sort();
                renderChart(els.canvasDaily, 
                    dateLabels.map(d => new Date(d).toLocaleDateString('id-ID', {day:'numeric', month:'short'})),
                    dateLabels.map(k => dailyData[k].outbound),
                    dateLabels.map(k => dailyData[k].mpp > 0 ? Math.round(dailyData[k].outbound / dailyData[k].mpp) : 0),
                    'chartDaily'
                );

                // Render Tables
                els.dashTableDaily.innerHTML = dateLabels.reverse().map(k => {
                    const d = dailyData[k];
                    const prod = d.mpp > 0 ? Math.round(d.outbound / d.mpp) : 0;
                    return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-3">${d.date}</td><td class="p-3 text-right">${d.mpp}</td><td class="p-3 text-right">${formatNumber(d.gateway)}</td><td class="p-3 text-right">${formatNumber(d.staging)}</td><td class="p-3 text-right">${formatNumber(d.sap)}</td><td class="p-3 text-right">${formatNumber(d.jne)}</td><td class="p-3 text-right font-bold text-blue-600">${formatNumber(d.outbound)}</td><td class="p-3 text-right font-bold text-green-600">${formatNumber(prod)}</td><td class="p-3 text-right">Rp ${formatNumber(d.cost)}</td></tr>`;
                }).join('');

                els.dashTableHub.innerHTML = Object.keys(hubData).sort().map(k => {
                    const h = hubData[k];
                    const prod = h.mpp > 0 ? Math.round(h.outbound / h.mpp) : 0;
                    return `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-3 font-medium">${h.hub}</td><td class="p-3 text-right">${h.mpp}</td><td class="p-3 text-right text-blue-600">${formatNumber(h.outbound)}</td><td class="p-3 text-right text-green-600">${formatNumber(prod)}</td><td class="p-3 text-right">Rp ${formatNumber(h.cost)}</td></tr>`;
                }).join('');

            } catch (e) { console.error("Dash Error", e); }
        };

        function renderChart(canvas, labels, dataBar, dataLine, stateKey) {
            const ctx = canvas.getContext('2d');
            if (state[stateKey]) state[stateKey].destroy();
            state[stateKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Total Paket', data: dataBar, backgroundColor: '#3b82f6', order: 2, yAxisID: 'y' },
                        { type: 'line', label: 'Produktivitas', data: dataLine, borderColor: '#22c55e', borderWidth: 2, tension: 0.3, pointRadius: 3, order: 1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, y1: { display: false, position: 'right', grid: { drawOnChartArea: false } }, x: { grid: { display: false } } }
                }
            });
        }

        window.handleLogout = async () => { localStorage.removeItem('userRole'); localStorage.removeItem('userData'); window.location.reload(); };

        // --- REPORTS LOGIC ---
        document.querySelectorAll('.metric-input').forEach(input => { input.addEventListener('input', calculateReportTotals); });
        function setupHubListener() {
            const hubSelect = document.getElementById('rpt-hub-select');
            if (hubSelect) hubSelect.addEventListener('change', () => loadReportsView());
        }

        function calculateReportTotals() {
            const g = Number(els.rptGateway.value) || 0; const s = Number(els.rptStaging.value) || 0;
            const sa = Number(els.rptSap.value) || 0; const j = Number(els.rptJne.value) || 0;
            const totalPaket = g+s+sa+j; els.rptTotalPaket.value = formatNumber(totalPaket);
            let workingCount = 0; let sorterDwCount = 0;
            document.querySelectorAll('#sorter-attendance-list tr').forEach(row => {
                const checked = row.querySelector('.attendance-radio:checked');
                if(checked && ['s1','s2','s3'].includes(checked.value)) {
                    const role = row.querySelector('.text-slate-400')?.textContent.toLowerCase() || '';
                    if(!role.includes('leader')) { workingCount++; sorterDwCount++; }
                }
            });
            els.displayTotalMpp.textContent = workingCount;
            const prod = sorterDwCount > 0 ? Math.round(totalPaket / sorterDwCount) : 0;
            els.rptProductivity.value = formatNumber(prod);
        }
        window.calculateReportTotals = calculateReportTotals;

        window.addDwRow = () => {
            const uid = 'dw_' + Date.now();
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-50 hover:bg-slate-50';
            row.innerHTML = `<td class="p-3"><input type="text" class="w-full p-1 border border-slate-300 rounded text-sm dw-name-input" placeholder="Nama DW..." data-id="${uid}"></td>${generateAttendanceColumns(uid)}<td class="p-3 text-center"><button type="button" onclick="this.closest('tr').remove(); calculateReportTotals()" class="text-red-400 hover:text-red-600"><i data-lucide="x-circle" class="w-4 h-4"></i></button></td>`;
            els.sorterAttendanceList.appendChild(row); lucide.createIcons();
        }

        function generateAttendanceColumns(rowId) {
            return `<td class="p-3 text-center bg-blue-50/30"><input type="radio" name="att_${rowId}" value="s1" class="attendance-radio custom-radio accent-blue-600" onclick="calculateReportTotals()"></td>
                <td class="p-3 text-center bg-blue-50/30"><input type="radio" name="att_${rowId}" value="s2" class="attendance-radio custom-radio accent-blue-600" onclick="calculateReportTotals()"></td>
                <td class="p-3 text-center bg-blue-50/30"><input type="radio" name="att_${rowId}" value="s3" class="attendance-radio custom-radio accent-blue-600" onclick="calculateReportTotals()"></td>
                <td class="p-3 text-center bg-yellow-50/30"><input type="radio" name="att_${rowId}" value="i" class="attendance-radio custom-radio accent-yellow-500" onclick="calculateReportTotals()"></td>
                <td class="p-3 text-center bg-red-50/30"><input type="radio" name="att_${rowId}" value="s" class="attendance-radio custom-radio accent-red-500" onclick="calculateReportTotals()"></td>
                <td class="p-3 text-center bg-red-100/30"><input type="radio" name="att_${rowId}" value="a" class="attendance-radio custom-radio accent-red-800" onclick="calculateReportTotals()"></td>
                <td class="p-3"><input type="text" class="w-full p-1 border border-slate-200 rounded text-xs att-remarks" placeholder="..."></td>`;
        }

        async function loadReportsView() {
            if(els.editReportId.value) return; 
            els.rptDate.valueAsDate = new Date();
            
            let currentHubCode = '';
            if (state.hubs.length === 0) {
                const hubsSnap = await getDocs(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'));
                state.hubs = hubsSnap.docs.map(doc => doc.data());
            }

            // ADMIN INPUT FIX: Only create select if not exists or if we need to refresh options
            if (state.role === 'admin') {
                const existingSelect = document.getElementById('rpt-hub-select');
                if (!existingSelect) {
                    let options = `<option value="">Pilih HUB...</option>` + 
                        state.hubs.map(h => `<option value="${h.code}">${h.name} (${h.code})</option>`).join('');
                    els.rptHubContainer.innerHTML = `<select id="rpt-hub-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-blue-500 focus:border-blue-500 outline-none">${options}</select>`;
                    setupHubListener();
                } 
                // If exists, keep current value
            } else {
                currentHubCode = state.userData?.hub_code || 'UNKNOWN';
                els.rptHubContainer.innerHTML = `<input type="text" id="rpt-hub-static" value="${currentHubCode}" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-slate-200 text-slate-600 font-bold" readonly>`;
            }

            const getSelectedHub = () => state.role === 'admin' ? (document.getElementById('rpt-hub-select')?.value || '') : currentHubCode;
            const hubCode = getSelectedHub();
            
            // Only load employees if we have a valid hub code selected
            if (state.role !== 'sorter' && (hubCode || state.role !== 'admin')) {
                loadEmployeesForReport(hubCode);
            } else if (state.role === 'admin' && !hubCode) {
                 els.sorterAttendanceList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-400">Silakan pilih HUB untuk memuat karyawan.</td></tr>';
            }

            loadMyReports(); calculateReportTotals();
        }

        async function loadEmployeesForReport(hubCode) {
            if (!hubCode) return;
            els.sorterAttendanceList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-400">Memuat karyawan...</td></tr>';
            try {
                const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
                let qSorter = query(usersRef, where("hub_code", "==", hubCode));
                const snap = await getDocs(qSorter);
                els.sorterAttendanceList.innerHTML = '';
                snap.forEach(doc => {
                    const s = doc.data();
                    if(s.role === 'admin') return;
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-50 hover:bg-slate-50';
                    row.innerHTML = `<td class="p-3 font-medium text-slate-700" data-name="${s.name}" data-is-db="true">${s.name} <span class="text-xs text-slate-400">(${s.role})</span></td>${generateAttendanceColumns(doc.id)}<td class="p-3"></td>`;
                    els.sorterAttendanceList.appendChild(row);
                });
            } catch (e) { els.sorterAttendanceList.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-red-400">Gagal memuat.</td></tr>'; }
        }
        
        window.loadMyReports = async () => {
            els.rptHistoryBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">Memuat data...</td></tr>';
            try {
                const reportsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports');
                let q = query(reportsRef, orderBy("date", "desc"), limit(20));
                let querySnapshot;
                try { querySnapshot = await getDocs(q); } catch(err) { const q2 = query(reportsRef, limit(20)); querySnapshot = await getDocs(q2); }

                if (querySnapshot.empty) { els.rptHistoryBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">Belum ada laporan.</td></tr>'; return; }

                els.rptHistoryBody.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 border-b border-slate-100 last:border-0';
                    let btns = '';
                    if (state.role === 'admin' || (state.role === 'leader' && state.userData.hub_code === d.hub)) {
                        btns = `<button onclick='confirmEditReport(${JSON.stringify({id: doc.id, ...d})})' class="text-blue-500 hover:bg-blue-50 p-1 rounded" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick='confirmDeleteReport("${doc.id}", "${d.hub}")' class="text-red-500 hover:bg-red-50 p-1 rounded" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    }
                    tr.innerHTML = `<td class="p-3 whitespace-nowrap">${d.date}</td><td class="p-3 font-medium">${d.hub}</td><td class="p-3 text-right text-blue-600 font-mono">${formatNumber(d.total_paket || 0)}</td><td class="p-3 text-right font-mono font-bold">${d.total_mpp || 0}</td><td class="p-3 text-right text-purple-600 font-mono text-xs font-bold">${formatNumber(d.productivity || 0)}</td><td class="p-3 text-right text-green-600 font-mono text-xs">Rp ${formatNumber(d.est_cost || 0)}</td><td class="p-3 text-right flex gap-2 justify-end">${btns}</td>`;
                    els.rptHistoryBody.appendChild(tr);
                });
                lucide.createIcons();
            } catch (err) { els.rptHistoryBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-400">Error load data.</td></tr>'; }
        };

        window.confirmDeleteReport = (id, hub) => {
            secureCheck(async () => {
                if(state.role !== 'admin' && hub !== state.userData.hub_code) { alert("Akses Ditolak."); return; }
                if(!confirm('Hapus laporan ini?')) return;
                try { await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports', id)); loadMyReports(); } catch(e) { alert('Gagal hapus'); }
            });
        };

        window.confirmEditReport = (rpt) => {
            secureCheck(() => {
                if(state.role !== 'admin' && rpt.hub !== state.userData.hub_code) { alert("Akses Ditolak."); return; }
                els.editReportId.value = rpt.id; els.rptDate.value = rpt.date; 
                
                if (state.role === 'admin') {
                    const select = document.getElementById('rpt-hub-select');
                    if(select) { select.value = rpt.hub; loadEmployeesForReport(rpt.hub).then(() => { restoreAttendanceData(rpt); }); }
                } else {
                    document.getElementById('rpt-hub-static').value = rpt.hub; restoreAttendanceData(rpt);
                }

                els.rptGateway.value = rpt.gateway; els.rptStaging.value = rpt.staging; els.rptSap.value = rpt.sap; els.rptJne.value = rpt.jne;
                els.formReportTitle.textContent = "Edit Laporan"; els.btnSaveReport.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Update Laporan';
                els.btnCancelReportEdit.classList.remove('hidden');
                els.formDailyReport.scrollIntoView({ behavior: 'smooth' });
            });
        };

        function restoreAttendanceData(rpt) {
             document.querySelectorAll('.attendance-radio').forEach(r => r.checked = false);
             document.querySelectorAll('.att-remarks').forEach(i => i.value = '');
             if(rpt.attendance_data) {
                rpt.attendance_data.forEach(att => {
                    const nameCell = Array.from(document.querySelectorAll('td[data-name]')).find(td => td.dataset.name === att.name);
                    let row;
                    if(nameCell) row = nameCell.closest('tr');
                    else { addDwRow(); row = els.sorterAttendanceList.lastElementChild; row.querySelector('.dw-name-input').value = att.name; }
                    if(row) {
                        const radio = row.querySelector(`input[value="${att.status}"]`); if(radio) radio.checked = true;
                        const remarkInput = row.querySelector('.att-remarks'); if(remarkInput) remarkInput.value = att.remarks || '';
                    }
                });
            }
            calculateReportTotals();
        }

        window.resetReportForm = () => {
            els.formDailyReport.reset(); els.editReportId.value = ''; els.formReportTitle.textContent = "Input Laporan Operasional";
            els.btnSaveReport.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> Simpan Laporan'; els.btnCancelReportEdit.classList.add('hidden');
            els.rptHub.value = state.userData?.hub_code || ''; loadReportsView();
        };

        els.formDailyReport.addEventListener('submit', async (e) => {
            e.preventDefault(); els.btnSaveReport.disabled = true; els.btnSaveReport.textContent = 'Menyimpan...'; els.rptMsg.classList.add('hidden');
            try {
                let selectedHub = state.role === 'admin' ? document.getElementById('rpt-hub-select').value : document.getElementById('rpt-hub-static').value;
                if(!selectedHub && state.role === 'admin') throw new Error("Pilih HUB.");

                let sorterRate = 0; const hubData = state.hubs.find(h => h.code === selectedHub);
                if(hubData) sorterRate = Number(hubData.sorter_rate) || 0;
                const dwRate = Number(state.config.dw_rate) || 0;

                const att = []; let sCnt = 0; let dCnt = 0; let wCnt = 0;
                els.sorterAttendanceList.querySelectorAll('tr').forEach(row => {
                    const chk = row.querySelector('.attendance-radio:checked');
                    if(chk) {
                        const isDb = row.querySelector('td[data-is-db="true"]');
                        let name = isDb ? isDb.dataset.name : row.querySelector('.dw-name-input')?.value || 'Unknown';
                        const status = chk.value;
                        att.push({ name: name, status: status, remarks: row.querySelector('.att-remarks').value });
                        
                        if(['s1','s2','s3'].includes(status)) {
                            const role = row.querySelector('.text-slate-400')?.textContent.toLowerCase() || '';
                            if(!role.includes('leader')) {
                                wCnt++;
                                if(isDb) sCnt++; else dCnt++;
                            }
                        }
                    }
                });

                const g = Number(els.rptGateway.value)||0; const s = Number(els.rptStaging.value)||0;
                const sa = Number(els.rptSap.value)||0; const j = Number(els.rptJne.value)||0;
                const totalPaket = g+s+sa+j;
                const estCost = (sCnt * sorterRate) + (dCnt * dwRate);
                const productivity = wCnt > 0 ? Math.round(totalPaket / wCnt) : 0;

                const rData = {
                    date: els.rptDate.value, hub: selectedHub, nik: state.userData?.nik || 'UNKNOWN',
                    reporter_name: state.userData?.name || 'UNKNOWN', gateway: g, staging: s, sap: sa, jne: j, total_paket: totalPaket,
                    total_mpp: wCnt, productivity: productivity, attendance_data: att, est_cost: estCost, created_at: new Date().toISOString()
                };

                if(els.editReportId.value) { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports', els.editReportId.value), rData); els.rptMsg.textContent = "Diupdate!"; } 
                else { await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'daily_reports'), rData); els.rptMsg.textContent = "Disimpan!"; }
                
                els.rptMsg.className = "text-sm text-green-600 font-medium animate-pulse"; els.rptMsg.classList.remove('hidden');
                resetReportForm(); loadMyReports();
            } catch (err) { els.rptMsg.textContent = "Gagal: " + err.message; els.rptMsg.className = "text-sm text-red-600 font-medium"; els.rptMsg.classList.remove('hidden'); } 
            finally { els.btnSaveReport.disabled = false; if(!els.editReportId.value) els.btnSaveReport.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Simpan Laporan'; lucide.createIcons(); }
        });

        // --- SETTINGS LOGIC ---
        let unsubscribeHubs = null; let unsubscribeEmployees = null;
        window.switchSettingsTab = (tabName) => {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            ['hubs', 'employees', 'config'].forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                if (t === tabName) { btn.classList.remove('tab-inactive'); btn.classList.add('tab-active'); } 
                else { btn.classList.add('tab-inactive'); btn.classList.remove('tab-active'); }
            });
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        }

        function loadSettings() {
            if (!unsubscribeHubs) { unsubscribeHubs = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), (snap) => { state.hubs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderHubsTable(); populateHubDropdowns(); }); }
            if (!unsubscribeEmployees) { unsubscribeEmployees = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), (snap) => { state.employees = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(u => u.role !== 'admin'); renderEmployeesTable(); }); }
            if(state.config) { els.configSecureCode.value = state.config.secure_code || ''; els.configDwRate.value = state.config.dw_rate || 0; }
        }

        function populateHubDropdowns() {
            const options = `<option value="">Pilih HUB...</option>` + state.hubs.map(h => `<option value="${h.code}">${h.name} (${h.code})</option>`).join('');
            if(els.userHub) els.userHub.innerHTML = options;
        }

        els.formAddHub.addEventListener('submit', async (e) => {
            e.preventDefault(); const id = els.editHubId.value;
            const data = { code: els.hubCode.value.toUpperCase().trim(), name: els.hubName.value.trim(), sorter_rate: Number(els.hubRate.value) || 0, created_at: new Date().toISOString() };
            secureCheck(async () => {
                try { if (id) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'hubs', id), data); else { if(state.hubs.find(h => h.code === data.code)) throw new Error("Kode sudah ada!"); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'hubs'), data); } resetHubForm(); showStatusMsg(els.hubMsg, "Berhasil!", "success"); } catch(err) { showStatusMsg(els.hubMsg, err.message, "error"); }
            });
        });

        window.editHub = (h) => { if(typeof h === 'string') h = JSON.parse(h); secureCheck(() => { els.editHubId.value = h.id; els.hubCode.value = h.code; els.hubName.value = h.name; els.hubRate.value = h.sorter_rate || 0; els.btnSaveHub.textContent = 'Update'; els.btnCancelHub.classList.remove('hidden'); els.formAddHub.scrollIntoView({ behavior: 'smooth' }); }); }
        window.resetHubForm = () => { els.formAddHub.reset(); els.editHubId.value = ''; els.btnSaveHub.textContent = 'Simpan'; els.btnCancelHub.classList.add('hidden'); }
        function renderHubsTable() { els.hubTableBody.innerHTML = state.hubs.map(hub => `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-4 font-mono font-bold text-slate-700">${hub.code}</td><td class="p-4 font-medium">${hub.name}</td><td class="p-4 text-right">Rp ${formatNumber(hub.sorter_rate||0)}</td><td class="p-4 text-right"><button onclick='editHub(${JSON.stringify(hub)})' class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteDocItem('hubs', '${hub.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join(''); lucide.createIcons(); }

        els.formAddUser.addEventListener('submit', async (e) => {
            e.preventDefault(); const id = els.editUserId.value;
            const data = { nik: els.userNik.value.trim(), name: els.userName.value.trim(), hub_code: els.userHub.value, role: els.userRole.value, can_login: els.userCanLogin.checked, password: els.userPass.value.trim(), created_at: new Date().toISOString() };
            secureCheck(async () => {
                try { if (id) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', id), data); else { if(state.employees.find(e => e.nik === data.nik)) throw new Error("NIK Terdaftar!"); await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), data); } resetUserForm(); showStatusMsg(els.userMsg, 'Berhasil!', 'success'); } catch(err) { showStatusMsg(els.userMsg, err.message, 'error'); }
            });
        });

        window.togglePasswordInput = () => { if(els.userCanLogin.checked) { els.passContainer.classList.remove('hidden'); els.userPass.required = true; } else { els.passContainer.classList.add('hidden'); els.userPass.required = false; els.userPass.value = ''; } }
        window.resetUserForm = () => { els.formAddUser.reset(); els.editUserId.value = ''; els.formUserTitle.textContent = 'Tambah Data Karyawan'; els.btnSaveUser.textContent = 'Simpan Data'; els.btnCancelEdit.classList.add('hidden'); els.userNik.disabled = false; togglePasswordInput(); }
        function renderEmployeesTable() { els.userCount.textContent = `Total: ${state.employees.length}`; els.userTableBody.innerHTML = state.employees.map(u => `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0"><td class="p-4"><div class="font-medium text-slate-800">${u.name}</div><div class="text-xs text-slate-500 font-mono">${u.nik}</div></td><td class="p-4"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">${u.hub_code || '-'}</span></td><td class="p-4 capitalize text-slate-600">${u.role}</td><td class="p-4 font-mono text-slate-500 text-xs">${u.can_login ? u.password : '-'}</td><td class="p-4">${u.can_login ? '<span class="text-green-600 text-xs font-bold bg-green-100 px-2 py-1 rounded-full">Aktif</span>' : '<span class="text-slate-400 text-xs bg-slate-100 px-2 py-1 rounded-full">Tidak</span>'}</td><td class="p-4 text-right flex gap-2 justify-end"><button onclick='editUser(${JSON.stringify(u)})' class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="deleteDocItem('users', '${u.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join(''); lucide.createIcons(); }
        window.editUser = (u) => { if(typeof u === 'string') u = JSON.parse(u); secureCheck(() => { els.editUserId.value = u.id; els.userNik.value = u.nik; els.userNik.disabled = true; els.userName.value = u.name; els.userHub.value = u.hub_code; els.userRole.value = u.role; els.userCanLogin.checked = u.can_login; els.userPass.value = u.password || ''; togglePasswordInput(); els.formUserTitle.textContent = 'Edit Data Karyawan'; els.btnSaveUser.textContent = 'Update Data'; els.btnCancelEdit.classList.remove('hidden'); els.formAddUser.scrollIntoView({ behavior: 'smooth' }); }); }
        window.deleteDocItem = async (colName, id) => { secureCheck(async () => { if(!confirm('Hapus data ini?')) return; try { await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', colName, id)); } catch(e) { alert('Gagal hapus'); } }); };
        function showStatusMsg(el, text, type) { el.textContent = text; el.className = `text-xs mt-3 ${type === 'error' ? 'text-red-500' : 'text-green-600'}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000); }
        els.openSidebarBtn.addEventListener('click', () => { els.sidebar.classList.remove('-translate-x-full'); els.sidebarOverlay.classList.remove('hidden'); });
        els.closeSidebarBtn.addEventListener('click', () => { els.sidebar.classList.add('-translate-x-full'); els.sidebarOverlay.classList.add('hidden'); });
        els.sidebarOverlay.addEventListener('click', () => { els.sidebar.classList.add('-translate-x-full'); els.sidebarOverlay.classList.add('hidden'); });

        init();
    </script>
</body>
</html>